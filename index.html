<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>AgoraWeather NZ Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    html, body { background: #181e2a; color: #fff; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif;}
    #main { max-width: 500px; margin: 0 auto; padding: 0 2px 32px 2px; }
    .block { background: #222c40; border-radius: 13px; padding: 13px 9px 15px 13px; margin: 18px 0 24px 0; box-shadow: 0 2px 14px #0007;}
    #loc { font-size: 1.13rem; font-weight: 600; margin-bottom: 4px; letter-spacing: 0.01em; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 14px;}
    .temp { font-size: 2.7rem; font-weight: bold; letter-spacing: -0.03em;}
    .icon { width: 58px; height: 58px;}
    .details { font-size: 1.03rem; color: #c8daf7; margin: 10px 0 4px 0; display: flex; flex-wrap: wrap; gap: 12px 18px;}
    .details span { min-width: 44%; }
    .advice-list { margin: 10px 0 0 0;}
    .advice-tip { background: #253e62; color: #ffd25a; border-radius: 7px; font-size: 1.07rem; margin-bottom: 8px; padding: 8px 13px; font-weight: 500; box-shadow: 0 1px 8px #0002; line-height: 1.32; text-align: left;}
    .tabs { display: flex; margin-bottom: 7px;}
    .tab-btn { flex: 1; padding: 9px 0; background: #181e2a; color: #ffe180; border: none; border-radius: 6px 6px 0 0; font-size: 1.08rem; font-weight:600; margin-right:2px; cursor: pointer;}
    .tab-btn.active { background: #ffe180; color: #222c40;}
    #forecast-cards { display: flex; flex-direction: column; gap: 8px; }
    .forecast-card { background: #232f47; border-radius: 9px; padding: 11px 6px 11px 14px; display: flex; align-items: center; gap: 11px; font-size: 1rem; box-shadow: 0 1px 4px #0002; cursor: pointer; }
    .forecast-card .day { font-weight: 600; width: 55px; color: #fff; }
    .forecast-card .ficon { width: 36px; height: 36px; }
    .forecast-card .info { flex: 1 1 0; font-size: 1rem; color: #dde5f3; line-height: 1.25; }
    #rain-block { display:none; }
    #rain-title { font-size: 1.07rem; font-weight: 600; color: #85e7ff; margin-bottom: 8px;}
    #rainChart { width: 100%; min-height: 110px; max-width: 490px; margin-bottom:10px;}
    .rain-summary, .rain-extra { font-size: 0.96rem; color: #ffe180; margin-top: 7px;}
    .rain-extra { color: #aad7ff; }
    .rain-table { width:100%; margin-top:10px; border-spacing:0;}
    .rain-table th, .rain-table td { font-size:0.95rem; padding:2px 6px;}
    .rain-table th { color:#85e7ff; text-align:left;}
    .rain-table td { color:#dde5f3;}
    .wettest { color:#8ae995; font-weight:600;}
    .driest { color:#fddbdb; font-weight:600;}
    /* Popup for day details + hourly */
    #popup-bg { position: fixed; z-index: 9999; top:0;left:0;right:0;bottom:0; background: rgba(10,18,36,0.95); display:none; align-items: center; justify-content: center;}
    #popup { background: #222c40; border-radius: 17px; padding: 22px 15px; color: #fff; max-width: 380px; width:95vw; box-shadow: 0 8px 36px #000c; position: relative;}
    #popup .close { position: absolute; top:7px; right: 15px; font-size: 2rem; color: #aad7ff; cursor:pointer; background:none; border:none;}
    #popup .pday { font-size:1.11rem;font-weight:bold;margin-bottom:4px;}
    #popup .pdesc { font-size:1.01rem; color:#ffe180;margin-bottom:7px;}
    #popup .advice-tip {margin:7px 0;}
    .hourly-vert {margin-top:15px; max-height:400px; overflow-y:auto;}
    .hour-block {background:#181e2a;border-radius:7px;padding:9px 7px;margin-bottom:7px;display:flex;align-items:center;gap:12px;}
    .hinfo {flex:1 1 0;}
    .htime {font-size:1.06rem;color:#ffe180;font-weight:600;}
    .hicon { width:32px; height:32px;}
    .htemp { font-size:1.08rem; font-weight:600;}
    .hrow { font-size:0.98rem; color:#dde5f3; }
    .hrow span { margin-right:7px;}
    @media (max-width:600px){
      #main {padding:0 1px;}
      .block {padding:10px 3px 12px 7px;}
      .forecast-card .day { width:38px;}
      #popup {padding: 13px 2px;}
    }
  </style>
</head>
<body>
<div id="main">
  <div class="block" id="current">
    <div id="loc">Loading location…</div>
    <div class="row">
      <span class="temp" id="temp">--°C</span>
      <img id="icon" class="icon" src="" alt="" />
    </div>
    <div class="details" id="details"></div>
    <div class="advice-list" id="advice-list"></div>
  </div>
  <div class="block">
    <div class="tabs">
      <button class="tab-btn active" id="forecastTab" onclick="showTab('forecast')">Forecast</button>
      <button class="tab-btn" id="rainTab" onclick="showTab('rain')">Rain History</button>
    </div>
    <div id="forecast-cards"></div>
    <div id="rain-block">
      <div id="rain-title">Rainfall History (mm)</div>
      <canvas id="rainChart"></canvas>
      <div class="rain-summary" id="rain-summary"></div>
      <div class="rain-extra" id="rain-extra"></div>
      <table class="rain-table" id="rain-table"></table>
    </div>
  </div>
</div>
<div id="popup-bg"><div id="popup"></div></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const weatherIcons = icon => icon ? `https://cdn.aerisapi.com/wxblox/icons/${icon}` : '';
const dayOfWeek = d => new Date(d).toLocaleDateString('en-NZ', {weekday:'short'});
const cap = s => (s||'').charAt(0).toUpperCase()+(s||'').slice(1);

function aiAdvice(d){
  let out = [], a = [];
  if(!d.weather) return ["No advice available"];
  let m = d.month, r = (d.region||'').toLowerCase();
  if(d.precip >= 25) a.push("Very heavy rain – check for flooding and avoid low-lying roads.");
  else if(d.precip >= 10) a.push("Bring waterproofs – outdoor plans could get soggy.");
  if(d.gust >= 65) a.push("Damaging wind gusts. Bring in bins & check trampolines!");
  if(d.uv>=7) a.push("High UV – sunburn in 15 minutes, slip/slop/slap.");
  if(d.temp >= 30) a.push("Extreme heat! Stay cool & hydrate often.");
  if(d.temp <= 0) a.push("Freezing temps – risk of black ice in the morning.");
  if(d.feelslike-d.temp>=3) a.push("Feels much colder than the temperature – dress for the windchill.");
  if(Math.abs(d.pressChange)>=5) a.push("Rapid pressure drop – expect wind and rain shifts.");
  if(d.vis<=1) a.push("Low visibility: drive with lights on & slow down.");
  if(/thunder/.test(d.weather.toLowerCase())) a.push("Thunderstorms: stay indoors if you hear thunder.");
  if(m==6||m==7||m==8) a.push("Winter: Layer up, heating on, and be cautious of black ice.");
  if(m==12||m==1||m==2) a.push("Summer: Protect yourself from UV, hydrate well, check for water restrictions.");
  if(r.includes("auckland") && d.precip>10) a.push("Auckland tip: Check for surface flooding on motorways during heavy rain.");
  if(r.includes("canterbury") && d.wind>30) a.push("Canterbury Nor’wester: Secure trampolines and light outdoor gear.");
  if(d.temp>28 && d.humidity>65) a.push("Heatwave? Remember pets need shade and water too.");
  if(d.precip < 1 && d.uv >= 5 && d.wind < 20) a.push("Great weather for outdoor sport, beach or picnic.");
  if(d.precip < 1 && d.wind < 10) a.push("Calm and clear – perfect for morning fishing.");
  if(d.gust>35 && d.gust<60) a.push("Windy: sailing, windsurf, and kite sports will be fun – check forecasts before heading out.");
  let tips = [
    "Weather can change quickly – check again before leaving home.",
    "Check Waka Kotahi for road updates in wild weather.",
    "Sun’s up early this week – take advantage for morning walks.",
    "If heading to the beach, check for rips and always swim between the flags.",
    "Check on neighbours if severe weather is forecast.",
    "Storms or power cuts? Keep torches and batteries handy.",
    "On hot days, park in the shade and use window shades in the car.",
    "Windy in Wellington? Mind the umbrella – and hold your hat!"
  ];
  let offset = new Date().getDate() % tips.length;
  a.push(tips[offset]);
  out = [...new Set(a)].filter(Boolean).slice(0,3);
  return out;
}

// Ask for geolocation once, fallback to :auto if denied
async function getLocation() {
  return new Promise(resolve => {
    const saved = localStorage.getItem('agoraWeatherCoords');
    if (saved) {
      try {
        let o = JSON.parse(saved);
        if(o && o.lat && o.lon) return resolve(o);
      } catch(e){}
    }
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        let o = {lat:pos.coords.latitude, lon:pos.coords.longitude};
        localStorage.setItem('agoraWeatherCoords',JSON.stringify(o));
        resolve(o);
      },()=>{resolve(null);},{timeout:7000});
    } else { resolve(null); }
  });
}

function showTab(tab){
  document.getElementById('forecast-cards').style.display = tab=="forecast"?"flex":"none";
  document.getElementById('rain-block').style.display = tab=="rain"?"block":"none";
  document.getElementById('forecastTab').classList.toggle('active', tab=="forecast");
  document.getElementById('rainTab').classList.toggle('active', tab=="rain");
}

// Vertical hourly
function openPopup(day, allPeriods){
  let dayNum = null;
  for (let p of allPeriods) { 
    let d = new Date(p.dateTimeISO); 
    if(dayOfWeek(p.dateTimeISO) === day) { dayNum = d.getDay(); break;}
  }
  let hPeriods = allPeriods.filter(p2=>new Date(p2.dateTimeISO).getDay()===dayNum);
  let p = hPeriods[0] || {};
  let advice = aiAdvice({
    ...p, month: (new Date(p.dateTimeISO)).getMonth()+1, feelslike: p.feelslikeC||p.tempC, region:p.region||"", weather:p.weather
  });
  let html = `<button class="close" onclick="closePopup()">&times;</button>
    <div class="pday">${dayOfWeek(p.dateTimeISO)}</div>
    <div class="pdesc">${cap(p.summary||p.weather||"")}</div>
    ${advice.map(t=>`<div class="advice-tip">${t}</div>`).join('')}
    <div class="hourly-vert">` +
      hPeriods.map(h=>
        `<div class="hour-block">
          <div class="htime">${("0"+new Date(h.dateTimeISO).getHours()).slice(-2)}:00</div>
          <img class="hicon" src="${weatherIcons(h.icon)}" alt=""/>
          <div class="hinfo">
            <div class="htemp">${Math.round(h.tempC||h.maxTempC||0)}°C</div>
            <div class="hrow">
              <span>${cap(h.weather||'')}</span>
              <span>Wind ${h.windDir||''} ${Math.round(h.windSpeedKPH||0)}km/h</span>
              <span>Gusts ${Math.round(h.windGustKPH||0)}km/h</span>
              <span>Rain ${h.precipMM||0}mm</span>
            </div>
          </div>
        </div>`
      ).join('') +
    `</div>`;
  document.getElementById('popup').innerHTML = html;
  document.getElementById('popup-bg').style.display = "flex";
}
function closePopup(){document.getElementById('popup-bg').style.display="none";}

// --- Main
(async function(){
  // Location first
  let coords = await getLocation();
  let locQuery = coords ? `&location=${coords.lat},${coords.lon}` : '';
  // Fetch current
  let curUrl = coords
    ? `https://data.api.xweather.com/conditions/${coords.lat},${coords.lon}?format=json&plimit=1&filter=1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,periods.weather,periods.icon,periods.feelslikeC,periods.precipMM,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq`
    : `https://data.api.xweather.com/conditions/:auto?format=json&plimit=1&filter=1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,periods.weather,periods.icon,periods.feelslikeC,periods.precipMM,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq`;

  let cur = await fetch(curUrl).then(r=>r.json());
  let p = cur.success ? cur.response[0].periods[0] : {};
  let region = cur.success && cur.response[0].loc ? (cur.response[0].loc.city||cur.response[0].loc.region||"Your Area") : "Your Area";
  document.getElementById('loc').textContent = region;
  document.getElementById('temp').textContent = p.tempC!=null?Math.round(p.tempC)+'°C':'--°C';
  document.getElementById('icon').src = weatherIcons(p.icon);
  document.getElementById('icon').alt = p.weather || "";
  document.getElementById('details').innerHTML =
    `<span>Feels: ${p.feelslikeC!=null?Math.round(p.feelslikeC)+'°C':'--°C'}</span>
    <span>Humidity: ${p.humidity!=null?p.humidity+'%':'--%'}</span>
    <span>Wind: ${p.windSpeedKPH!=null?(p.windDir||'')+' '+Math.round(p.windSpeedKPH)+' km/h':'--'}</span>
    <span>Gusts: ${p.windGustKPH!=null?Math.round(p.windGustKPH)+' km/h':'--'}</span>
    <span>Pressure: ${p.pressureMB!=null?Math.round(p.pressureMB)+' hPa':'--'}</span>
    <span>Dew Pt: ${p.dewpointC!=null?Math.round(p.dewpointC)+'°C':'--'}</span>
    <span>Visibility: ${p.visibilityKM!=null?Math.round(p.visibilityKM)+' km':'--'}</span>
    <span>Cloud: ${p.cloudsCoded?parseInt(p.cloudsCoded.replace(/[^0-9]/g,''))+'%':'--'}</span>
    <span>UV: ${p.uvIndex!=null?p.uvIndex:'--'}</span>
    <span>Sunrise: ${p.sunriseISO?new Date(p.sunriseISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):'--'}</span>
    <span>Sunset: ${p.sunsetISO?new Date(p.sunsetISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):'--'}</span>`;
  let dObj = {...p, month:(new Date(p.dateTimeISO||Date.now())).getMonth()+1, feelslike:p.feelslikeC||p.tempC, region:region};
  let advices = aiAdvice(dObj);
  document.getElementById('advice-list').innerHTML = advices.map(t=>`<div class="advice-tip">${t}</div>`).join('');

  // Forecast
  let fcUrl = coords
    ? `https://data.api.xweather.com/forecasts/${coords.lat},${coords.lon}?format=json&plimit=48&fields=periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.dewpointC,periods.summary,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.sunriseISO,periods.sunsetISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq`
    : `https://data.api.xweather.com/forecasts/:auto?format=json&plimit=48&fields=periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.dewpointC,periods.summary,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.sunriseISO,periods.sunsetISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq`;

  let fc = await fetch(fcUrl).then(r=>r.json());
  let periods = fc.success ? fc.response[0].periods : [];
  let forecastDays = periods.filter((p,i,a)=>i===0||new Date(p.dateTimeISO).getDay()!==new Date(a[i-1].dateTimeISO).getDay());
  let fcDom = document.getElementById('forecast-cards'); fcDom.innerHTML = "";
  forecastDays.slice(1,8).forEach(p2 => {
    let card = document.createElement('div'); card.className='forecast-card';
    card.onclick = ()=>openPopup(dayOfWeek(p2.dateTimeISO),periods);
    card.innerHTML = `<div class="day">${dayOfWeek(p2.dateTimeISO)}</div>
      <img class="ficon" src="${weatherIcons(p2.icon)}" alt=""/>
      <div class="info">
        <div><b>${cap(p2.weather||'')}</b></div>
        <div>${Math.round(p2.maxTempC)}/${Math.round(p2.minTempC)}°C</div>
        <div>Wind ${p2.windDir||''} ${Math.round(p2.windSpeedKPH||0)}km/h, Gusts ${Math.round(p2.windGustKPH||0)}km/h</div>
        <div>Rain ${p2.precipMM||0}mm • Hum ${p2.humidity||'--'}%</div>
      </div>`;
    fcDom.appendChild(card);
  });

  // Rain history
  let lat = coords ? coords.lat : (cur.success && cur.response[0].loc ? cur.response[0].loc.lat : null), 
      lon = coords ? coords.lon : (cur.success && cur.response[0].loc ? cur.response[0].loc.long : null);
  let week = [], month = [], ytd = 0;
  let rainErr = false;
  if(lat && lon) {
    try {
      let rain30 = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=30&daily=precipitation_sum&timezone=auto`).then(r=>r.json());
      let rain365 = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=365&daily=precipitation_sum&timezone=auto`).then(r=>r.json());
      if(rain30.daily && rain30.daily.precipitation_sum) {
        month = rain30.daily.precipitation_sum;
        week = month.slice(-7);
      }
      if(rain365.daily && rain365.daily.precipitation_sum) {
        ytd = rain365.daily.precipitation_sum.reduce((a,b)=>a+b,0);
      }
      // Show rain in table format for clarity
      let table = `<tr><th>Date</th><th>Rain (mm)</th></tr>`;
      let days = rain30.daily && rain30.daily.time ? rain30.daily.time : [];
      for(let i=Math.max(0,days.length-14);i<days.length;++i){
        table += `<tr>
          <td>${days[i].substr(5)}</td>
          <td class="${month[i]===Math.max(...month)?'wettest':month[i]===Math.min(...month)?'driest':''}">${month[i].toFixed(1)}</td>
        </tr>`;
      }
      document.getElementById('rain-table').innerHTML = table;
    } catch(e){ rainErr=true; }
  } else { rainErr=true; }
  // Chart and summary
  if(rainErr||!week.length||!month.length){
    document.getElementById('rain-summary').textContent = "Rain data unavailable for this area.";
    document.getElementById('rain-extra').textContent = "";
    document.getElementById('rain-table').innerHTML = "";
  } else {
    document.getElementById('rain-summary').innerHTML = `Week: <b>${week.reduce((a,b)=>a+b,0).toFixed(1)} mm</b> | Month: <b>${month.reduce((a,b)=>a+b,0).toFixed(1)} mm</b> | Year-to-date: <b>${ytd.toFixed(1)} mm</b>`;
    let labels = Array.from({length:7},(_,i)=>`Day ${i+1}`);
    new Chart(document.getElementById('rainChart').getContext('2d'),{
      type:'bar',
      data:{labels,datasets:[{label:"Rain (mm)",data:week,backgroundColor:'#85e7ff'}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
    // Extra stats
    let wet = Math.max(...month), dry = Math.min(...month), dayWet = month.indexOf(wet)+1, dayDry = month.indexOf(dry)+1;
    document.getElementById('rain-extra').innerHTML = `Wettest day: <b>Day ${dayWet} (${wet.toFixed(1)} mm)</b> | Driest: <b>Day ${dayDry} (${dry.toFixed(1)} mm)</b>`;
  }
  showTab('forecast');
})();
</script>
</body>
</html>
