<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>AgoraWeather NZ Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.9/css/weather-icons.min.css">
  <style>
    body {background:#121722;color:#fff;font-family:sans-serif;padding:10px;max-width:420px;margin:0 auto;}
    .card{background:#1e2535;border-radius:10px;padding:10px;margin-bottom:8px;box-shadow:0 2px 10px rgba(0,0,0,0.4);}
    h2, h3{margin:5px 0;}
    .icon{font-size:48px;}
    .current,.forecast{display:flex;justify-content:space-between;align-items:center;}
    .forecast{flex-direction:column;}
    .forecast-card{display:flex;width:100%;justify-content:space-between;align-items:center;margin:3px 0;padding:6px;background:#283145;border-radius:6px;cursor:pointer;}
    .detail-icon{width:40px;height:40px;}
    .advice{background:#2c3b58;padding:8px;border-radius:6px;margin:8px 0;font-size:0.9rem;}
    button{background:#3a4f76;color:#fff;padding:8px;border:none;border-radius:6px;cursor:pointer;width:100%;margin-top:5px;}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;}
    .modal-content{background:#1e2535;padding:15px;border-radius:8px;width:90%;max-height:80%;overflow:auto;}
    .close{float:right;font-size:1.5rem;cursor:pointer;}
    @media(max-width:400px){body{padding:5px;}}
  </style>
</head>
<body>

<div class="card current">
  <div>
    <h2 id="location">Loading...</h2>
    <h1 id="temp">--¬∞C</h1>
    <p id="condition">--</p>
  </div>
  <i id="weather-icon" class="icon wi"></i>
</div>

<div class="card" id="details">
  <p>Feels like: <span id="feels">--¬∞C</span></p>
  <p>Humidity: <span id="humidity">--%</span></p>
  <p>Wind: <span id="wind">-- km/h</span></p>
  <p>Pressure: <span id="pressure">-- hPa</span></p>
  <p>UV: <span id="uv">--</span></p>
  <p>Sunrise: <span id="sunrise">--</span></p>
  <p>Sunset: <span id="sunset">--</span></p>
</div>

<div class="advice" id="ai-advice">Fetching safety advice...</div>

<div class="card forecast" id="forecast-cards">
  Loading forecast...
</div>

<button onclick="showRain()">üåßÔ∏è Rainfall History</button>

<!-- Rain Modal -->
<div id="rain-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('rain-modal')">&times;</span>
    <h3>Rainfall History (past 7 days)</h3>
    <canvas id="rainChart"></canvas>
  </div>
</div>

<!-- Hourly Modal -->
<div id="hourly-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('hourly-modal')">&times;</span>
    <h3 id="hourly-title">Hourly Forecast</h3>
    <div id="hourly-content">Loading...</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const apiUrl='https://data.api.xweather.com',id='U8feQfLlcEfcXDfsWZs4C',secret='HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';
let lat,lon;

// Icons mapping
const icons={"Clear":"wi-day-sunny","Cloudy":"wi-cloudy","Rain":"wi-rain","Showers":"wi-showers","Snow":"wi-snow","Storm":"wi-thunderstorm","Fog":"wi-fog","Wind":"wi-strong-wind"};

// Get user location
navigator.geolocation.getCurrentPosition(p=>{lat=p.coords.latitude;lon=p.coords.longitude;fetchAll();},()=>{lat=-41.2865;lon=174.7762;fetchAll();});

async function fetchAll(){
  const cur=await fetchJson(`${apiUrl}/conditions/${lat},${lon}?client_id=${id}&client_secret=${secret}`);
  const fc=await fetchJson(`${apiUrl}/forecasts/${lat},${lon}?filter=day&limit=7&client_id=${id}&client_secret=${secret}`);
  const rain=await fetchJson(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=7&daily=precipitation_sum`);

  showCurrent(cur.response[0]);
  showForecast(fc.response[0]);
  showAdvice(cur.response[0]);
  setupRainChart(rain.daily.precipitation_sum);
}

function showCurrent(d){
  const p=d.periods[0];
  document.getElementById('location').textContent=d.loc.city||"Your Location";
  document.getElementById('temp').textContent=Math.round(p.tempC)+'¬∞C';
  document.getElementById('condition').textContent=p.weather;
  document.getElementById('weather-icon').className=`icon wi ${icons[p.weather]||'wi-na'}`;
  ['feels','humidity','wind','pressure','uv','sunrise','sunset'].forEach(k=>document.getElementById(k).textContent=p[k+'C']||p[k]||'--');
}

function showForecast(d){
  let html="";
  d.periods.forEach(p=>{
    html+=`<div class="forecast-card" onclick="showHourly('${p.dateTimeISO}')">
      <span>${new Date(p.dateTimeISO).toLocaleDateString('en-NZ',{weekday:'short'})}</span>
      <i class="wi ${icons[p.weather]||'wi-na'} detail-icon"></i>
      <span>${p.weather}, ${Math.round(p.maxTempC)}/${Math.round(p.minTempC)}¬∞C</span>
    </div>`;
  });
  document.getElementById('forecast-cards').innerHTML=html;
}

function showAdvice(d){
  const m=new Date().getMonth()+1,p=d.periods[0];
  let advice=[];
  if(p.weather.match(/Storm|Wind|Rain/)) advice.push("‚ö†Ô∏è Severe weather‚Äîstay indoors and secure items.");
  else if(p.tempC<5) advice.push("üßä Cold weather‚Äîpossible ice, drive safely.");
  else if(m>=11||m<=2&&p.uv>5) advice.push("üåû High UV‚Äîwear sunscreen & hats.");
  advice.push("Check conditions regularly. Stay safe!");
  document.getElementById('ai-advice').textContent=advice.join(' ');
}

async function showHourly(day){
  const d=await fetchJson(`${apiUrl}/forecasts/${lat},${lon}?filter=3hr&limit=8&from=${day}&client_id=${id}&client_secret=${secret}`);
  let html="";
  d.response[0].periods.forEach(p=>html+=`<p>${p.dateTimeISO.substr(11,5)} ${p.weather} ${Math.round(p.tempC)}¬∞C</p>`);
  document.getElementById('hourly-title').textContent="Hourly for "+new Date(day).toLocaleDateString('en-NZ');
  document.getElementById('hourly-content').innerHTML=html;
  document.getElementById('hourly-modal').style.display='flex';
}

function setupRainChart(data){
  new Chart(document.getElementById('rainChart').getContext('2d'),{
    type:'bar',data:{labels:["Day 1","Day 2","Day 3","Day 4","Day 5","Day 6","Day 7"],datasets:[{label:"Rain(mm)",data,backgroundColor:'#4a90e2'}]}
  });
}

async function fetchJson(url){const r=await fetch(url);return r.json();}
function showRain(){document.getElementById('rain-modal').style.display='flex';}
function closeModal(id){document.getElementById(id).style.display='none';}

</script>
</body>
</html>