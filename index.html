<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agora Weather</title>
  <style>
    body { background: #1B263B; color: #fff; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; }
    .container { max-width: 460px; margin: 28px auto; padding: 24px 12px; background: #274472; border-radius: 22px; box-shadow: 0 8px 40px #1b263baa; }
    .loc { font-size: 2rem; font-weight: bold; text-align: center; margin: 0 0 15px; letter-spacing: .01em;}
    .current-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;}
    .icon-main { width: 86px; height: 86px; background: #163060; border-radius: 12px; object-fit: contain; }
    .cur-data { flex: 1; margin-left: 12px; }
    .cur-temp { font-size: 3.2rem; font-weight: bold; margin-bottom: 4px; }
    .cur-cond { font-size: 1.2rem; font-weight: 600; }
    .details { display: grid; grid-template-columns: 1fr 1fr; gap: 3px 10px; font-size: 1.04rem; margin-bottom: 8px;}
    .details span { opacity: 0.90; margin-bottom: 1px;}
    .advice { background: #415a77; border-radius: 8px; font-style: italic; font-size: 1.12rem; padding: 9px 13px; margin: 16px 0 14px;}
    .forecast-list { margin: 0 0 8px;}
    .day-item { background: #233356; margin: 5px 0; border-radius: 9px; display: flex; align-items: center; cursor: pointer; transition: background .16s;}
    .day-item.disabled { opacity: 0.45; pointer-events: none; }
    .day-item:hover { background: #415a77; }
    .day-label { width: 65px; font-weight: bold; font-size: 1.05rem; }
    .day-icon { width: 37px; height: 37px; margin: 0 8px;}
    .day-cond { flex: 1; margin: 0 3px; font-size: 1.04rem;}
    .day-temp { width: 68px; text-align: right; font-weight: 500; }
    .info-line { margin: 12px 0 8px; font-size: 1.06rem;}
    .section-btn { background: #1B263B; color: #fff; border: 0; border-radius: 7px; padding: 8px 12px; margin: 14px 0 9px; cursor: pointer; width: 100%; font-size: 1.09rem;}
    .attribution { text-align: center; font-size: 0.8rem; color: #b5b5b5; margin-top: 18px; }
    .modal { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100vw; height: 100vh; background: #1b263bcc; align-items: flex-start; justify-content: center; }
    .modal-content { background: #274472; border-radius: 15px; padding: 20px 10px 18px; max-width: 440px; width: 97vw; max-height: 83vh; overflow-y: auto; margin: 40px auto 0;}
    .modal-title { font-weight: bold; font-size: 1.19rem; margin-bottom: 12px;}
    .close-btn { position: absolute; right: 21px; top: 14px; font-size: 2.1rem; color: #fff; background: none; border: none; cursor: pointer;}
    .hourly-row { display: flex; align-items: center; margin-bottom: 8px; }
    .hour-time { width: 58px; font-weight: bold; }
    .hour-icon { width: 31px; height: 31px;}
    .hour-cond { flex: 1; margin: 0 6px; }
    .hour-temp { width: 41px; text-align: right; font-weight: 500; }
    .chart { display: flex; align-items: flex-end; height: 88px; gap: 8px; margin: 19px 0 6px; }
    .bar { background: #61aaff; width: 15px; border-radius: 4px 4px 0 0; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
    .bar-label { font-size: 0.85rem; text-align: center; margin-top: 2px;}
    .bar-value { font-size: 0.82rem; margin-bottom: 3px;}
    .rain-totals { margin: 8px 0 4px; font-size: 1.01rem;}
    @media (max-width: 540px) {
      .container, .modal-content { max-width: 100vw; padding: 7px;}
      .cur-temp { font-size: 2.4rem;}
      .loc { font-size: 1.3rem;}
      .cur-cond { font-size: 1rem;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="loc" id="loc">Loading...</div>
    <div class="current-row">
      <img id="icon" class="icon-main" src="" alt="Weather icon" />
      <div class="cur-data">
        <div class="cur-temp" id="ctemp"></div>
        <div class="cur-cond" id="cond"></div>
      </div>
    </div>
    <div class="details" id="details"></div>
    <div class="advice" id="advice"></div>
    <div class="forecast-list" id="forecast"></div>
    <div class="info-line" id="info"></div>
    <button class="section-btn" onclick="showRain()">🌧 Rainfall History</button>
    <div class="attribution">Data powered by Vaisala Xweather</div>
  </div>

  <!-- Hourly Modal -->
  <div class="modal" id="hourModal">
    <div class="modal-content" id="hourModalContent">
      <button class="close-btn" onclick="closeModal('hourModal')">&times;</button>
      <div id="hourModalTitle" class="modal-title"></div>
      <div id="hourlyRows"></div>
    </div>
  </div>
  <!-- Rainfall Modal -->
  <div class="modal" id="rainModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('rainModal')">&times;</button>
      <div class="modal-title">Rainfall History</div>
      <div id="rainChart"></div>
      <div class="rain-totals" id="rainTotals"></div>
    </div>
  </div>

<script>
const clientId = "U8feQfLlcEfcXDfsWZs4C";
const clientSecret = "HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";
const apiBase = "https://data.api.xweather.com";
let userLat, userLon;

// === ICON MAP (fallbacks) ===
const wxFallback = "https://cdn.aerisapi.com/wxblox/icons/skc.png"; // fallback icon
function wxIconUrl(code) {
  if (!code) return wxFallback;
  if (code.endsWith(".png")) return `https://cdn.aerisapi.com/wxblox/icons/${code}`;
  return `https://cdn.aerisapi.com/wxblox/icons/${code}.png`;
}
function validNum(val) { return typeof val === "number" && !isNaN(val) && val!==null; }

// === GEOLOCATION ===
function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(gotLoc, geoErr, {enableHighAccuracy:true, timeout:9000});
  } else {
    useFallbackLoc();
  }
}
function gotLoc(pos) {
  userLat = pos.coords.latitude;
  userLon = pos.coords.longitude;
  fetchAll();
}
function geoErr() {
  useFallbackLoc();
}
function useFallbackLoc() {
  userLat = -37.7833; userLon = 175.2833;
  fetchAll();
}

// === REVERSE GEOCODE: Find city for display only ===
async function getNearestCity(lat, lon) {
  let url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&zoom=10&format=json`;
  try {
    let r = await fetch(url, {headers:{'Accept-Language':'en'}});
    let d = await r.json();
    if (d && d.address) {
      return d.address.city || d.address.town || d.address.village || d.address.hamlet ||
             d.address.state || d.address.region || d.address.county || null;
    }
  } catch(e) {}
  return null;
}

// === FETCH ALL DATA ===
async function fetchAll() {
  let latlon = `${userLat},${userLon}`;
  let fcUrl = `${apiBase}/forecasts/${latlon}?format=json&filter=day&limit=7&fields=periods.dateTimeISO,loc,periods.maxTempC,periods.minTempC,periods.pop,periods.precipMM,periods.maxHumidity,periods.minHumidity,periods.maxDewpointC,periods.minDewpointC,periods.maxFeelslikeC,periods.windSpeedMaxKPH,periods.windSpeedMinKPH,periods.windDirMax,periods.windDirMin,periods.weather,periods.icon,periods.uvIndex,periods.sunriseISO,periods.sunsetISO,periods.sky&client_id=${clientId}&client_secret=${clientSecret}`;
  let condUrl = `${apiBase}/conditions/${latlon}?format=json&plimit=1&filter=minutelyprecip,5min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windDir,periods.weather,periods.feelslikeC,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.sky,periods.sunriseISO,periods.sunsetISO,periods.icon&client_id=${clientId}&client_secret=${clientSecret}`;
  let hourlyUrl = `${apiBase}/forecasts/${latlon}?format=json&filter=1hr&limit=48&fields=periods.dateTimeISO,periods.tempC,periods.feelslikeC,periods.weather,periods.icon&client_id=${clientId}&client_secret=${clientSecret}`;
  let lightningUrl = `${apiBase}/lightning/${latlon}?format=json&filter=all&limit=10&fields=id,ob,loc,recISO&client_id=${clientId}&client_secret=${clientSecret}`;
  let roadUrl = `${apiBase}/roadweather/${latlon}?client_id=${clientId}&client_secret=${clientSecret}`;
  let cycloneUrl = `${apiBase}/tropicalcyclones/closest?p=${latlon}&radius=25mi&minradius=0mi&filter=all,&limit=2&client_id=${clientId}&client_secret=${clientSecret}`;
  let alertsUrl = `${apiBase}/alerts/${latlon}?format=json&limit=3&fields=details.name,loc,details.color,details.body,details.bodyFull,timestamps.beginsISO,timestamps.expiresISO,includes.zipcodes,includes.counties&client_id=${clientId}&client_secret=${clientSecret}`;

  // Fetch everything in parallel, plus city name from OSM if needed
  let [forecast, conds, hourly, lightning, road, cyclone, alerts, rainDays] = await Promise.all([
    fetchJson(fcUrl), fetchJson(condUrl), fetchJson(hourlyUrl),
    fetchJson(lightningUrl), fetchJson(roadUrl), fetchJson(cycloneUrl), fetchJson(alertsUrl),
    fetchRainDays(latlon)
  ]);

  // Nearest city logic: prefer Xweather, else OSM, else fallback
  let locVal = (forecast && forecast.loc && forecast.loc.name) ? forecast.loc.name :
               (conds && conds.loc && conds.loc.name) ? conds.loc.name : null;
  if (!locVal) locVal = await getNearestCity(userLat, userLon);
  if (!locVal) locVal = `Near ${userLat.toFixed(2)}, ${userLon.toFixed(2)}`;
  document.getElementById("loc").textContent = locVal;

  // Current
  let cur = conds && conds.periods && conds.periods[0] ? conds.periods[0] : null;
  let cicon = cur && cur.icon ? wxIconUrl(cur.icon) : wxFallback;
  document.getElementById("icon").src = cicon;
  document.getElementById("icon").alt = cur && cur.weather ? cur.weather : "Weather icon";
  document.getElementById("ctemp").textContent = validNum(cur && cur.tempC) ? Math.round(cur.tempC)+"°" : "--";
  document.getElementById("cond").textContent = cur && cur.weather ? cur.weather : (forecast && forecast.periods && forecast.periods[0] && forecast.periods[0].weather) ? forecast.periods[0].weather : "--";
  document.getElementById("details").innerHTML = `
    <span>Feels: ${validNum(cur && cur.feelslikeC) ? Math.round(cur.feelslikeC)+"°" : "--"}</span>
    <span>Humidity: ${validNum(cur && cur.humidity) ? cur.humidity+"%" : "--"}</span>
    <span>Dew: ${validNum(cur && cur.dewpointC) ? Math.round(cur.dewpointC)+"°" : "--"}</span>
    <span>UV: ${validNum(cur && cur.uvIndex) ? cur.uvIndex : "--"}</span>
    <span>Cloud: ${validNum(cur && cur.sky) ? cur.sky+"%" : "--"}</span>
    <span>Sunrise: ${cur && cur.sunriseISO ? hhmm(cur.sunriseISO) : "--"}</span>
    <span>Sunset: ${cur && cur.sunsetISO ? hhmm(cur.sunsetISO) : "--"}</span>
    <span>Wind: ${validNum(cur && cur.windSpeedKPH) ? Math.round(cur.windSpeedKPH)+"km/h" : "--"}</span>
    <span>Gusts: --</span>
    <span>Pressure: ${validNum(cur && cur.pressureMB) ? cur.pressureMB+" hPa" : "--"}</span>
    <span>Visibility: ${validNum(cur && cur.visibilityKM) ? cur.visibilityKM+" km" : "--"}</span>
  `;

  // AI advice using all points:
  let advice = aiAdvice({ forecast, cur, lightning, road, cyclone, alerts, rainDays });
  document.getElementById("advice").textContent = advice;

  // Forecast (only enables click if hourly available for that day)
  let fcHtml = "";
  let hourlyTimes = (hourly && hourly.periods) ? hourly.periods.map(x=>x.dateTimeISO) : [];
  if (forecast && forecast.periods) {
    forecast.periods.forEach((d, i) => {
      let day = new Date(d.dateTimeISO);
      let hasHourly = hourlyTimes.some(t => {
        let th = new Date(t);
        return th.getDate()===day.getDate() && th.getMonth()===day.getMonth();
      });
      let label = i==0 ? "Today" : i==1 ? "Tomorrow" : dayName(d.dateTimeISO);
      fcHtml += `
        <div class="day-item${hasHourly?"":" disabled"}" onclick="${hasHourly?`showHourly(${i})`:""}">
          <div class="day-label">${label}</div>
          <img src="${wxIconUrl(d.icon)}" class="day-icon" alt="${d.weather||''}"/>
          <div class="day-cond">${d.weather||''}</div>
          <div class="day-temp">${validNum(d.maxTempC)?Math.round(d.maxTempC)+"°":"--"}/${validNum(d.minTempC)?Math.round(d.minTempC)+"°":"--"}</div>
        </div>
      `;
    });
  }
  document.getElementById("forecast").innerHTML = fcHtml;

  // Info line (hazards)
  let infoArr = [];
  if (lightning && lightning.ob && lightning.ob.length>0) infoArr.push("⚡ Lightning nearby");
  if (road && road.status && road.status.summary) infoArr.push(`🛣️ Road: ${road.status.summary}`);
  if (cyclone && cyclone.response && cyclone.response.length>0) infoArr.push(`🌀 Cyclone: ${cyclone.response[0].details ? cyclone.response[0].details.name : 'active'}`);
  if (alerts && alerts.length>0 && alerts[0].details && alerts[0].details.name) infoArr.push(`⚠️ Alerts: ${alerts[0].details.name}`);
  document.getElementById("info").innerHTML = infoArr.length ? infoArr.join("<br>") : "";

  // Save for hourly modal
  window._forecast = forecast;
  window._hourly = hourly;
}

// === HOURLY POPUP ===
function showHourly(i) {
  let hourly = window._hourly && window._hourly.periods ? window._hourly.periods : [];
  let fc = window._forecast && window._forecast.periods ? window._forecast.periods : [];
  if (!hourly.length || !fc[i]) { alert("Hourly not ready."); return; }
  let d0 = new Date(fc[i].dateTimeISO); d0.setHours(0,0,0,0);
  let d1 = new Date(d0.getTime()+86400000);
  let hlist = hourly.filter(h => {
    let hd = new Date(h.dateTimeISO); return hd >= d0 && hd < d1;
  });
  if (!hlist.length) { alert("Hourly not ready."); return; }
  let html = "";
  hlist.forEach(h => {
    html += `<div class="hourly-row">
      <span class="hour-time">${hhmm(h.dateTimeISO)}</span>
      <img src="${wxIconUrl(h.icon)}" class="hour-icon" alt=""/>
      <span class="hour-cond">${h.weather||""}</span>
      <span class="hour-temp">${validNum(h.tempC)?Math.round(h.tempC)+"°":"--"}</span>
    </div>`;
  });
  document.getElementById("hourModalTitle").textContent = fc[i].weather + " - " + dayName(fc[i].dateTimeISO);
  document.getElementById("hourlyRows").innerHTML = html;
  document.getElementById("hourModal").style.display = "flex";
}
function closeModal(id) { document.getElementById(id).style.display="none"; }

// === RAINFALL POPUP ===
function showRain() {
  let rain = window._rainDays || [];
  if (!rain.length) { document.getElementById("rainChart").innerHTML="No rain data"; document.getElementById("rainTotals").textContent=""; }
  else {
    let max = Math.max(...rain.map(d=>d.mm));
    let chart = rain.map(d=>`
      <div class="bar" style="height:${Math.round((d.mm/max)*82)}px">
        <div class="bar-value">${d.mm||0}mm</div>
        <div class="bar-label">${d.day}</div>
      </div>
    `).join('');
    document.getElementById("rainChart").innerHTML = `<div class="chart">${chart}</div>`;
    let total7 = rain.reduce((a,b)=>a+b.mm,0);
    document.getElementById("rainTotals").innerHTML = `Past 7 days: <strong>${total7}mm</strong>`;
  }
  document.getElementById("rainModal").style.display = "flex";
}

// === FETCH 7 DAYS RAIN DATA ===
async function fetchRainDays(latlon) {
  let fc = await fetchJson(`${apiBase}/forecasts/${latlon}?format=json&filter=day&limit=7&fields=periods.dateTimeISO,periods.precipMM&client_id=${clientId}&client_secret=${clientSecret}`);
  if (!fc || !fc.periods) return [];
  let days = fc.periods.map(f=>({day:dayName(f.dateTimeISO), mm:Math.round(f.precipMM||0)}));
  window._rainDays = days;
  return days;
}

// === AI ADVICE GENERATOR ===
function aiAdvice({forecast,cur,lightning,road,cyclone,alerts,rainDays}) {
  let advice = [];
  if (alerts && alerts.length>0 && alerts[0].details && alerts[0].details.body) advice.push("⚠️ " + alerts[0].details.body);
  if (cyclone && cyclone.response && cyclone.response.length>0) advice.push("🌀 Cyclone warning: " + (cyclone.response[0].details ? cyclone.response[0].details.name : ""));
  if (road && road.status && road.status.summary) advice.push("🛣️ Roads: " + road.status.summary);
  if (lightning && lightning.ob && lightning.ob.length>0) advice.push("⚡ Lightning activity nearby");
  let f = forecast && forecast.periods ? forecast.periods[0] : null;
  if (f) {
    let t = f.maxTempC;
    let pop = f.pop;
    let cond = (f.weather||"").toLowerCase();
    if (cond.includes("storm")) advice.push("Storms possible—take care outdoors.");
    if (pop>70) advice.push("High chance of rain—keep an umbrella handy.");
    if (t>=27) advice.push("Hot day—drink plenty of water and use sunblock.");
    if (t<=3) advice.push("Freezing – black ice risk early mornings.");
    if (f.uvIndex && f.uvIndex>6) advice.push("UV high—wear sunscreen.");
    if (cond.includes("snow")) advice.push("Possible snow—check road conditions.");
  }
  let month = (new Date()).getMonth()+1;
  if (month>=5&&month<=8) advice.push("Winter: check for frost, allow extra travel time.");
  else if (month>=11||month<=2) advice.push("Summer: Stay sun safe and hydrated.");
  let shown = (localStorage.getItem("last_advice")||"").split("|");
  let uniq = advice.filter(a=>a&&shown.indexOf(a)<0);
  let show = uniq.length ? uniq[0] : advice[0] || "All clear—enjoy your day!";
  let advOut = [show].concat(shown.slice(0,2)).join("|");
  try { localStorage.setItem("last_advice", advOut); } catch{}
  return show;
}

// === GENERIC HELPERS ===
function dayName(iso) { return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(iso).getDay()]; }
function hhmm(iso) { let d=new Date(iso);return d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0"); }
async function fetchJson(url) { try { let r = await fetch(url); return await r.json(); } catch { return null; } }

getLocation();
</script>
</body>
</html>