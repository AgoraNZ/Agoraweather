<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agora NZ Weather â€“ Smarter Kiwi Weather App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="The only weather app built on real NZ station data with uniquely Kiwi weather advice."/>
  <link rel="manifest" href="manifest.json">
  <style>
    body { margin: 0; padding: 0; background: #f4f7fb; font-family: 'Segoe UI', Arial, sans-serif; color: #15304b; min-height: 100vh;}
    .app-container { max-width: 500px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 5px 30px #193a5e18; padding-bottom: 34px; min-height: 100vh; display: flex; flex-direction: column;}
    header { background: linear-gradient(90deg, #18558e 68%, #15b2c1 100%); color: #fff; padding: 34px 22px 18px 22px; border-radius: 0 0 30px 30px; box-shadow: 0 3px 16px #18558e10; text-align: left;}
    .main-title { font-size: 2.07rem; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 6px;}
    .sub-title { font-size: 1.09rem; opacity: 0.94; font-weight: 400; margin-bottom: 0;}
    .station-select-row { display: flex; align-items: center; gap: 9px; margin-top: 14px; margin-bottom: 7px;}
    select, button { font-size: 1rem; padding: 5px 10px; border-radius: 6px; border: 1px solid #18558e; background: #f4f7fb; color: #1c293a; font-family: inherit; }
    select:disabled { background: #e7eaf3; color: #888; }
    .current-block { margin: 17px 18px 0 18px; padding: 17px 11px; border-radius: 12px; background: #eaf3fa; box-shadow: 0 2px 8px #cad8e850; display: flex; align-items: flex-start; gap: 18px;}
    .current-icon-wrap { display: flex; flex-direction: column; align-items: center; }
    .current-icon { width: 72px; height: 72px; object-fit: contain; background: #fff; border-radius: 50%; border: 2.5px solid #18558e; padding: 8px; box-shadow: 0 0 8px #18558e18; }
    .moon-icon { width: 38px; height: 38px; margin: 10px auto 0 auto; }
    .moon-label { font-size: 0.95em; color: #444a68; margin-top: 1px; text-align:center;}
    .current-details { flex: 1; display: flex; flex-direction: column; }
    .current-temp-big { font-size: 3.6rem; font-weight: bold; color: #16549b; margin: 4px 0 6px 0; line-height:1; letter-spacing:-1.2px;}
    .current-grid { display: flex; flex-wrap: wrap; margin-top: 4px; }
    .current-field { width: 48%; min-width: 146px; font-size: 0.99rem; margin-bottom: 4px; }
    .current-label { font-weight: bold; color: #19558e; }
    .advice-block { margin: 17px 18px 0 18px; padding: 13px 15px; border-radius: 10px; background: #e5f2ff; color: #1e364a; font-size: 1.10rem; font-weight: 500; box-shadow: 0 2px 8px #c8e6ff55; min-height: 58px;}
    .forecast-row { margin: 18px 0 0 0; padding-left: 14px; display: flex; overflow-x: auto; gap: 9px; scrollbar-width: thin;}
    .forecast-card { flex: 0 0 136px; background: #f7faff; border-radius: 12px; box-shadow: 0 2px 7px #aac2e660; display: flex; flex-direction: column; align-items: center; padding: 11px 7px 13px 7px; cursor: pointer; transition: box-shadow 0.2s; border: 2px solid transparent; min-width: 110px; max-width: 160px;}
    .forecast-card.selected, .forecast-card:hover { border: 2.5px solid #18558e; box-shadow: 0 6px 16px #aac2e680; background: #e2f3ff;}
    .forecast-icon { width: 41px; height: 41px; margin-bottom: 6px; margin-top: 2px;}
    .forecast-day { font-weight: 600; font-size: 1.01rem; margin-bottom: 2px; }
    .forecast-summary { font-size: 0.97rem; margin-bottom: 4px; color: #2857a1; min-height: 18px; text-align: center;}
    .forecast-temps { font-size: 1.07rem; font-weight: 500; color: #285680; margin-bottom: 1px;}
    .forecast-rain { font-size: 0.91rem; color: #0a6899; margin-bottom: 0;}
    .forecast-advice { font-size:0.97em; color:#1a3e2d; min-height:28px; margin-top:2px;}
    .modal-bg { position: fixed; left:0; top:0; right:0; bottom:0; background: #23324c45; z-index: 50; display: flex; align-items: flex-end; justify-content: center;}
    .modal-popup { width: 100%; max-width: 470px; background: #fff; border-radius: 22px 22px 0 0; box-shadow: 0 10px 40px #23324c70; padding: 23px 18px 18px 18px; animation: modalIn 0.3s;}
    @keyframes modalIn { from { transform: translateY(100px); opacity: 0;} to { transform: translateY(0); opacity: 1;} }
    .modal-header { font-size: 1.30rem; font-weight: bold; margin-bottom: 7px; color: #18558e;}
    .modal-close-btn { position: absolute; top: 18px; right: 23px; background: none; border: none; font-size: 1.7rem; color: #6c7c8c; cursor: pointer; z-index: 100;}
    .modal-details { margin-top: 6px; font-size: 1.07rem; color: #23415c;}
    .rain-panel { margin: 18px 18px 0 18px; padding: 12px 12px 10px 12px; border-radius: 10px; background: #ecf8ff; color: #15304b; box-shadow: 0 2px 8px #c8e6ff40; font-size: 1.03rem; line-height: 1.35em;}
    .rain-label { font-weight: 600; color: #18558e; margin-bottom: 3px; font-size: 1.08rem;}
    .fishing-panel { margin: 25px 18px 0 18px; padding: 14px 14px 12px 14px; border-radius: 12px; background: #eafaf7; box-shadow: 0 2px 7px #bceadd33; color: #18558e; font-size: 1.12rem; font-weight: 500; min-height: 50px;}
    .fish-headline { font-size: 1.18rem; font-weight: bold; margin-bottom: 6px;}
    .fish-tips { font-size: 1.04rem; margin-top: 7px; color: #217b6a; }
    .fish-tide { font-size: 0.99em; margin: 7px 0; }
    .fish-swell { margin: 12px 0; text-align: center; }
    .fish-swell img { width: 100%; max-width: 320px; border-radius: 6px; box-shadow: 0 2px 12px #2684c222; }
    @media (max-width: 600px) { .app-container { box-shadow: none; border-radius: 0;} .forecast-row { padding-left: 3px;} .modal-popup { border-radius: 21px 21px 0 0; padding: 11px 6px 17px 7px;} }
    .loader { margin: 60px auto 34px auto; border: 7px solid #d7e3f5; border-top: 7px solid #0f82c6; border-radius: 50%; width: 44px; height: 44px; animation: spin 1.05s linear infinite;}
    @keyframes spin { 0% { transform: rotate(0);} 100% { transform: rotate(360deg);} }
    .credit { text-align: center; color: #b4c2d3; font-size: 0.96em; margin: 31px auto 0 auto;}
    .station-select-row label { font-size: 1em; color: #133958;}
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="main-title">Agora NZ Weather</div>
      <div class="sub-title">The only NZ weather app with real station data &amp; truly practical Kiwi advice</div>
      <div class="station-select-row">
        <label for="stationSelect">Station:</label>
        <select id="stationSelect" disabled>
          <option value="IPAERO15" selected>Paeroa (XWeather Actual Station)</option>
        </select>
      </div>
    </header>
    <div id="loader" class="loader"></div>
    <div id="mainContent" style="display:none;">
      <section><div class="current-block" id="currentBlock"></div></section>
      <section><div class="advice-block" id="adviceBlock"></div></section>
      <section><div class="forecast-row" id="forecastRow"></div></section>
      <section><div class="rain-panel" id="rainPanel"></div></section>
      <section><div class="fishing-panel" id="fishingPanel"></div></section>
    </div>
    <div id="modalBg" class="modal-bg" style="display:none;"><div class="modal-popup" id="modalPopup"></div></div>
    <div class="credit">Powered by live NZ station data â€¢ 2025 Agora<br><span style="font-size:0.89em;opacity:0.8;">Proudly New Zealand owned & built for Kiwis</span></div>
  </div>
  <script>
    // --- CONFIG
    const client_id = "U8feQfLlcEfcXDfsWZs4C";
    const client_secret = "HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";
    const CURRENT_URL = `https://data.api.xweather.com/conditions/pws_paeroa?format=json&plimit=1&filter=1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,periods.weather,periods.feelslikeC,periods.visibilityKM,periods.clouds&client_id=${client_id}&client_secret=${client_secret}`;
    const FORECAST_URL = `https://developer.xweather.com/product/api/output?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvcHRpb25zIjp7ImxvYyI6eyJ2YWx1ZSI6InB3c19wYWVyb2EiLCJhdXRvIjpmYWxzZX0sImZvcm1hdCI6Impzb24iLCJwYXJhbWV0ZXJzIjp7ImZpbHRlciI6ImRheW5pZ2h0IiwibGltaXQiOjcsImZpZWxkcyI6WyJwZXJpb2RzLmRhdGVUaW1lSVNPIiwibG9jIiwicGVyaW9kcy5wb3AiLCJwZXJpb2RzLnByZWNpcE1NIiwicGVyaW9kcy5taW5EZXdwb2ludEMiLCJwZXJpb2RzLndlYXRoZXIiLCJwZXJpb2RzLndpbmRTcGVlZEtQSCIsInBlcmlvZHMud2luZEd1c3RLUEgiLCJwZXJpb2RzLnZpc2liaWxpdHlLTSIsInBlcmlvZHMuY2xvdWRzIl19fSwiZW5kcG9pbnQiOiJmb3JlY2FzdHMiLCJhY3Rpb24iOiJpZCIsImlhdCI6MTc1MzUxNjU3N30.5mDAisIJqg46Pp3XVFxkW4nU-C0uJ8Km52tcqqRCJKk`;
    const PHRASES_URL = `https://data.api.xweather.com/phrases/summary/pws_paeroa?format=json&client_id=${client_id}&client_secret=${client_secret}`;
    const now = new Date();
    const pad = n => n<10?"0"+n:n;
    const sunmoon_from = `${pad(now.getMonth()+1)}/${pad(now.getDate())}/${now.getFullYear()}`;
    const sunmoon_to = `${pad(now.getMonth()+1)}/${pad(now.getDate()+1)}/${now.getFullYear()}`;
    const MOON_URL = `https://data.api.xweather.com/sunmoon/pws_paeroa?from=${sunmoon_from}&to=${sunmoon_to}&format=json&fields=dateTimeISO,timestamp,profile,loc,place,sun,moon&client_id=${client_id}&client_secret=${client_secret}`;
    const tideImgUrl = "https://www.metservice.com/publicData/webdata/marine/boating/tidegraphs/Firth-of-Thames.png";

    // --- Moon icons by phase
    const moonIcons = {
      "new moon": "ðŸŒ‘",
      "waxing crescent": "ðŸŒ’",
      "first quarter": "ðŸŒ“",
      "waxing gibbous": "ðŸŒ”",
      "full moon": "ðŸŒ•",
      "waning gibbous": "ðŸŒ–",
      "last quarter": "ðŸŒ—",
      "waning crescent": "ðŸŒ˜"
    };

    function degToCardinal(deg) {
      if (!deg || isNaN(deg)) return "";
      const dirs = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
      return dirs[Math.round(((deg % 360) / 45)) % 8];
    }

    async function loadWeatherApp() {
      document.getElementById('loader').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
      try {
        const [curRes, fcRes, phrRes, moonRes] = await Promise.all([
          fetch(CURRENT_URL).then(r=>r.json()),
          fetch(FORECAST_URL).then(r=>r.json()),
          fetch(PHRASES_URL).then(r=>r.json()),
          fetch(MOON_URL).then(r=>r.json())
        ]);
        let cur = (curRes && curRes.response && curRes.response[0] && curRes.response[0].periods && curRes.response[0].periods[0]) || {};
        let curLoc = curRes.response && curRes.response[0] && curRes.response[0].loc ? curRes.response[0].loc : {};
        let moonToday = moonRes.response && moonRes.response[0] ? moonRes.response[0] : {};
        let phraseObj = phrRes.response && phrRes.response[0] && phrRes.response[0].phrases ? phrRes.response[0].phrases : {};
        let forecastPeriods = (fcRes && fcRes.response && fcRes.response[0] && fcRes.response[0].periods) || [];

        renderCurrentBox(cur, curLoc, moonToday);
        renderAdvice(phraseObj, moonToday);
        renderForecasts(forecastPeriods);
        renderRainPanel(forecastPeriods);
        await renderFishingPanel(moonToday, phraseObj);
        document.getElementById('loader').style.display = 'none';
        document.getElementById('mainContent').style.display = '';
      } catch (e) {
        document.getElementById('loader').innerHTML = "Couldnâ€™t load weather data. Try again soon.";
        console.error(e);
      }
    }

    function renderCurrentBox(cur, curLoc, moonToday) {
      let iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2601.png";
      let weatherText = (cur.weather || "").toString();
      if (weatherText.toLowerCase().includes("clear")) iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2600.png";
      if (weatherText.toLowerCase().includes("rain")) iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f327.png";
      if (weatherText.toLowerCase().includes("cloud")) iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2601.png";
      if (weatherText.toLowerCase().includes("snow")) iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2744.png";
      if (weatherText.toLowerCase().includes("thunder")) iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c8.png";
      let moonPhase = moonToday.moon && moonToday.moon.phase ? moonToday.moon.phase.name : "";
      let moonIcon = moonIcons[moonPhase] || "ðŸŒ™";
      let moonIllum = moonToday.moon && moonToday.moon.phase ? moonToday.moon.phase.illum : "";
      let moonLabel = moonPhase ? `${moonPhase.replace(/\b\w/g, l=>l.toUpperCase())}${moonIllum !== "" ? ` (${moonIllum}%)` : ""}` : "";

      // Visibility
      let visStr = cur.visibilityKM != null ? Number(cur.visibilityKM).toFixed(1) + " km" : "â€”";
      // Wind
      let windStr = cur.windSpeedKPH != null ? cur.windSpeedKPH + " km/h" : "â€”";
      let gustStr = cur.windGustKPH != null ? cur.windGustKPH + " km/h" : "";
      if (gustStr) windStr += ` / ${gustStr}`;
      if (cur.windDir != null && cur.windDir !== "") windStr += " " + degToCardinal(cur.windDir);

      document.getElementById('currentBlock').innerHTML = `
        <div class="current-icon-wrap">
          <img class="current-icon" src="${iconUrl}" alt="icon"/>
          <div class="moon-icon" style="font-size:2em;">${moonIcon}</div>
          <div class="moon-label">${moonLabel}</div>
        </div>
        <div class="current-details">
          <div class="current-temp-big">${cur.tempC != null ? Number(cur.tempC).toFixed(1) + "Â°C" : "â€”"}</div>
          <div class="current-grid">
            <div class="current-field"><span class="current-label">Feels Like:</span> ${cur.feelslikeC != null ? cur.feelslikeC+"Â°C" : "â€”"}</div>
            <div class="current-field"><span class="current-label">Weather:</span> ${weatherText}</div>
            <div class="current-field"><span class="current-label">Humidity:</span> ${cur.humidity != null ? cur.humidity+"%" : "â€”"}</div>
            <div class="current-field"><span class="current-label">Wind / Gusts:</span> ${windStr}</div>
            <div class="current-field"><span class="current-label">Dew Point:</span> ${cur.dewpointC != null ? cur.dewpointC+"Â°C" : "â€”"}</div>
            <div class="current-field"><span class="current-label">Visibility:</span> ${visStr}</div>
            <div class="current-field"><span class="current-label">Cloud Cover:</span> ${cur.clouds != null ? cur.clouds + "%" : "â€”"}</div>
            <div class="current-field"><span class="current-label">Station:</span> Paeroa</div>
          </div>
        </div>
      `;
    }

    function renderAdvice(phrases, moonToday) {
      let out = [];
      if (phrases.shortMET) out.push(phrases.shortMET);
      if (moonToday && moonToday.moon && moonToday.moon.phase && moonToday.moon.phase.name)
        out.push(`Moon: ${moonToday.moon.phase.name}, illuminated ${moonToday.moon.phase.illum}%`);
      document.getElementById('adviceBlock').innerHTML = out.join(" &bull; ");
    }

    function renderForecasts(periods) {
      const row = document.getElementById('forecastRow');
      row.innerHTML = '';
      periods.forEach(per => {
        let weather = per.weather || "â€”";
        let iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2601.png";
        if (weather.toLowerCase().includes("clear")) iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2600.png";
        if (weather.toLowerCase().includes("rain")) iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f327.png";
        if (weather.toLowerCase().includes("cloud")) iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2601.png";
        if (weather.toLowerCase().includes("snow")) iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2744.png";
        if (weather.toLowerCase().includes("thunder")) iconUrl = "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c8.png";
        let rainMM = per.precipMM != null ? Number(per.precipMM).toFixed(1) : "â€”";
        let pop = per.pop != null ? per.pop + "%" : "â€”";
        let windStr = per.windSpeedKPH != null ? per.windSpeedKPH + " km/h" : "â€”";
        let gustStr = per.windGustKPH != null ? " / " + per.windGustKPH + " km/h" : "";
        let cloudStr = per.clouds != null ? per.clouds + "%" : "â€”";
        let visStr = per.visibilityKM != null ? per.visibilityKM + " km" : "â€”";
        row.innerHTML += `
          <div class="forecast-card">
            <div class="forecast-day">${formatDay(per.dateTimeISO)}</div>
            <img class="forecast-icon" src="${iconUrl}" alt="icon"/>
            <div class="forecast-summary">${weather}</div>
            <div class="forecast-temps">${per.minDewpointC != null ? per.minDewpointC + "Â°C/" : ""}${per.maxDewpointC != null ? per.maxDewpointC + "Â°C" : ""}</div>
            <div class="forecast-rain">Rain: ${rainMM} mm (${pop})</div>
            <div style="font-size:0.95em;color:#285;">Wind: ${windStr}${gustStr}</div>
            <div style="font-size:0.95em;color:#285;">Cloud: ${cloudStr}</div>
            <div style="font-size:0.95em;color:#285;">Vis: ${visStr}</div>
          </div>
        `;
      });
    }

    function renderRainPanel(periods) {
      let rain7 = 0;
      periods.forEach(per => { rain7 += Number(per.precipMM || 0); });
      document.getElementById('rainPanel').innerHTML = `
        <span class="rain-label">Rainfall Totals (Next 7d):</span><br>
        Forecast total: <b>${rain7.toFixed(1)} mm</b>
      `;
    }

    async function renderFishingPanel(moonToday, phrases) {
      const panel = document.getElementById('fishingPanel');
      let tideHtml = `
        <div class="fish-tide">
          <img src="${tideImgUrl}" alt="Firth of Thames Tide Chart" style="width:100%;max-width:420px;border-radius:9px;box-shadow:0 2px 14px #8fbce855;" />
          <div style="text-align:center;font-size:0.97em;margin-top:2px;">Live tide chart for Thames (Firth of Thames) â€“ from MetService</div>
        </div>
      `;
      let moonStr = "";
      if (moonToday && moonToday.moon && moonToday.moon.riseISO && moonToday.moon.setISO) {
        moonStr = `Moonrise: ${formatTimeNZ(moonToday.moon.riseISO)}, Moonset: ${formatTimeNZ(moonToday.moon.setISO)}`;
      }
      let tips = [
        "Check wind and rain in main forecast for best fishing windows.",
        "Tide and moon phase below are live.",
        moonStr
      ];
      panel.innerHTML = `
        <div class="fish-headline">Coromandel Fishing & Swell</div>
        <div class="fish-tips">${tips.filter(Boolean).join('<br>')}</div>
        ${tideHtml}
      `;
    }

    function formatDay(dateISO) {
      const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      let d = new Date(dateISO);
      return days[d.getDay()] + " " + d.getDate();
    }
    function formatTimeNZ(dateISO) {
      if (!dateISO) return "â€”";
      return new Date(dateISO).toLocaleTimeString('en-NZ', {hour:'2-digit',minute:'2-digit'});
    }

    window.onload = loadWeatherApp;
  </script>
</body>
</html>