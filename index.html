<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agora NZ Weather – Smarter Kiwi Weather App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="The only weather app built on real NZ station data with uniquely Kiwi weather advice."/>
  <style>
    body { margin: 0; padding: 0; background: #f4f7fb; font-family: 'Segoe UI', Arial, sans-serif; color: #15304b; min-height: 100vh;}
    .app-container { max-width: 520px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 5px 30px #193a5e18; padding-bottom: 34px; min-height: 100vh; display: flex; flex-direction: column;}
    header { background: linear-gradient(90deg, #18558e 68%, #15b2c1 100%); color: #fff; padding: 34px 22px 18px 22px; border-radius: 0 0 30px 30px; box-shadow: 0 3px 16px #18558e10; text-align: left;}
    .main-title { font-size: 2.07rem; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 6px;}
    .sub-title { font-size: 1.09rem; opacity: 0.94; font-weight: 400; margin-bottom: 0;}
    .current-block { margin: 17px 18px 0 18px; padding: 17px 11px; border-radius: 12px; background: #eaf3fa; box-shadow: 0 2px 8px #cad8e850; display: flex; align-items: center; gap: 18px;}
    .current-icon { width: 70px; height: 70px; object-fit: contain; background: #fff; border-radius: 50%; border: 2.5px solid #18558e; padding: 8px; box-shadow: 0 0 8px #18558e18; margin-right: 0;}
    .current-details { flex: 1; display: flex; flex-direction: column; }
    .current-temp-big { font-size: 3.3rem; font-weight: bold; color: #16549b; margin: 5px 0 7px 0; line-height:1; }
    .current-temp-label { font-size: 1.13rem; color: #35526b; margin-top: -4px; margin-bottom: 8px;}
    .current-grid { display: flex; flex-wrap: wrap; margin-top: 6px; }
    .current-field { width: 48%; min-width: 160px; font-size: 0.99rem; margin-bottom: 4px; }
    .current-label { font-weight: bold; color: #19558e; }
    .advice-block { margin: 17px 18px 0 18px; padding: 13px 15px; border-radius: 10px; background: #e5f2ff; color: #1e364a; font-size: 1.10rem; font-weight: 500; box-shadow: 0 2px 8px #c8e6ff55; min-height: 58px;}
    .forecast-row { margin: 18px 0 0 0; padding-left: 14px; display: flex; overflow-x: auto; gap: 9px; scrollbar-width: thin;}
    .forecast-card { flex: 0 0 136px; background: #f7faff; border-radius: 12px; box-shadow: 0 2px 7px #aac2e660; display: flex; flex-direction: column; align-items: center; padding: 11px 7px 13px 7px; cursor: pointer; transition: box-shadow 0.2s; border: 2px solid transparent; min-width: 110px; max-width: 160px;}
    .forecast-card.selected, .forecast-card:hover { border: 2.5px solid #18558e; box-shadow: 0 6px 16px #aac2e680; background: #e2f3ff;}
    .forecast-icon { width: 41px; height: 41px; margin-bottom: 6px; margin-top: 2px;}
    .forecast-day { font-weight: 600; font-size: 1.01rem; margin-bottom: 2px; }
    .forecast-summary { font-size: 0.97rem; margin-bottom: 4px; color: #2857a1; min-height: 18px; text-align: center;}
    .forecast-temps { font-size: 1.07rem; font-weight: 500; color: #285680; margin-bottom: 1px;}
    .forecast-rain { font-size: 0.91rem; color: #0a6899; margin-bottom: 0;}
    .forecast-advice { font-size:0.97em; color:#1a3e2d; min-height:28px; margin-top:2px;}
    .modal-bg { position: fixed; left:0; top:0; right:0; bottom:0; background: #23324c45; z-index: 50; display: flex; align-items: flex-end; justify-content: center;}
    .modal-popup { width: 100%; max-width: 470px; background: #fff; border-radius: 22px 22px 0 0; box-shadow: 0 10px 40px #23324c70; padding: 23px 18px 18px 18px; animation: modalIn 0.3s;}
    @keyframes modalIn { from { transform: translateY(100px); opacity: 0;} to { transform: translateY(0); opacity: 1;} }
    .modal-header { font-size: 1.30rem; font-weight: bold; margin-bottom: 7px; color: #18558e;}
    .modal-close-btn { position: absolute; top: 18px; right: 23px; background: none; border: none; font-size: 1.7rem; color: #6c7c8c; cursor: pointer; z-index: 100;}
    .modal-details { margin-top: 6px; font-size: 1.07rem; color: #23415c;}
    .marine-panel { margin: 22px 18px 0 18px; padding: 15px 16px 15px 16px; border-radius: 12px; background: #eafaf7; box-shadow: 0 2px 7px #bceadd33; color: #18558e; font-size: 1.12rem; font-weight: 500; min-height: 50px;}
    .marine-title { font-size: 1.20rem; font-weight: bold; margin-bottom: 6px;}
    .marine-tidechart { width:100%;max-width:360px;height:120px; }
    .moon-block { margin: 15px 18px 0 18px; padding: 10px 12px 10px 12px; border-radius: 10px; background: #ecf8ff; color: #18558e; box-shadow: 0 2px 8px #c8e6ff40; font-size: 1.09rem;}
    .loader { margin: 60px auto 34px auto; border: 7px solid #d7e3f5; border-top: 7px solid #0f82c6; border-radius: 50%; width: 44px; height: 44px; animation: spin 1.05s linear infinite;}
    @keyframes spin { 0% { transform: rotate(0);} 100% { transform: rotate(360deg);} }
    .credit { text-align: center; color: #b4c2d3; font-size: 0.96em; margin: 31px auto 0 auto;}
    .station-select-row label { font-size: 1em; color: #133958;}
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="main-title">Agora NZ Weather</div>
      <div class="sub-title">The only NZ weather app with real station data &amp; truly practical Kiwi advice</div>
    </header>
    <div id="loader" class="loader"></div>
    <div id="mainContent" style="display:none;">
      <section><div class="current-block" id="currentBlock"></div></section>
      <section><div class="advice-block" id="adviceBlock"></div></section>
      <section><div class="forecast-row" id="forecastRow"></div></section>
      <section><div class="marine-panel" id="marinePanel"></div></section>
      <section><div class="moon-block" id="moonPanel"></div></section>
    </div>
    <div id="modalBg" class="modal-bg" style="display:none;"><div class="modal-popup" id="modalPopup"></div></div>
    <div class="credit">Powered by Xweather (Aeris) APIs • 2025 Agora<br><span style="font-size:0.89em;opacity:0.8;">NZ owned & built for Kiwis</span></div>
  </div>
  <script>
    // API endpoints & credentials
    const condUrl = "https://data.api.xweather.com/conditions/pws_paeroa?format=json&plimit=1&filter=1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windDir,periods.weather,periods.feelslikeC&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";
    const forecastUrl = "https://developer.xweather.com/product/api/output?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvcHRpb25zIjp7ImxvYyI6eyJ2YWx1ZSI6InB3c19wYWVyb2EiLCJhdXRvIjpmYWxzZX0sImZvcm1hdCI6Impzb24iLCJwYXJhbWV0ZXJzIjp7ImZpbHRlciI6ImRheW5pZ2h0IiwibGltaXQiOjcsImZpZWxkcyI6WyJwZXJpb2RzLmRhdGVUaW1lSVNPIiwibG9jIiwicGVyaW9kcy5wb3AiLCJwZXJpb2RzLnByZWNpcE1NIiwicGVyaW9kcy5taW5EZXdwb2ludEMiLCJwZXJpb2RzLndlYXRoZXIiXX19LCJlbmRwb2ludCI6ImZvcmVjYXN0cyIsImFjdGlvbiI6ImlkIiwiaWF0IjoxNzUzNTE2NTc3fQ.5mDAisIJqg46Pp3XVFxkW4nU-C0uJ8Km52tcqqRCJKk";
    const marineUrl = "https://data.api.xweather.com/maritime/pws_coromandeltown1?filter=1hr&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";
    const summaryUrl = "https://data.api.xweather.com/phrases/summary/pws_paeroa?format=json&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";
    const sunmoonUrl = (() => {
      const today = new Date();
      const tomorrow = new Date(today.getTime() + 86400000);
      const f = (d) => `${("0"+(d.getMonth()+1)).slice(-2)}/${("0"+d.getDate()).slice(-2)}/${d.getFullYear()}`;
      return `https://data.api.xweather.com/sunmoon/pws_paeroa?from=${f(today)}&to=${f(tomorrow)}&format=json&fields=dateTimeISO,timestamp,profile,loc,place,sun,moon&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq`;
    })();

    // Weather icons based on simple weather codes/phrases
    function getIconW(word) {
      if (!word) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c5.png";
      const txt = word.toLowerCase();
      if (txt.includes("sun") || txt.includes("clear")) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2600.png";
      if (txt.includes("cloud")) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2601.png";
      if (txt.includes("showers") || txt.includes("rain")) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f327.png";
      if (txt.includes("snow")) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2744.png";
      if (txt.includes("thunder")) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c8.png";
      return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c5.png";
    }

    // Cardinal direction from degrees (for wind)
    function degToCardinal(deg) {
      if (deg == null || isNaN(deg)) return "";
      const dirs = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
      return dirs[Math.round(((deg % 360) / 45)) % 8];
    }

    // Main app loader
    async function loadWeatherApp() {
      document.getElementById('loader').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';

      let cond = {}, forecast = [], summary = {}, marine = {}, moon = {};

      try {
        // Fetch current
        let cData = await fetch(condUrl).then(r=>r.json());
        cond = (cData && cData.response && cData.response[0].periods && cData.response[0].periods[0]) || {};

        // Fetch forecast
        let fData = await fetch(forecastUrl).then(r=>r.json());
        forecast = (fData && fData.response && fData.response[0] && fData.response[0].periods) || [];

        // Fetch summary phrases
        let sumData = await fetch(summaryUrl).then(r=>r.json());
        summary = (sumData && sumData.response && sumData.response[0] && sumData.response[0].phrases) || {};

        // Fetch marine/tide/swell
        let mData = await fetch(marineUrl).then(r=>r.json());
        marine = (mData && mData.response && mData.response[0]) || {};

        // Fetch sun/moon
        let smData = await fetch(sunmoonUrl).then(r=>r.json());
        moon = (smData && smData.response && smData.response[0]) || {};

      } catch (e) {
        document.getElementById('loader').innerHTML = "Couldn’t load weather data. Try again soon.";
        console.error(e);
        return;
      }

      // Render everything
      renderCurrent(cond);
      renderAdvice(summary, cond);
      renderForecasts(forecast);
      renderMarine(marine);
      renderMoon(moon);

      document.getElementById('loader').style.display = 'none';
      document.getElementById('mainContent').style.display = '';
    }

    // Render current weather box
    function renderCurrent(p) {
      // p is single period from /conditions
      const iconUrl = getIconW(p.weather);
      let windStr = (p.windSpeedKPH!=null ? `${p.windSpeedKPH} km/h` : "—");
      let windDir = (p.windDir!=null ? degToCardinal(typeof p.windDir === "number" ? p.windDir : null) : "");
      let temp = p.tempC!=null ? p.tempC : "—";
      let dew = p.dewpointC!=null ? p.dewpointC : "—";
      let humid = p.humidity!=null ? p.humidity+"%" : "—";
      let feels = p.feelslikeC!=null ? p.feelslikeC : "—";
      let weatherTxt = p.weather || "—";
      let windFull = windStr + (windDir ? ` (${windDir})` : "");
      document.getElementById('currentBlock').innerHTML = `
        <img class="current-icon" src="${iconUrl}" alt="icon"/>
        <div class="current-details">
          <div class="current-temp-big">${temp}&deg;C</div>
          <div class="current-temp-label">Current temperature</div>
          <div class="current-grid">
            <div class="current-field"><span class="current-label">Weather:</span> ${weatherTxt}</div>
            <div class="current-field"><span class="current-label">Feels Like:</span> ${feels}&deg;C</div>
            <div class="current-field"><span class="current-label">Humidity:</span> ${humid}</div>
            <div class="current-field"><span class="current-label">Dewpoint:</span> ${dew}&deg;C</div>
            <div class="current-field"><span class="current-label">Wind:</span> ${windFull}</div>
          </div>
        </div>
      `;
    }

    // Render forecast scrollable cards
    function renderForecasts(periods) {
      const row = document.getElementById('forecastRow');
      row.innerHTML = '';
      periods.forEach((per, idx) => {
        const iconUrl = getIconW(per.weather);
        const dayStr = new Date(per.dateTimeISO).toLocaleDateString("en-NZ",{weekday:"short",day:"numeric"});
        let advice = (per.weather && per.weather.toLowerCase().includes("rain")) ? "Rain likely, take a jacket." : "Settled conditions.";
        const card = document.createElement('div');
        card.className = 'forecast-card';
        card.tabIndex = 0;
        card.setAttribute('aria-label', `${dayStr} forecast`);
        card.innerHTML = `
          <div class="forecast-day">${dayStr}</div>
          <img class="forecast-icon" src="${iconUrl}" alt="icon"/>
          <div class="forecast-summary">${per.weather||""}</div>
          <div class="forecast-temps">${(per.minDewpointC||"–")}–${(per.maxDewpointC||"–")}&deg;C dew</div>
          <div class="forecast-rain">Rain: ${(per.precipMM||0).toFixed(1)} mm</div>
          <div class="forecast-advice">${advice}</div>
        `;
        card.onclick = () => showForecastDetails(per, advice);
        row.appendChild(card);
      });
    }

    // Popup modal for detailed forecast
    function showForecastDetails(per, advice) {
      const modalBg = document.getElementById('modalBg');
      const popup = document.getElementById('modalPopup');
      popup.innerHTML = `
        <button class="modal-close-btn" onclick="closeModal()">&times;</button>
        <div class="modal-header">${new Date(per.dateTimeISO).toLocaleDateString("en-NZ",{weekday:"long",day:"numeric",month:"long"})}</div>
        <div class="modal-details">
          <img class="forecast-icon" src="${getIconW(per.weather)}" alt="icon"/>
          <b>${per.weather}</b><br>
          Precip: ${(per.precipMM||0).toFixed(1)} mm<br>
          Dew Point Min/Max: ${(per.minDewpointC||"–")}&deg;C / ${(per.maxDewpointC||"–")}&deg;C<br>
          Forecast: <span style="font-size:1.04em;">${advice}</span>
        </div>
      `;
      modalBg.style.display = '';
      setTimeout(()=>popup.querySelector(".modal-close-btn").focus(), 200);
    }
    function closeModal() { document.getElementById('modalBg').style.display = 'none'; }
    document.getElementById('modalBg').onclick = (e) => { if (e.target === document.getElementById('modalBg')) closeModal(); };

    // Render summary/advice using phrases
    function renderAdvice(phrases, cond) {
      let txt = (phrases && phrases.shortMET) || (phrases && phrases.short) || "—";
      // Example: add a warning if temp is low
      if (cond.tempC != null && cond.tempC < 6) txt += " (Frost risk early, dress warmly.)";
      document.getElementById('adviceBlock').innerText = txt;
    }

    // Render marine/tides/swell panel
    function renderMarine(m) {
      if (!m || !m.periods || !Array.isArray(m.periods) || m.periods.length === 0) {
        document.getElementById('marinePanel').innerHTML = "<b>Marine & Tides:</b> Not available";
        return;
      }
      // Show chart/table for next 10 hours
      let out = `<div class="marine-title">Coromandel Tides, Swell & Fishing</div><div style="font-size:0.98em;">Next 10 hours:</div><table style="width:100%;margin:7px 0 5px 0;font-size:0.98em;"><tr><th>Time</th><th>Tide(m)</th><th>Swell(m)</th><th>Wave</th><th>Wind</th></tr>`;
      m.periods.slice(0,10).forEach(per=>{
        out += `<tr>
          <td>${new Date(per.dateTimeISO).toLocaleTimeString("en-NZ",{hour:"2-digit",minute:"2-digit"})}</td>
          <td>${(per.tidesM!=null?per.tidesM.toFixed(2):"—")}</td>
          <td>${(per.significantWaveHeightM!=null?per.significantWaveHeightM.toFixed(2):"—")}</td>
          <td>${per.primaryWaveDir||"–"}<br>${per.primaryWavePeriod||"–"}s</td>
          <td>${per.windWaveDir||"–"}<br>${per.windWavePeriod||"–"}s</td>
        </tr>`;
      });
      out += "</table>";
      // Sea temp, surge, best fishing window guess:
      const now = m.periods[0];
      out += `<div style="font-size:1em;margin:6px 0;">Sea temp: ${now.seaSurfaceTemperatureC}°C  &bull;  Surge: ${(now.surgeM||0).toFixed(2)}m  &bull;  Swell: ${now.significantWaveHeightM}m</div>`;
      // Mini fishing advice (e.g. best at high tide or low wind)
      let fishTips = [];
      if (now.tidesM > 0.8) fishTips.push("Incoming/high tide – best fishing period soon.");
      if (now.significantWaveHeightM < 0.7) fishTips.push("Small swell, good for line fishing.");
      if (now.windWaveDir && (now.windWaveDir=="NE"||now.windWaveDir=="E")) fishTips.push("Wind direction ideal for calm in Firth.");
      if (!fishTips.length) fishTips.push("Standard fishing conditions.");
      out += `<div style="font-size:1.01em;color:#0b5d54;margin-top:3px;">${fishTips.join(" ")}</div>`;
      document.getElementById('marinePanel').innerHTML = out;
    }

    // Render sun/moon rise/set
    function renderMoon(m) {
      if (!m || !m.sun || !m.moon) { document.getElementById('moonPanel').innerHTML = ""; return; }
      let sun = m.sun, moon = m.moon;
      let out = `<b>Sunrise:</b> ${new Date(sun.riseISO).toLocaleTimeString("en-NZ",{hour:'2-digit',minute:'2-digit'})}
        <b>&nbsp;&nbsp;Sunset:</b> ${new Date(sun.setISO).toLocaleTimeString("en-NZ",{hour:'2-digit',minute:'2-digit'})}<br>
        <b>Moonrise:</b> ${new Date(moon.riseISO).toLocaleTimeString("en-NZ",{hour:'2-digit',minute:'2-digit'})}
        <b>&nbsp;&nbsp;Moonset:</b> ${new Date(moon.setISO).toLocaleTimeString("en-NZ",{hour:'2-digit',minute:'2-digit'})}<br>
        <b>Moon Phase:</b> ${moon.phase.name} (${moon.phase.illum}% illuminated)`;
      document.getElementById('moonPanel').innerHTML = out;
    }

    window.onload = loadWeatherApp;
  </script>
</body>
</html>