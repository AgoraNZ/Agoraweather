<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>AgoraWeather NZ Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    html, body { background: #181e2a; color: #fff; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
    #main { max-width: 500px; margin: 0 auto; padding: 0 2px 32px 2px; }
    .block { background: #222c40; border-radius: 13px; padding: 13px 9px 15px 13px; margin: 18px 0 24px 0; box-shadow: 0 2px 14px #0007; }
    #loc { font-size: 1.13rem; font-weight: 600; margin-bottom: 4px; letter-spacing: 0.01em; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 14px; }
    .temp { font-size: 2.7rem; font-weight: bold; letter-spacing: -0.03em; }
    .icon { width: 58px; height: 58px; }
    .details { font-size: 1.03rem; color: #c8daf7; margin: 10px 0 4px 0; display: flex; flex-wrap: wrap; gap: 12px 18px; }
    .details span { min-width: 44%; }
    .advice-list { margin: 10px 0 0 0; }
    .advice-tip { background: #253e62; color: #ffd25a; border-radius: 7px; font-size: 1.07rem; margin-bottom: 8px; padding: 8px 13px; font-weight: 500; box-shadow: 0 1px 8px #0002; line-height: 1.32; text-align: left; }
    .tabs { display: flex; margin-bottom: 7px; }
    .tab-btn { flex: 1; padding: 9px 0; background: #181e2a; color: #ffe180; border: none; border-radius: 6px 6px 0 0; font-size: 1.08rem; font-weight:600; margin-right:2px; cursor: pointer; }
    .tab-btn.active { background: #ffe180; color: #222c40; }
    #forecast-cards { display: flex; flex-direction: column; gap: 8px; }
    .forecast-card { background: #232f47; border-radius: 9px; padding: 11px 6px 11px 14px; display: flex; align-items: center; gap: 11px; font-size: 1rem; box-shadow: 0 1px 4px #0002; cursor: pointer; }
    .forecast-card .day { font-weight: 600; width: 55px; color: #fff; }
    .forecast-card .ficon { width: 36px; height: 36px; }
    .forecast-card .info { flex: 1 1 0; font-size: 1rem; color: #dde5f3; line-height: 1.25; }
    #rain-block { display:none; }
    #rain-title { font-size: 1.07rem; font-weight: 600; color: #85e7ff; margin-bottom: 8px; }
    #rainChart { width: 100%; min-height: 110px; max-width: 490px; margin-bottom:10px; }
    .rain-summary, .rain-extra { font-size: 0.96rem; color: #ffe180; margin-top: 7px; }
    .rain-extra { color: #aad7ff; }
    .rain-table { width:100%; margin-top:10px; border-spacing:0; }
    .rain-table th, .rain-table td { font-size:0.95rem; padding:2px 6px; }
    .rain-table th { color:#85e7ff; text-align:left; }
    .rain-table td { color:#dde5f3; }
    .wettest { color:#8ae995; font-weight:600; }
    .driest  { color:#fddbdb; font-weight:600; }
    /* Popup */
    #popup-bg { position: fixed; z-index: 9999; inset:0; background: rgba(10,18,36,0.95); display:none; align-items: center; justify-content: center; }
    #popup { background: #222c40; border-radius: 17px; padding: 22px 15px; color: #fff; max-width: 380px; width:95vw; box-shadow: 0 8px 36px #000c; position: relative; }
    #popup .close { position: absolute; top:7px; right:15px; font-size:2rem; color:#aad7ff; background:none; border:none; cursor:pointer; }
    #popup .pday  { font-size:1.11rem; font-weight:bold; margin-bottom:4px; }
    #popup .pdesc { font-size:1.01rem; color:#ffe180; margin-bottom:7px; }
    #popup .advice-tip { margin:7px 0; }
    .hourly-vert { margin-top:15px; max-height:400px; overflow-y:auto; }
    .hour-block { background:#181e2a; border-radius:7px; padding:9px 7px; margin-bottom:7px; display:flex; align-items:center; gap:12px; }
    .htime  { font-size:1.06rem; color:#ffe180; font-weight:600; width:50px; }
    .hicon  { width:32px; height:32px; }
    .htemp  { font-size:1.08rem; font-weight:600; width:40px; }
    .hrow   { font-size:0.98rem; color:#dde5f3; flex:1; display:flex; flex-wrap:wrap; gap:4px; }
    @media (max-width:600px){
      #main { padding:0 1px; }
      .block { padding:10px 3px 12px 7px; }
      .forecast-card .day { width:38px; }
      #popup { padding:13px 2px; }
    }
  </style>
</head>
<body>
<div id="main">
  <div class="block" id="current">
    <div id="loc">Loading location…</div>
    <div class="row">
      <span class="temp" id="temp">--°C</span>
      <img id="icon" class="icon" src="" alt="" />
    </div>
    <div class="details" id="details"></div>
    <div class="advice-list" id="advice-list"></div>
  </div>

  <div class="block">
    <div class="tabs">
      <button class="tab-btn active" id="forecastTab" onclick="showTab('forecast')">Forecast</button>
      <button class="tab-btn" id="rainTab"     onclick="showTab('rain')">Rain History</button>
    </div>
    <div id="forecast" style="display:flex;flex-direction:column;gap:8px;"></div>
    <div id="rain-block">
      <div id="rain-title">Rainfall History (mm)</div>
      <canvas id="rainChart"></canvas>
      <div class="rain-summary" id="rain-summary"></div>
      <div class="rain-extra"   id="rain-extra"></div>
      <table class="rain-table" id="rain-table"></table>
    </div>
  </div>
</div>

<div id="popup-bg">
  <div id="popup"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // === Helpers ===
  const weatherIcons = ic => ic ? `https://cdn.aerisapi.com/wxblox/icons/${ic}.png` : '';
  const dayOfWeek   = d => new Date(d).toLocaleDateString('en-NZ',{weekday:'short'});
  const cap         = s => s ? s[0].toUpperCase()+s.slice(1) : '';

  function showTab(tab){
    document.getElementById('forecast').style.display = tab==='forecast' ? 'flex' : 'none';
    document.getElementById('rain-block').style.display = tab==='rain'     ? 'block' : 'none';
    document.getElementById('forecastTab').classList.toggle('active', tab==='forecast');
    document.getElementById('rainTab').    classList.toggle('active', tab==='rain');
  }

  // Popup
  function closePopup(){ document.getElementById('popup-bg').style.display='none'; }

  function openPopup(day, periods){
    let todayIdx = periods.findIndex(p=>dayOfWeek(p.dateTimeISO)===day);
    let dayNum   = new Date(periods[todayIdx].dateTimeISO).getDay();
    let hours    = periods.filter(p=>new Date(p.dateTimeISO).getDay()===dayNum);
    let advice   = aiAdvice({
      ...periods[todayIdx],
      month: (new Date(periods[todayIdx].dateTimeISO)).getMonth()+1,
      feelslike:periods[todayIdx].feelslikeC||periods[todayIdx].tempC
    });

    let html = `<button class="close" onclick="closePopup()">&times;</button>
      <div class="pday">${day}, ${new Date().toLocaleDateString('en-NZ')}</div>
      <div class="pdesc">${cap(periods[todayIdx].weather||'')}</div>
      ${advice.map(t=>`<div class="advice-tip">${t}</div>`).join('')}
      <div class="hourly-vert">` +
      hours.map(h => 
        `<div class="hour-block">
           <div class="htime">${("0"+new Date(h.dateTimeISO).getHours()).slice(-2)}:00</div>
           <img class="hicon" src="${weatherIcons(h.icon)}" alt=""/>
           <div>
             <div class="htemp">${Math.round(h.tempC||0)}°C</div>
             <div class="hrow">
               Wind ${Math.round(h.windSpeedKPH||0)}km/h&nbsp;|&nbsp;
               Rain ${h.precipMM||0}mm&nbsp;|&nbsp;
               Hum ${h.humidity||0}%<br>
               UV ${h.uvIndex||'--'}&nbsp;|&nbsp;
               Vis ${Math.round(h.visibilityKM||0)}km
             </div>
           </div>
         </div>`
      ).join('') +
      `</div>`;
    let pop = document.getElementById('popup');
    pop.innerHTML = html;
    document.getElementById('popup-bg').style.display='flex';
  }

  // AI Advice (your original logic)
  function aiAdvice(d){
    let out=[],a=[];
    if(!d.weather) return ['No advice'];
    if(d.precip>=25) a.push("Very heavy rain – check for flooding.");
    else if(d.precip>=10) a.push("Bring waterproofs – showers likely.");
    if(d.uv>=7) a.push("High UV – slip, slop, slap.");
    if(d.temp<=0) a.push("Below freezing – watch for black ice.");
    if(d.wind>=50) a.push("Strong winds – secure loose items.");
    if(d.month>=6&&d.month<=8) a.push("Winter: layer up and heat home.");
    if(d.month<=2||d.month>=12) a.push("Summer: stay hydrated & use sunscreen.");
    a.push("Weather changes fast – check again before heading out.");
    return a.slice(0,3);
  }

  // Get geolocation
  function getLocation(){
    return new Promise(res=>{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
          res({lat:p.coords.latitude,lon:p.coords.longitude});
        },_=>res(null),{timeout:7000});
      } else res(null);
    });
  }

  // === Main ===
  (async()=>{
    const coords = await getLocation();
    const useCoords = coords ? `${coords.lat},${coords.lon}` : null;
    const base = 'https://data.api.xweather.com';
    const auth = 'client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';

    // --- Current ---
    const curUrl = useCoords
      ? `${base}/conditions/${useCoords}?format=json&plimit=1&filter=1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.feelslikeC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,periods.weather,periods.icon,periods.precipMM,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&${auth}`
      : `${base}/conditions/:auto?format=json&plimit=1&filter=1min&fields=periods.tempC,periods.feelslikeC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,periods.weather,periods.icon,periods.precipMM,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&${auth}`;
    let cur = await fetch(curUrl).then(r=>r.json()).catch(()=>null);
    let p   = cur?.success ? cur.response[0].periods[0] : {};
    let loc = coords
      ? (cur.response[0].loc.city||cur.response[0].loc.region||'Your Area')
      : 'Your Area';
    document.getElementById('loc').textContent = loc;
    // fill details
    const details = [
      `Feels: ${p.feelslikeC!=null?Math.round(p.feelslikeC)+'°C':'--'}`,
      `Humidity: ${p.humidity!=null?p.humidity+'%':'--'}`,
      `Wind: ${p.windDir? p.windDir+' '+Math.round(p.windSpeedKPH||0)+'km/h':'--'}`,
      `Gusts: ${p.windGustKPH!=null?Math.round(p.windGustKPH)+'km/h':'--'}`,
      `Pressure: ${p.pressureMB!=null?Math.round(p.pressureMB)+'hPa':'--'}`,
      `Dew Pt: ${p.dewpointC!=null?Math.round(p.dewpointC)+'°C':'--'}`,
      `Visibility: ${p.visibilityKM!=null?Math.round(p.visibilityKM)+'km':'--'}`,
      `Cloud: ${p.cloudsCoded?parseInt(p.cloudsCoded.replace(/\D/g,''))+'%':'--'}`,
      `UV: ${p.uvIndex!=null?p.uvIndex:'--'}`,
      `Sunrise: ${p.sunriseISO?new Date(p.sunriseISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):'--'}`,
      `Sunset: ${p.sunsetISO?new Date(p.sunsetISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):'--'}`
    ];
    document.getElementById('details').innerHTML = details.map(d=>`<span>${d}</span>`).join('');
    document.getElementById('icon').src = weatherIcons(p.icon);
    document.getElementById('temp').textContent = p.tempC!=null?Math.round(p.tempC)+'°C':'--';

    // AI Advice
    document.getElementById('advice-list').innerHTML = aiAdvice({
      weather:p.weather, precip:p.precipMM||0,
      uv:p.uvIndex||0, wind:p.windSpeedKPH||0,
      temp:p.tempC||0, month:(new Date()).getMonth()+1
    }).map(t=>`<div class="advice-tip">${t}</div>`).join('');

    // --- Forecast (7 day) ---
    const fcUrl = useCoords
      ? `${base}/forecasts/${useCoords}?format=json&filter=day&limit=7&fields=periods.dateTimeISO,periods.tempC,periods.maxTempC,periods.minTempC,periods.weather,periods.icon,periods.windSpeedKPH,periods.windDir,periods.windGustKPH,periods.precipMM,periods.humidity,periods.uvIndex&${auth}`
      : `${base}/forecasts/:auto?format=json&filter=day&limit=7&fields=periods.dateTimeISO,periods.tempC,periods.maxTempC,periods.minTempC,periods.weather,periods.icon,periods.windSpeedKPH,periods.windDir,periods.windGustKPH,periods.precipMM,periods.humidity,periods.uvIndex&${auth}`;
    let fc = await fetch(fcUrl).then(r=>r.json()).catch(()=>null);
    let days = fc?.success ? fc.response[0].periods : [];
    document.getElementById('forecast').innerHTML = '';
    days.forEach(d=>{
      let c = document.createElement('div');
      c.className = 'forecast-card';
      c.innerHTML = `
        <div class="day">${dayOfWeek(d.dateTimeISO)}</div>
        <img class="ficon" src="${weatherIcons(d.icon)}"/>
        <div class="info">
          <div><b>${cap(d.weather)}</b></div>
          <div>${Math.round(d.maxTempC)}/${Math.round(d.minTempC)}°C</div>
          <div>Wind ${d.windDir} ${Math.round(d.windSpeedKPH)}km/h, Gusts ${Math.round(d.windGustKPH)}km/h</div>
          <div>Rain ${d.precipMM}mm • Hum ${d.humidity}%</div>
        </div>`;
      c.onclick = ()=>openPopup(dayOfWeek(d.dateTimeISO), days);
      document.getElementById('forecast').append(c);
    });

    // --- Rain history ---
    if(useCoords){
      let r7  = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&past_days=7&daily=precipitation_sum&timezone=auto`).then(r=>r.json()).catch(()=>null);
      let r30 = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&past_days=30&daily=precipitation_sum&timezone=auto`).then(r=>r.json()).catch(()=>null);
      let r365= await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&past_days=365&daily=precipitation_sum&timezone=auto`).then(r=>r.json()).catch(()=>null);

      let w7  = r7?.daily?.precipitation_sum||[];
      let t7  = w7.reduce((a,b)=>a+b,0).toFixed(1);
      let t30 = (r30?.daily?.precipitation_sum||[]).reduce((a,b)=>a+b,0).toFixed(1);
      let ytd = (r365?.daily?.precipitation_sum||[]).reduce((a,b)=>a+b,0).toFixed(1);

      document.getElementById('rain-summary').innerHTML = `
        Week: <b>${t7} mm</b> | Month: <b>${t30} mm</b> | YTD: <b>${ytd} mm</b>`;

      let labels = r7.daily.time.map(d=>d.substr(5));
      new Chart(document.getElementById('rainChart').getContext('2d'),{
        type:'bar',
        data:{ labels, datasets:[{ label:'Rain', data:w7, backgroundColor:'#85e7ff' }]},
        options:{ plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
      });

      // table
      let table = '<tr><th>Date</th><th>Rain</th></tr>';
      r7.daily.time.forEach((d,i)=>{
        let v = w7[i];
        table += `<tr><td>${d.substr(5)}</td><td>${v.toFixed(1)}</td></tr>`;
      });
      document.getElementById('rain-table').innerHTML = table;
    } else {
      document.getElementById('rain-summary').textContent = 'Enable location for rain history';
    }
  })();
</script>
</body>
</html>