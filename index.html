<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NZ AI Weather | Paeroa Station</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1163/1163661.png" />
  <meta name="theme-color" content="#006699" />
  <style>
    :root {
      --main: #006699;
      --accent: #ffcc00;
      --danger: #d11d1d;
      --light: #fff;
      --bg: #f6faff;
      --shadow: 0 2px 10px 0 #0001;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: #111;
      font-family: "Segoe UI", Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: var(--main);
      color: var(--light);
      padding: 1.2em 1em 1em 1em;
      text-align: center;
      box-shadow: var(--shadow);
    }
    header h1 { margin: 0; font-size: 2.1em; letter-spacing: 0.02em;}
    header .station {
      font-size: 1.2em;
      margin-top: .25em;
      font-weight: 400;
      letter-spacing: 0.01em;
      opacity: 0.85;
    }
    .container { width: 100%; max-width: 480px; margin: auto; padding: 1em 0 3em 0; }
    .current {
      background: var(--light);
      border-radius: 1em;
      margin: 1.2em 1em 1em 1em;
      padding: 1.1em 1.2em;
      box-shadow: var(--shadow);
      display: flex; flex-direction: column; align-items: center;
    }
    .current .weather-icon {
      width: 60px; height: 60px;
      margin-bottom: .5em;
    }
    .current .temp-main { font-size: 2.7em; font-weight: 700;}
    .current .feels { font-size: 1em; color: #444; margin-bottom: .2em;}
    .current .desc { font-size: 1.15em; font-weight: 500; margin-bottom: .6em;}
    .current .meta {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 0.9em;
      margin-top: .6em;
    }
    .current .meta span {
      font-size: 0.98em; background: #eef5fb; border-radius: 1em; padding: 0.4em 0.95em;
    }
    .advice-section {
      background: var(--accent);
      color: #333;
      border-radius: 1em;
      margin: 1em 1em 1.5em 1em;
      padding: 1em 1.2em;
      box-shadow: var(--shadow);
      font-size: 1.18em;
      font-weight: 600;
      letter-spacing: 0.01em;
      display: flex;
      align-items: flex-start;
      gap: 1em;
      min-height: 70px;
    }
    .advice-section .advice-icon { font-size: 2em; line-height: 1; }
    .forecast-bar {
      margin: 0.8em 0.2em 0 0.2em;
      display: flex; overflow-x: auto; gap: 0.9em;
      padding-bottom: 0.7em;
      scroll-snap-type: x mandatory;
    }
    .forecast-card {
      min-width: 130px; max-width: 130px;
      background: var(--light);
      border-radius: 0.95em;
      box-shadow: var(--shadow);
      padding: .9em 0.8em;
      display: flex; flex-direction: column; align-items: center; gap: 0.1em;
      cursor: pointer; transition: box-shadow .12s;
      scroll-snap-align: start;
      border: 2px solid transparent;
    }
    .forecast-card:hover, .forecast-card.active {
      box-shadow: 0 3px 18px 0 #00669915;
      border-color: var(--accent);
    }
    .forecast-card img { width: 36px; height: 36px; }
    .forecast-card .date { font-size: 1em; font-weight: 600;}
    .forecast-card .summary { font-size: 1em; opacity: 0.8;}
    .forecast-card .temp { font-size: 1.12em; font-weight: 600;}
    .forecast-card .rain { font-size: 1em; color: #1a58a5;}
    .forecast-card .wind { font-size: 0.96em; color: #3a4e88;}
    .forecast-card .humidity { font-size: 0.96em; color: #444;}
    .details-popup {
      display: none;
      position: fixed; left: 0; top: 0; right: 0; bottom: 0;
      background: #0008; z-index: 2000;
      justify-content: center; align-items: center;
    }
    .details-popup.active { display: flex; }
    .details-content {
      background: var(--light);
      border-radius: 1.1em;
      max-width: 400px; width: 97vw;
      padding: 1.4em 1.1em;
      box-shadow: var(--shadow);
      position: relative;
      animation: popupIn 0.19s;
    }
    @keyframes popupIn {
      from { transform: translateY(30px) scale(0.97); opacity: 0.2;}
      to   { transform: none; opacity: 1;}
    }
    .details-content .close {
      position: absolute; top: 0.7em; right: 1em;
      font-size: 1.7em; color: #888; cursor: pointer;
      transition: color .1s;
    }
    .details-content .close:hover { color: var(--main);}
    .details-content h3 { margin: 0 0 .7em 0; }
    .details-content .popup-row {
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid #e8e8e8;
      padding: 0.4em 0;
      font-size: 1.04em;
    }
    .rain-history {
      margin: 1em 1em 1.5em 1em;
      background: var(--light);
      border-radius: 1em;
      box-shadow: var(--shadow);
      padding: 1.2em 1.1em 1.2em 1.1em;
    }
    .rain-history h2 { font-size: 1.2em; margin: 0 0 0.8em 0; }
    .rain-stats { display: flex; gap: 1.1em; flex-wrap: wrap; }
    .rain-stats span {
      font-size: 1.07em;
      background: #eaf3fa;
      border-radius: .8em;
      padding: .5em 1em;
      min-width: 90px;
      text-align: center;
      margin-bottom: .3em;
    }
    .trend-section {
      margin: 1.2em 1em;
      background: var(--light);
      border-radius: 1em;
      box-shadow: var(--shadow);
      padding: 1em 1.1em;
    }
    .trend-section h2 { font-size: 1.13em; margin: 0 0 0.7em 0;}
    .trend-row {
      display: flex; flex-wrap: wrap; gap: .9em;
      font-size: 1em;
    }
    .trend-row span {
      background: #e7f1f7;
      border-radius: .7em;
      padding: .48em 1em;
    }
    .station-selector {
      margin: 1.2em auto 0 auto;
      max-width: 470px;
      display: flex; align-items: center; justify-content: center; gap: 0.9em;
      flex-wrap: wrap;
    }
    .station-selector label { font-weight: 500;}
    .station-selector select {
      font-size: 1.05em;
      padding: 0.2em 1em;
      border-radius: .7em;
      border: 1px solid #ccc;
      outline: none;
      background: #fafdff;
      cursor: pointer;
    }
    footer {
      margin-top: auto;
      text-align: center;
      color: #666;
      font-size: 1em;
      background: #e0effc;
      padding: .8em 1em;
      border-top: 1px solid #d4e8f5;
      letter-spacing: 0.01em;
    }
    @media (max-width: 600px) {
      .container { padding-bottom: 1.5em; }
      .forecast-bar { gap: 0.5em;}
      .forecast-card { min-width: 110px; max-width: 115px; padding: .8em 0.5em;}
      .rain-stats span, .trend-row span { min-width: 65px; font-size: 0.99em;}
    }
  </style>
</head>
<body>
  <header>
    <h1>Paeroa AI Weather</h1>
    <div class="station">NZ Weather Station: <span id="station-name">Paeroa</span></div>
  </header>

  <div class="station-selector">
    <label for="station">Select Station:</label>
    <select id="station">
      <option value="pws_paeroa">Paeroa</option>
      <!-- Future: add more options here -->
    </select>
  </div>
  
  <main class="container">
    <section id="current" class="current" aria-live="polite"></section>
    <section id="advice" class="advice-section"></section>
    <section>
      <div class="forecast-bar" id="forecast-bar"></div>
    </section>
    <section class="rain-history">
      <h2>Rainfall & History</h2>
      <div class="rain-stats" id="rain-stats"></div>
    </section>
    <section class="trend-section">
      <h2>Trends & Records</h2>
      <div class="trend-row" id="trend-row"></div>
    </section>
  </main>

  <div class="details-popup" id="details-popup">
    <div class="details-content" id="details-content">
      <span class="close" id="popup-close" title="Close">&times;</span>
      <!-- Populated by JS -->
    </div>
  </div>

  <footer>
    &copy; 2025 Agora Weather NZ &mdash; Real Station Data | <span id="version">v1.0</span>
  </footer>
  
  <script>
    // ===== CONFIG =====
    const API_KEY = "DEMO_API_KEY"; // REPLACE with your real API key
    const BASE = "https://data.api.xweather.com";
    // Example endpoints:
    // Forecast:   /forecasts/{station}?apiKey=...
    // Summary:    /conditions/summary/{station}?apiKey=...
    const STATION_MAP = {
      "pws_paeroa": { name: "Paeroa", code: "pws_paeroa" },
      // More stations can be added here
    };
    const version = "1.0";
    document.getElementById('version').textContent = "v" + version;
    
    // ===== STATE =====
    let currentStation = "pws_paeroa";
    let lastForecast = null, lastActual = null;

    // ===== HELPERS =====
    function fmtNum(n, d=1) {
      return n !== undefined && n !== null ? Number(n).toFixed(d) : '‚Äî';
    }
    function fmtDate(dateStr) {
      // ISO to ddd, D MMM
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-NZ', {weekday:'short', day:'numeric', month:'short'});
    }
    function fmtWindDir(deg) {
      const dirs = ["N","NE","E","SE","S","SW","W","NW"];
      return dirs[Math.round(deg/45) % 8];
    }
    function iconUrl(icon) {
      // Assume endpoint returns "icon": "partly_cloudy_day", or a full url
      if (!icon) return '';
      if (icon.startsWith("http")) return icon;
      return `https://assets.xweather.com/icons/v1/${icon}.svg`;
    }

    function getSeason(dt=new Date()) {
      // NZ seasons: Summer = Dec-Feb, Autumn = Mar-May, Winter = Jun-Aug, Spring = Sep-Nov
      const m = dt.getMonth() + 1;
      if (m >=12 || m <=2) return "summer";
      if (m >=3 && m<=5) return "autumn";
      if (m >=6 && m<=8) return "winter";
      return "spring";
    }

    // ===== DATA FETCHERS =====
    async function getWeather(station) {
      // Fetch both forecast and daily actuals in parallel
      const code = STATION_MAP[station].code;
      const forecastUrl = `${BASE}/forecasts/${code}?apiKey=${API_KEY}`;
      const summaryUrl = `${BASE}/conditions/summary/${code}?apiKey=${API_KEY}`;
      const [forecastRes, summaryRes] = await Promise.all([
        fetch(forecastUrl),
        fetch(summaryUrl)
      ]);
      if (!forecastRes.ok || !summaryRes.ok) throw new Error("Failed to fetch weather data");
      const forecast = await forecastRes.json();
      const actual = await summaryRes.json();
      return { forecast, actual };
    }

    // ===== UI RENDERERS =====
    function renderCurrent(actual) {
      // Render the most recent observed data
      const d = actual?.periods?.[0];
      if (!d) return;
      lastActual = d;
      const el = document.getElementById("current");
      el.innerHTML = `
        <img class="weather-icon" src="${iconUrl(d.icon)}" alt="${d.weather || ''}">
        <div class="temp-main">${fmtNum(d.temp)}¬∞C</div>
        <div class="feels">Feels like: ${fmtNum(d.feelslike)}¬∞C</div>
        <div class="desc">${d.weather || '‚Äî'}</div>
        <div class="meta">
          <span>Min: ${fmtNum(d.tempmin)}¬∞</span>
          <span>Max: ${fmtNum(d.tempmax)}¬∞</span>
          <span>Rain: ${fmtNum(d.precip)}mm</span>
          <span>Humidity: ${fmtNum(d.humidity)}%</span>
          <span>Wind: ${fmtNum(d.windspeed)}km/h ${fmtWindDir(d.winddir)}</span>
        </div>
      `;
    }

    function renderAdvice(forecast, actual) {
      // "AI" context-aware NZ advice
      const f = forecast?.periods?.[0], a = actual?.periods?.[0];
      if (!f || !a) return;
      // Example: build advice logic for NZ farm context
      const now = new Date();
      const season = getSeason(now);
      const rain = Number(f.precip || 0), wind = Number(f.windspeed || 0), temp = Number(f.tempmax || 0);
      const humidity = Number(f.humiditymax || 0);
      let tips = [];
      let icon = "üå¶Ô∏è";
      // Season-specific
      if (season === "winter") {
        if (temp < 8) tips.push("Frost risk: Check water troughs early.");
        if (rain > 10) tips.push("Muddy paddocks expected‚Äîconsider moving break fences.");
        if (wind > 35) tips.push("High wind: Watch for wind chill on calves.");
      } else if (season === "summer") {
        if (temp > 27) tips.push("Heat stress possible‚Äîensure shade & water for stock.");
        if (rain < 2) tips.push("Drying out‚Äîrotate paddocks, delay nitrogen.");
      }
      // Weather condition
      if (rain > 20) {
        tips.push("Heavy rain: Plan for run-off, keep drains clear.");
        icon = "üåßÔ∏è";
      } else if (rain > 5) {
        tips.push("Keep an eye on gateways for mud build-up.");
        icon = "üå¶Ô∏è";
      }
      if (wind > 40) tips.push("Secure covers, loose items‚Äîstrong winds forecast.");
      if (humidity > 90 && season === "autumn") tips.push("Facial eczema risk rising‚Äîmonitor pasture.");
      // Compare forecast/actual
      const errRain = Math.abs((f.precip || 0) - (a.precip || 0));
      if (errRain > 10) tips.push("Forecast missed recent rain‚Äîwatch for fast-changing conditions.");
      // Extra
      if (f.weather && f.weather.toLowerCase().includes("fog")) tips.push("Foggy start: Take care on local roads.");
      if (now.getDay() === 0) tips.push("Sunday‚Äîprep for next week‚Äôs work.");
      if (tips.length === 0) { tips.push("No major issues‚Äîcarry on as usual!"); icon = "üå§Ô∏è"; }
      // Compose
      document.getElementById("advice").innerHTML =
        `<span class="advice-icon">${icon}</span><span>${tips.join(" ")}</span>`;
    }

    function renderForecast(forecast) {
      // Show 7 day cards with click-to-details
      const days = forecast?.periods || [];
      const bar = document.getElementById("forecast-bar");
      bar.innerHTML = "";
      days.forEach((day, idx) => {
        const c = document.createElement("div");
        c.className = "forecast-card";
        c.tabIndex = 0;
        c.innerHTML = `
          <div class="date">${fmtDate(day.date)}</div>
          <img src="${iconUrl(day.icon)}" alt="${day.weather}">
          <div class="summary">${day.weather || ''}</div>
          <div class="temp"><b>${fmtNum(day.tempmax)}¬∞</b> / <span>${fmtNum(day.tempmin)}¬∞</span></div>
          <div class="rain">Rain: ${fmtNum(day.precip)}mm</div>
          <div class="wind">Wind: ${fmtNum(day.windspeed)}km/h</div>
          <div class="humidity">Hum: ${fmtNum(day.humiditymax)}%</div>
        `;
        c.onclick = () => showDetails(day, forecast.periods[idx-1], forecast.periods[idx+1]);
        bar.appendChild(c);
      });
    }

    function showDetails(day, prev, next) {
      // Pop up detailed breakdown for selected day (plus previous/next context)
      const el = document.getElementById("details-content");
      let out = `<h3>${fmtDate(day.date)} &ndash; ${day.weather || ''}</h3>`;
      out += `<div class="popup-row"><img src="${iconUrl(day.icon)}" alt="" style="width:42px;height:42px;margin-right:0.6em;">`
      out += `<span><b>${fmtNum(day.tempmax)}¬∞ / ${fmtNum(day.tempmin)}¬∞C</b></span></div>`;
      out += `<div class="popup-row">Feels like: <span>${fmtNum(day.feelslike)}¬∞C</span></div>`;
      out += `<div class="popup-row">Rain: <span>${fmtNum(day.precip)} mm</span></div>`;
      out += `<div class="popup-row">PoP: <span>${fmtNum(day.pop,0)}%</span></div>`;
      out += `<div class="popup-row">Humidity: <span>${fmtNum(day.humiditymax)}%</span></div>`;
      out += `<div class="popup-row">Wind: <span>${fmtNum(day.windspeed)} km/h ${fmtWindDir(day.winddir)}</span></div>`;
      out += `<div class="popup-row">Gusts: <span>${fmtNum(day.windgust)} km/h</span></div>`;
      out += `<div class="popup-row">Dewpoint: <span>${fmtNum(day.dewpoint)}¬∞C</span></div>`;
      out += `<div class="popup-row">Cloud: <span>${fmtNum(day.cloud,0)}%</span></div>`;
      out += `<div class="popup-row">UV: <span>${fmtNum(day.uv,1)}</span></div>`;
      if (prev) out += `<div class="popup-row" style="opacity:.6">Prev day: ${fmtNum(prev.tempmax)}¬∞/${fmtNum(prev.tempmin)}¬∞, Rain: ${fmtNum(prev.precip)}mm</div>`;
      if (next) out += `<div class="popup-row" style="opacity:.6">Next day: ${fmtNum(next.tempmax)}¬∞/${fmtNum(next.tempmin)}¬∞, Rain: ${fmtNum(next.precip)}mm</div>`;
      // Smart daily advice
      out += `<div style="margin-top:.8em; padding:.7em 1em; background:#f5f7dc;border-radius:0.7em;color:#574910;">
        <b>AI Advice:</b> ${genDayAdvice(day)}
      </div>`;
      el.innerHTML = out + `<span class="close" id="popup-close" title="Close">&times;</span>`;
      document.getElementById("details-popup").classList.add("active");
      // Add close handler
      el.querySelector("#popup-close").onclick = () =>
        document.getElementById("details-popup").classList.remove("active");
    }
    document.getElementById("details-popup").onclick = (e) => {
      if (e.target === e.currentTarget) e.currentTarget.classList.remove("active");
    }

    function genDayAdvice(day) {
      // Extra, per-day logic (expandable!)
      let tips = [];
      const temp = Number(day.tempmax || 0), rain = Number(day.precip || 0), wind = Number(day.windspeed || 0);
      const humidity = Number(day.humiditymax || 0), uv = Number(day.uv || 0);
      if (rain > 25) tips.push("Prepare for heavy rain. Check runoff and access ways.");
      if (wind > 45) tips.push("Dangerous wind: avoid work at heights.");
      if (humidity > 92) tips.push("High humidity: check for fungus/disease risk.");
      if (uv > 7) tips.push("High UV: sun protection for all staff.");
      if (temp < 2) tips.push("Possible frost‚Äîcover sensitive crops.");
      if (tips.length === 0) tips.push("Standard conditions‚Äîno special precautions needed.");
      return tips.join(" ");
    }

    function renderRainHistory(actual, trend) {
      const a = actual?.periods?.[0];
      if (!a) return;
      // Compose rain totals, history
      const rs = document.getElementById("rain-stats");
      rs.innerHTML = `
        <span>Today: <b>${fmtNum(a.precip)}mm</b></span>
        <span>7 Days: <b>${fmtNum(trend.rain7)}mm</b></span>
        <span>30 Days: <b>${fmtNum(trend.rain30)}mm</b></span>
        <span>YTD: <b>${fmtNum(trend.rainYTD)}mm</b></span>
        <span>Wettest: <b>${fmtNum(trend.wettest)}mm</b></span>
        <span>Driest: <b>${fmtNum(trend.driest)}mm</b></span>
      `;
    }
    function renderTrends(trend) {
      // Show max/min temps, rain streaks, etc.
      const el = document.getElementById("trend-row");
      el.innerHTML = `
        <span>High: ${fmtNum(trend.high)}¬∞C</span>
        <span>Low: ${fmtNum(trend.low)}¬∞C</span>
        <span>Wettest Day: ${fmtNum(trend.wettest)}mm</span>
        <span>Driest Day: ${fmtNum(trend.driest)}mm</span>
        <span>Rain Events: ${trend.rainEvents || '‚Äî'}</span>
      `;
    }

    // ======= TRENDS (Calculated) =======
    function calculateTrends(history) {
      // history: array of past day actuals (fetched in a real deployment, or just last 30 from localStorage)
      let rain7=0, rain30=0, rainYTD=0, high=-99, low=99, wettest=0, driest=999, rainEvents=0;
      const today = new Date();
      for (const day of history) {
        const dt = new Date(day.date);
        const yearMatch = dt.getFullYear() === today.getFullYear();
        if (dt >= addDays(today, -6)) rain7 += Number(day.precip||0);
        if (dt >= addDays(today, -29)) rain30 += Number(day.precip||0);
        if (yearMatch) rainYTD += Number(day.precip||0);
        if (day.tempmax > high) high = day.tempmax;
        if (day.tempmin < low) low = day.tempmin;
        if (day.precip > wettest) wettest = day.precip;
        if (day.precip < driest) driest = day.precip;
        if ((day.precip||0) > 2) rainEvents++;
      }
      return { rain7, rain30, rainYTD, high, low, wettest, driest, rainEvents };
    }
    function addDays(d, n) {
      let dd = new Date(d); dd.setDate(dd.getDate()+n); return dd;
    }

    // ====== LOCAL STORAGE: Store last 30 daily summaries for learning/self-correction =====
    function saveActualSummary(actual) {
      const storeKey = "paeroa_actual_history";
      let history = [];
      try { history = JSON.parse(localStorage.getItem(storeKey)) || []; } catch {}
      // Add today's actual (overwrite if already present for today)
      const today = (actual?.periods?.[0]?.date || '').split('T')[0];
      if (!today) return;
      history = history.filter(d => !d.date.startsWith(today));
      history.unshift(actual.periods[0]);
      if (history.length > 60) history = history.slice(0,60); // Keep only 2 months
      localStorage.setItem(storeKey, JSON.stringify(history));
      return history;
    }
    function loadActualHistory() {
      const storeKey = "paeroa_actual_history";
      try { return JSON.parse(localStorage.getItem(storeKey)) || []; }
      catch { return []; }
    }

    // ===== INIT & EVENTS =====
    async function refresh() {
      try {
        document.getElementById("current").innerHTML = "<em>Loading current conditions...</em>";
        document.getElementById("advice").innerHTML = "<em>Loading advice...</em>";
        document.getElementById("forecast-bar").innerHTML = "";
        document.getElementById("rain-stats").innerHTML = "";
        document.getElementById("trend-row").innerHTML = "";

        const data = await getWeather(currentStation);
        lastForecast = data.forecast;
        lastActual = data.actual;

        renderCurrent(lastActual);
        renderForecast(lastForecast);
        renderAdvice(lastForecast, lastActual);

        // Save today's actual, then calculate trends using all available history
        const hist = saveActualSummary(lastActual) || [];
        const trend = calculateTrends([...(hist || []), ...(lastForecast?.periods || [])]);
        renderRainHistory(lastActual, trend);
        renderTrends(trend);

      } catch (e) {
        document.getElementById("current").innerHTML = "<span style='color:var(--danger)'>Error loading weather.</span>";
        document.getElementById("advice").innerHTML = "";
      }
    }

    // Station selector
    document.getElementById("station").addEventListener("change", (e) => {
      currentStation = e.target.value;
      document.getElementById("station-name").textContent = STATION_MAP[currentStation].name;
      refresh();
    });

    // Initial load
    refresh();
    // Optional: setInterval(refresh, 1000 * 60 * 7); // Auto-refresh every 7 minutes

  </script>
</body>
</html>
