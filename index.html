<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Agora Weather</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <style>
    html, body {
      background: #181e2a;
      color: #fff;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      width: 100vw; height: 100vh;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    #main-container {
      width: 100vw;
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      background: #181e2a;
    }
    #current-block {
      background: #232f47;
      border-radius: 0 0 16px 16px;
      margin: 0;
      padding: 24px 16px 14px 16px;
      box-shadow: 0 1px 7px #0006;
      display: flex;
      flex-direction: row;
      align-items: center;
    }
    .current-icon {
      width: 70px; height: 70px;
      margin-right: 18px;
      background: none;
      border-radius: 10px;
    }
    .current-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .temp-main {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 2px;
      letter-spacing: 0.01em;
      display: flex;
      align-items: flex-end;
      gap: 12px;
    }
    .feelslike {
      font-size: 1.01rem;
      color: #ffd25a;
      font-weight: 500;
    }
    .summary {
      font-size: 1.16rem;
      color: #e4e6f0;
      font-weight: 600;
      margin-top: 1px;
      margin-bottom: 1px;
      text-shadow: 0 1px 6px #0003;
    }
    .cur-details {
      display: flex; flex-wrap: wrap;
      gap: 14px 18px;
      margin-top: 6px;
      font-size: 0.98rem;
    }
    .cur-detail {
      color: #aad7ff;
      min-width: 88px;
    }
    .ai-advice-box {
      background: #253e62;
      color: #ffd25a;
      border-radius: 8px;
      font-size: 1.08rem;
      margin: 10px 0 2px 0;
      padding: 8px 15px;
      font-weight: 600;
      box-shadow: 0 1px 7px #0002;
      line-height: 1.3;
      text-align: left;
      word-break: break-word;
    }
    #forecast-title {
      padding: 14px 0 0 16px;
      font-size: 1.14rem;
      font-weight: bold;
      color: #ffd25a;
      letter-spacing: 0.03em;
    }
    #forecast-block {
      display: flex;
      flex-direction: row;
      gap: 11px;
      overflow-x: auto;
      padding: 7px 0 18px 10px;
      scroll-snap-type: x mandatory;
    }
    .forecast-card {
      background: #232f47;
      border-radius: 13px;
      box-shadow: 0 1px 6px #0005;
      padding: 12px 10px 11px 10px;
      min-width: 110px;
      max-width: 140px;
      flex: 1 0 110px;
      margin-bottom: 3px;
      margin-right: 1px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      scroll-snap-align: start;
      transition: box-shadow 0.12s;
      position: relative;
      user-select: none;
      border: 2px solid #253e62;
    }
    .forecast-card:hover, .forecast-card:active {
      box-shadow: 0 4px 24px #000b;
      background: #283b5c;
      border-color: #ffd25a;
    }
    .f-day {
      font-size: 1.13rem;
      font-weight: 700;
      color: #ffd25a;
      margin-bottom: 1px;
      letter-spacing: 0.02em;
    }
    .f-icon {
      width: 38px; height: 38px;
      margin: 2px 0 7px 0;
      border-radius: 7px;
    }
    .f-summary {
      font-size: 0.96rem;
      color: #e4e6f0;
      margin-bottom: 3px;
      font-weight: 500;
      text-align: center;
      min-height: 18px;
    }
    .f-hi-lo { font-size: 1.03rem; margin-bottom: 0; }
    .f-detail { font-size: 0.97rem; color: #aad7ff; }
    .f-precip { font-size: 0.97rem; color: #85e7ff; }
    /* Popup */
    #popup-bg {
      position: fixed;
      z-index: 99;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20,30,50,0.85);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 16px;
      padding: 26px 22px 16px 22px;
      color: #fff;
      font-size: 1.06rem;
      max-width: 400px;
      min-width: 0;
      width: 97vw;
      box-shadow: 0 8px 32px #000c;
      text-align: left;
      line-height: 1.28;
      position: relative;
      margin: 0 12px;
    }
    #popup-close {
      position: absolute;
      top: 6px;
      right: 16px;
      font-size: 2rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
      padding: 2px 8px;
    }
    #popup-title { font-size: 1.18em; font-weight: bold; margin-bottom: 8px; }
    #popup-summary { font-size: 1.03em; margin-bottom: 4px; color: #ffd25a; }
    #popup-lowhigh, #popup-extra { margin-bottom: 4px; }
    #popup-ai { margin-top: 7px; font-size: 1.01rem; color: #fee680; }
    @media (max-width: 650px) {
      #main-container { max-width: 100vw; }
      #forecast-block { padding-right: 4px; }
      .forecast-card { min-width: 97px; max-width: 135px; }
      #current-block { padding: 17px 6px 11px 6px; }
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <img id="cur-icon" class="current-icon" src="" style="display:none;" alt="" />
      <div class="current-main">
        <div class="temp-main">
          <span id="temp">--°C</span>
          <span class="feelslike" id="feelslike"></span>
        </div>
        <div class="summary" id="weather-text">Loading…</div>
        <div class="cur-details">
          <span class="cur-detail" id="row-humidity">Humidity: --%</span>
          <span class="cur-detail" id="row-wind">Wind: --</span>
          <span class="cur-detail" id="row-gust">Gusts: --</span>
          <span class="cur-detail" id="row-dewpoint">Dew: --</span>
        </div>
        <div class="ai-advice-box" id="todays-advice">Loading today’s advice…</div>
      </div>
    </div>
    <div id="forecast-title">7 Day Forecast</div>
    <div id="forecast-block"></div>
  </div>
  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-summary"></div>
      <div id="popup-lowhigh"></div>
      <div id="popup-extra"></div>
      <div id="popup-ai"></div>
    </div>
  </div>
  <script>
    // --- AI advice for average NZ person (not dairy/farm) ---
    const adviceWeather = [
      { cond: d => d.hail, msg: "⚠ Hail expected. Park your car under cover if possible." },
      { cond: d => d.precip >= 20, msg: "Heavy rain expected. Avoid unnecessary travel and keep an umbrella handy." },
      { cond: d => d.precip >= 5, msg: "Showers likely – don't forget your raincoat or umbrella." },
      { cond: d => d.gust >= 60, msg: "Strong winds forecast. Secure loose outdoor items and watch for falling branches." },
      { cond: d => d.temp >= 28, msg: "Very hot day. Stay hydrated and wear sunscreen outdoors." },
      { cond: d => d.temp <= 0, msg: "Freezing temperatures expected. Beware of icy roads and dress warmly." },
      { cond: d => d.temp < 5, msg: "Very cold weather. Dress in warm layers if you go outside." },
      { cond: d => (d.weather || "").toLowerCase().includes('thunder'), msg: "Thunderstorms possible. Stay indoors during storms if you can." }
    ];
    const adviceSeasonal = [
      { cond: d => [12,1,2].includes(d.month), msg: "Summer: UV levels are high. Wear a hat and sunscreen when outdoors." },
      { cond: d => [3,4,5].includes(d.month), msg: "Autumn: Weather is cooling down. Keep a jacket handy for chilly evenings." },
      { cond: d => [6,7,8].includes(d.month), msg: "Winter: Dress warmly and drive carefully on frosty mornings." },
      { cond: d => [9,10,11].includes(d.month), msg: "Spring: Be ready for changeable weather and sudden showers." }
    ];
    const adviceEveryday = [
      "Keep an umbrella or raincoat handy if rain is in the forecast.",
      "Check the UV index if you’ll be outside for long.",
      "Dress in layers – NZ weather can change quickly.",
      "A quick morning weather check helps plan your clothing and travel.",
      "Wear a hat and sunscreen on sunny days.",
      "Make sure your phone can receive emergency weather alerts.",
      "If driving in heavy rain, turn on headlights and keep a safe distance.",
      "It's wise to have a basic emergency kit at home for stormy weather.",
      "In strong winds, bring in or secure outdoor furniture.",
      "During very cold nights, use extra blankets and check your heating.",
      "On hot days, drink plenty of water even if you don’t feel thirsty.",
      "Check on elderly or vulnerable neighbors during extreme weather."
    ];
    function agoraAiAdvice(opts) {
      const now = new Date(opts.dateISO || Date.now());
      const d = {
        temp: opts.temp, humidity: opts.humidity,
        precip: opts.precip, gust: opts.gust || 0,
        month: now.getMonth() + 1,
        weather: opts.weather ? opts.weather : "",
        hail: opts.hail || false
      };
      let advs = [];
      for (let adv of adviceWeather) if (adv.cond(d)) advs.push(adv.msg);
      for (let adv of adviceSeasonal) if (adv.cond(d)) advs.push(adv.msg);
      const hashDay = Math.abs(now.getDate() + (now.getMonth() + 1) * 37);
      advs.push(adviceEveryday[hashDay % adviceEveryday.length]);
      advs = advs.filter((v, i, arr) => arr.indexOf(v) === i).slice(0, 2);
      return advs;
    }
    function iconUrl(icon) {
      return icon ? `https://cdn.aerisapi.com/wxblox/icons/${icon}` : '';
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt || '').charAt(0).toUpperCase() + (txt || '').slice(1);
    }

    // --- Current conditions ---
    fetch('https://data.api.xweather.com/conditions/:auto?format=json&plimit=1&filter=minutelyprecip,1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windDir,periods.weather,periods.feelslikeC&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No current conditions');
        const p = json.response[0].periods[0];
        const hailCurrent = ((p.weather || '')).toLowerCase().includes('hail');
        document.getElementById('temp').textContent = (typeof p.tempC === 'number') ? `${Math.round(p.tempC)}°C` : '--°C';
        document.getElementById('feelslike').textContent = (p.feelslikeC != null) ? `Feels like: ${Math.round(p.feelslikeC)}°C` : '';
        const icon = p.icon || '';
        const icElem = document.getElementById('cur-icon');
        if (icon) { icElem.src = iconUrl(icon); icElem.style.display = ''; }
        else { icElem.style.display = 'none'; }
        document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';
        document.getElementById('row-humidity').textContent = (p.humidity != null ? `Humidity: ${p.humidity}%` : 'Humidity: --%');
        document.getElementById('row-wind').textContent = (p.windSpeedKPH != null ?
          `Wind: ${p.windDir ? p.windDir + ' ' : ''}${Math.round(p.windSpeedKPH)} km/h` : 'Wind: --');
        document.getElementById('row-gust').textContent = (p.windGustKPH != null ? `Gusts: ${Math.round(p.windGustKPH)} km/h` : 'Gusts: --');
        document.getElementById('row-dewpoint').textContent = (p.dewpointC != null ? `Dew: ${Math.round(p.dewpointC)}°C` : 'Dew: --');
        document.getElementById('todays-advice').textContent = agoraAiAdvice({
          temp: p.tempC, humidity: p.humidity, gust: p.windGustKPH,
          precip: p.precipMM, weather: p.weather, hail: hailCurrent, dateISO: p.dateTimeISO
        }).join(' ');
        document.getElementById('current-block').onclick = () => openPopup({
          title: "Current Conditions",
          summary: capitalize(p.weather || ''),
          lowhigh: document.getElementById('feelslike').textContent,
          extra:
            `${document.getElementById('row-humidity').textContent}<br>` +
            `${document.getElementById('row-wind').textContent}<br>` +
            `${document.getElementById('row-gust').textContent}<br>` +
            `${document.getElementById('row-dewpoint').textContent}`,
          ai: agoraAiAdvice({
            temp: p.tempC, humidity: p.humidity, gust: p.windGustKPH,
            precip: p.precipMM, weather: p.weather, hail: hailCurrent, dateISO: p.dateTimeISO
          }).join('<br>')
        });
      });

    // --- Forecast block (7 days) ---
    fetch('https://data.api.xweather.com/forecasts/:auto?format=json&plimit=8&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.dewpointC,periods.summary&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No forecast');
        const fc = json.response[0].periods || [];
        const fcDom = document.getElementById('forecast-block');
        fcDom.innerHTML = "";
        for (let i = 0; i < fc.length && i < 7; ++i) {
          const p = fc[i];
          const hail = ((p.weather || '') + ' ' + (p.summary || '')).toLowerCase().includes('hail');
          const advices = agoraAiAdvice({
            temp: p.tempC || p.maxTempC, humidity: p.humidity, gust: p.windGustKPH,
            precip: p.precipMM, weather: p.weather, hail: hail, dateISO: p.dateTimeISO
          });
          fcDom.innerHTML += `
            <div class="forecast-card" tabindex="0" onclick="openPopup({
              title: '${dayOfWeek(p.dateTimeISO)}',
              summary: '${capitalize(p.summary || p.weather || '')}',
              lowhigh: 'High: ${p.maxTempC != null ? Math.round(p.maxTempC) + '°C' : '--°C'}<br>Low: ${p.minTempC != null ? Math.round(p.minTempC) + '°C' : '--°C'}',
              extra: 'Humidity: ${p.humidity != null ? p.humidity + '%' : '--%'}<br>' +
                     'Wind: ${p.windDir ? p.windDir + ' ' : ''}${p.windSpeedKPH != null ? Math.round(p.windSpeedKPH) + ' km/h' : '--'}<br>' +
                     'Gusts: ${p.windGustKPH != null ? Math.round(p.windGustKPH) + ' km/h' : '--'}<br>' +
                     'Dew: ${p.dewpointC != null ? Math.round(p.dewpointC) + '°C' : '--'}<br>' +
                     'Rain: ${p.precipMM != null ? p.precipMM + ' mm' : '0 mm'}',
              ai: \`${advices.join('<br>')}\`
            })">
              <div class="f-day">${dayOfWeek(p.dateTimeISO)}</div>
              <img class="f-icon" src="${iconUrl(p.icon)}" alt="" />
              <div class="f-summary">${capitalize(p.weather || '')}</div>
              <div class="f-hi-lo">High: ${p.maxTempC != null ? Math.round(p.maxTempC) + '°C' : '--°C'}<br>Low: ${p.minTempC != null ? Math.round(p.minTempC) + '°C' : '--°C'}</div>
              <div class="f-detail">Wind: ${p.windDir ? p.windDir + ' ' : ''}${p.windSpeedKPH != null ? Math.round(p.windSpeedKPH) + ' km/h' : '--'}</div>
              <div class="f-precip">Rain: ${p.precipMM || 0} mm</div>
            </div>
          `;
        }
      });

    function openPopup(opts) {
      document.getElementById('popup-title').textContent = opts.title || "";
      document.getElementById('popup-summary').textContent = opts.summary || "";
      document.getElementById('popup-lowhigh').innerHTML = opts.lowhigh || "";
      document.getElementById('popup-extra').innerHTML = opts.extra || "";
      document.getElementById('popup-ai').innerHTML = opts.ai || "";
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    document.getElementById('popup-bg').onclick = (e) => {
      if (e.target === e.currentTarget) closePopup();
    };
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePopup();
    });
  </script>
</body>
</html>
