<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Paeroa AI Weather – NZ Smart Farm Forecast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="The smartest, most local, and accurate NZ farm weather app – always up-to-date with Paeroa station data."/>
  <style>
    /* Base & Layout */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: #f4f7fb;
      color: #11223a;
    }
    .app-container {
      max-width: 480px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 6px 20px #bbc4d380;
      padding: 0 0 20px 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: linear-gradient(90deg, #3058a7 65%, #31bce3 100%);
      color: #fff;
      padding: 32px 24px 18px 24px;
      border-radius: 0 0 26px 26px;
      text-align: left;
      box-shadow: 0 2px 10px #3058a720;
    }
    .main-title {
      font-size: 2.1rem;
      margin-bottom: 5px;
      font-weight: bold;
      letter-spacing: -0.5px;
    }
    .sub-title {
      font-size: 1.03rem;
      font-weight: 400;
      opacity: 0.92;
      margin-bottom: 0;
    }
    /* Location selector */
    .station-select-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      margin-bottom: 10px;
    }
    select, button {
      font-size: 1rem;
      padding: 5px 10px;
      border-radius: 6px;
      border: 1px solid #3058a7;
      margin-right: 8px;
      background: #f4f7fb;
      color: #1c293a;
      font-family: inherit;
    }
    select:disabled {
      background: #e6eaf3;
      color: #888;
    }
    /* Current conditions */
    .current-block {
      margin: 16px 20px 0 20px;
      padding: 18px 14px;
      border-radius: 12px;
      background: #eaf3fa;
      box-shadow: 0 2px 10px #cad8e850;
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .current-icon {
      width: 64px;
      height: 64px;
      object-fit: contain;
      background: #fff;
      border-radius: 50%;
      border: 2.5px solid #3058a7;
      padding: 5px;
      box-shadow: 0 0 10px #3058a722;
      margin-right: 8px;
    }
    .current-details {
      flex: 1;
    }
    .current-temp {
      font-size: 2.4rem;
      font-weight: bold;
      margin: 0;
    }
    .feelslike {
      font-size: 1.15rem;
      opacity: 0.72;
      margin-bottom: 2px;
    }
    .current-weather-text {
      font-size: 1.01rem;
      margin-top: 4px;
      color: #32518c;
      font-weight: 500;
    }
    .current-extra {
      font-size: 0.97rem;
      margin-top: 7px;
      opacity: 0.82;
    }
    /* Advice */
    .advice-block {
      margin: 18px 20px 0 20px;
      padding: 13px 16px 14px 16px;
      border-radius: 10px;
      background: #d8ebf7;
      color: #2b475c;
      font-size: 1.13rem;
      font-weight: 500;
      letter-spacing: 0.01em;
      box-shadow: 0 2px 8px #c8e6ff70;
      min-height: 55px;
    }
    /* Forecast cards */
    .forecast-row {
      margin: 22px 0 0 0;
      padding-left: 16px;
      display: flex;
      overflow-x: auto;
      gap: 10px;
      scrollbar-width: thin;
      scrollbar-color: #bbb #eaeaea;
    }
    .forecast-card {
      flex: 0 0 120px;
      background: #f7faff;
      border-radius: 12px;
      box-shadow: 0 2px 7px #aac2e660;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 11px 7px 13px 7px;
      cursor: pointer;
      transition: box-shadow 0.2s;
      border: 2.5px solid transparent;
      min-width: 110px;
      max-width: 130px;
    }
    .forecast-card.selected, .forecast-card:hover {
      border: 2.5px solid #3058a7;
      box-shadow: 0 6px 16px #aac2e688;
      background: #e6f2ff;
    }
    .forecast-icon {
      width: 44px;
      height: 44px;
      margin-bottom: 6px;
      margin-top: 2px;
    }
    .forecast-day {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 2px;
    }
    .forecast-summary {
      font-size: 0.98rem;
      margin-bottom: 5px;
      color: #35518a;
      min-height: 19px;
      text-align: center;
    }
    .forecast-temps {
      font-size: 1.09rem;
      font-weight: 500;
      color: #295680;
      margin-bottom: 1px;
    }
    .forecast-rain {
      font-size: 0.92rem;
      color: #137bb3;
      margin-bottom: 1px;
    }
    /* Popup Modal */
    .modal-bg {
      position: fixed; left:0; top:0; right:0; bottom:0;
      background: #222c3550;
      z-index: 50;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    .modal-popup {
      width: 100%;
      max-width: 470px;
      background: #fff;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 10px 40px #23324c50;
      padding: 24px 22px 22px 22px;
      animation: modalIn 0.3s;
    }
    @keyframes modalIn {
      from { transform: translateY(100px); opacity: 0;}
      to { transform: translateY(0); opacity: 1;}
    }
    .modal-header {
      font-size: 1.32rem;
      font-weight: bold;
      margin-bottom: 7px;
      color: #24456c;
    }
    .modal-close-btn {
      position: absolute;
      top: 18px;
      right: 24px;
      background: none;
      border: none;
      font-size: 1.8rem;
      color: #7c90a4;
      cursor: pointer;
      z-index: 100;
    }
    .modal-details {
      margin-top: 6px;
      font-size: 1.09rem;
      color: #23384c;
    }
    /* Rainfall history panel */
    .rain-panel {
      margin: 24px 20px 0 20px;
      padding: 15px 14px 12px 14px;
      border-radius: 10px;
      background: #ecf8ff;
      color: #24456c;
      box-shadow: 0 2px 8px #c8e6ff40;
      font-size: 1.04rem;
      line-height: 1.37em;
    }
    .rain-label {
      font-weight: 600;
      color: #245ca1;
      margin-bottom: 5px;
      font-size: 1.08rem;
    }
    /* Responsive */
    @media (max-width: 599px) {
      .app-container { box-shadow: none; border-radius: 0;}
      .forecast-row { padding-left: 4px;}
      .modal-popup { border-radius: 22px 22px 0 0; padding: 16px 7px 22px 10px;}
    }
    /* Loader */
    .loader {
      margin: 55px auto 30px auto;
      border: 7px solid #d7e3f5;
      border-top: 7px solid #409ee7;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1.1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0);}
      100% { transform: rotate(360deg);}
    }
    /* Misc */
    .credit {
      text-align: center;
      color: #bbb;
      font-size: 0.97em;
      margin: 32px auto 0 auto;
    }
    .station-select-row label { font-size: 1em; color: #20304a;}
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="main-title">Paeroa Farm Weather</div>
      <div class="sub-title">Smarter, NZ-first, always up-to-date – built on real Paeroa station data</div>
      <div class="station-select-row">
        <label for="stationSelect">Station:</label>
        <select id="stationSelect" disabled>
          <option value="pws_paeroa" selected>Paeroa (Actual Station)</option>
          <!-- For future: populate with available stations -->
        </select>
        <button style="display:none" id="addStationBtn">+ Add Station</button>
      </div>
    </header>

    <div id="loader" class="loader"></div>
    <div id="mainContent" style="display:none;">
      <section>
        <div class="current-block" id="currentBlock">
          <!-- JS inserts current weather -->
        </div>
      </section>
      <section>
        <div class="advice-block" id="adviceBlock">
          <!-- AI advice -->
        </div>
      </section>
      <section>
        <div class="forecast-row" id="forecastRow">
          <!-- Forecast cards -->
        </div>
      </section>
      <section>
        <div class="rain-panel" id="rainPanel">
          <!-- Rainfall history etc -->
        </div>
      </section>
    </div>
    <div id="modalBg" class="modal-bg" style="display:none;">
      <div class="modal-popup" id="modalPopup">
        <!-- Popup content injected by JS -->
      </div>
    </div>
    <div class="credit">
      Powered by live Paeroa station data – 2025. NZ AI Weather App by Agora<br>
    </div>
  </div>
  <script>
    // CONFIG
    const stationId = "pws_paeroa";
    const apiClientId = "U8feQfLlcEfcXDfsWZs4C";
    const apiClientSecret = "HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";

    // URLS
    function getForecastsUrl(station) {
      return `https://data.api.xweather.com/forecasts/${station}?format=json&filter=day&limit=7&fields=periods.dateTimeISO,loc,periods.maxTempC,periods.minTempC,periods.pop,periods.precipMM,periods.maxHumidity,periods.minHumidity,periods.maxDewpointC,periods.minDewpointC,periods.maxFeelslikeC,periods.minFeelslikeC,periods.windSpeedMaxKPH,periods.windSpeedMinKPH,periods.windDirMax,periods.windDirMin,periods.weather&client_id=${apiClientId}&client_secret=${apiClientSecret}`;
    }
    function getSummaryUrl(station) {
      return `https://data.api.xweather.com/conditions/summary/${station}?format=json&fields=loc,periods.dateTimeISO,periods.temp,periods.dewpoint,periods.feelslike,periods.humidity,periods.windSpeed,periods.weather,periods.precip&client_id=${apiClientId}&client_secret=${apiClientSecret}`;
    }

    // ICON MAPPING - Use icon or weather string from API (future: map to SVG if needed)
    function getIconUrl(weatherPhrase) {
      // Use most common phrases (API can include icon path in some endpoints, but fallback if not)
      const mapping = {
        "Mostly Sunny": "https://assets.wx.com/icons/fair.png",
        "Partly Cloudy with Showers": "https://assets.wx.com/icons/pc_shower.png",
        "Cloudy with Showers": "https://assets.wx.com/icons/cloudy_shower.png",
        "Partly Cloudy": "https://assets.wx.com/icons/partlycloudy.png",
        "Cloudy": "https://assets.wx.com/icons/cloudy.png",
        "Sunny": "https://assets.wx.com/icons/sunny.png",
        "Rain": "https://assets.wx.com/icons/rain.png",
        "Showers": "https://assets.wx.com/icons/showers.png",
        "Thunderstorm": "https://assets.wx.com/icons/thunder.png",
        "Snow": "https://assets.wx.com/icons/snow.png",
        "Clear": "https://assets.wx.com/icons/clear.png"
      };
      for (let key in mapping) {
        if (weatherPhrase && weatherPhrase.includes(key)) return mapping[key];
      }
      // Default icon:
      return "https://assets.wx.com/icons/partlycloudy.png";
    }

    // Format date to NZ
    function formatDay(dateISO) {
      const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      let d = new Date(dateISO);
      return days[d.getDay()] + " " + d.getDate();
    }
    function formatFullDate(dateISO) {
      const d = new Date(dateISO);
      return d.toLocaleDateString("en-NZ", {weekday: "long", year: "numeric", month: "long", day: "numeric"});
    }

    // Fetch and render everything
    async function loadWeatherApp() {
      document.getElementById('loader').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
      try {
        const [foreRes, sumRes] = await Promise.all([
          fetch(getForecastsUrl(stationId)),
          fetch(getSummaryUrl(stationId))
        ]);
        const forecastData = await foreRes.json();
        const summaryData = await sumRes.json();
        if (!forecastData.success || !summaryData.success) throw new Error('API Error');
        renderCurrent(summaryData.response[0], forecastData.response[0].periods[0]);
        renderAdvice(summaryData.response[0], forecastData.response[0].periods[0]);
        renderForecasts(forecastData.response[0].periods);
        renderRainPanel(summaryData.response[0], forecastData.response[0].periods);
        document.getElementById('loader').style.display = 'none';
        document.getElementById('mainContent').style.display = '';
      } catch (e) {
        document.getElementById('loader').innerHTML = "Couldn’t load weather data. Try again soon.";
        console.error(e);
      }
    }

    // Render Current Block
    function renderCurrent(actual, todayForecast) {
      const p = actual.periods[0];
      let iconUrl = p.weather && p.weather.icon
        ? `https://assets.wx.com/icons/${p.weather.icon}`
        : getIconUrl(p.weather && p.weather.phrase || todayForecast.weather);
      document.getElementById('currentBlock').innerHTML = `
        <img class="current-icon" src="${iconUrl}" alt="icon"/>
        <div class="current-details">
          <div class="current-temp">${(p.temp && p.temp.avgC != null) ? p.temp.avgC.toFixed(1) + "°C" : "—"}</div>
          <div class="feelslike">Feels like: ${(p.feelslike && p.feelslike.avgC != null) ? p.feelslike.avgC.toFixed(1) + "°C" : "—"}</div>
          <div class="current-weather-text">${(p.weather && p.weather.phrase) ? p.weather.phrase : todayForecast.weather}</div>
          <div class="current-extra">
            Rain: ${(p.precip && p.precip.totalMM != null) ? p.precip.totalMM.toFixed(1) : "—"} mm |
            Humidity: ${(p.humidity && p.humidity.avg != null) ? Math.round(p.humidity.avg) : "—"}% |
            Wind: ${(p.windSpeed && p.windSpeed.avgKPH != null) ? p.windSpeed.avgKPH.toFixed(1) : "—"} km/h
          </div>
        </div>
      `;
    }

    // Render AI Advice (Context-aware, NZ focus)
    function renderAdvice(actual, todayForecast) {
      const now = new Date();
      const month = now.getMonth()+1;
      const hour = now.getHours();
      const p = actual.periods[0];
      const rain = p.precip && p.precip.totalMM || 0;
      const temp = p.temp && p.temp.avgC != null ? p.temp.avgC : todayForecast.maxTempC;
      const humidity = p.humidity && p.humidity.avg || todayForecast.maxHumidity;
      const wind = p.windSpeed && p.windSpeed.avgKPH || todayForecast.windSpeedMaxKPH;
      const weatherText = (p.weather && p.weather.phrase) || todayForecast.weather || "";
      let advice = [];
      // Winter = June-Aug
      if ([6,7,8].includes(month)) {
        if (temp <= 2) advice.push("**Frost risk** this morning, take care at the tanker track & gate.");
        if (rain > 10) advice.push("Wet underfoot. **Mud likely** at gateways, shift break fences early.");
        if (humidity > 97 && temp >= 12 && temp <= 17) advice.push("Facial eczema risk day. Use zinc if cows are on pasture.");
        if (wind > 30) advice.push("**Windy** – check for blown tape and loose sheets in the shed.");
        if (weatherText.includes("Showers") && temp < 7) advice.push("Cold and drizzly – keep calves dry.");
        if (rain === 0 && temp > 12) advice.push("Nice winter day – could be good drying weather for shed rugs.");
      }
      // Spring
      if ([9,10,11].includes(month)) {
        if (rain > 20) advice.push("Another **wet spring day** – watch for pugging and lameness risk.");
        if (humidity > 95 && temp > 15) advice.push("Facial eczema conditions building. Monitor daily.");
        if (wind > 25) advice.push("Strong wind – keep an eye on calf pens.");
        if (temp > 17 && rain === 0) advice.push("Drying day for new grass silage – make the most of it.");
      }
      // Summer
      if ([12,1,2].includes(month)) {
        if (temp > 28) advice.push("**Heat stress** risk for cows. Give extra water and shade if possible.");
        if (rain === 0) advice.push("Dry day – irrigators may be needed if drought persists.");
        if (humidity > 85 && temp > 24) advice.push("Mastitis alert – check cows for clots at milking.");
        if (wind > 22) advice.push("Watch for dehydration in calves, strong wind dries paddocks fast.");
      }
      // Autumn
      if ([3,4,5].includes(month)) {
        if (rain > 15) advice.push("Wet autumn. Check for slips in races and drains overflowing.");
        if (temp < 9 && rain > 0) advice.push("Cold + rain – use covers for autumn-born calves.");
        if (temp > 18 && rain === 0) advice.push("Pasture growing well – plan next round of fertiliser.");
      }
      // Universal
      if (rain > 40) advice.push("Heavy rain event – check all farm drains and floodgates.");
      if (wind > 50) advice.push("**Severe wind warning** – secure gear and shut doors.");
      if (weatherText.includes("Thunderstorm")) advice.push("Thunder risk – unplug sensitive electronics in shed.");
      // Default backup
      if (advice.length === 0) {
        if (rain === 0 && temp > 14 && wind < 15) advice.push("Mild, settled weather. Good day for farm jobs.");
        else if (rain === 0 && temp < 8) advice.push("Chilly but dry. Extra hay for young stock.");
        else if (rain > 0 && rain <= 2) advice.push("Light showers, not much impact expected today.");
        else advice.push("No special advice for today. Keep an eye on the sky!");
      }
      // Add learning/correction mode (future-ready)
      let learnMsg = "";
      try {
        const forecasted = todayForecast.maxTempC;
        if (forecasted && Math.abs(forecasted - temp) > 3)
          learnMsg = " [Forecast correction: Actual max temp off by " + (forecasted - temp).toFixed(1) + "°C today.]";
      } catch {}
      document.getElementById('adviceBlock').innerHTML =
        advice.join("<br>") + (learnMsg ? `<br><span style='color:#c16416;font-size:0.98em;'>${learnMsg}</span>` : "");
    }

    // Render Forecast Cards
    function renderForecasts(periods) {
      const row = document.getElementById('forecastRow');
      row.innerHTML = '';
      periods.forEach((per, idx) => {
        const card = document.createElement('div');
        card.className = 'forecast-card';
        card.tabIndex = 0;
        card.setAttribute('aria-label', formatDay(per.dateTimeISO) + ' forecast');
        card.innerHTML = `
          <div class="forecast-day">${formatDay(per.dateTimeISO)}</div>
          <img class="forecast-icon" src="${getIconUrl(per.weather)}" alt="${per.weather}"/>
          <div class="forecast-summary">${per.weather}</div>
          <div class="forecast-temps">${per.minTempC.toFixed(1)}–${per.maxTempC.toFixed(1)}°C</div>
          <div class="forecast-rain">Rain: ${per.precipMM.toFixed(1)} mm</div>
          <div style="font-size:0.92em;color:#448;">Wind: ${per.windSpeedMaxKPH}km/h</div>
        `;
        card.onclick = () => showForecastDetails(per);
        row.appendChild(card);
      });
    }

    // Modal with Forecast Details
    function showForecastDetails(per) {
      const modalBg = document.getElementById('modalBg');
      const popup = document.getElementById('modalPopup');
      popup.innerHTML = `
        <button class="modal-close-btn" onclick="closeModal()">&times;</button>
        <div class="modal-header">${formatFullDate(per.dateTimeISO)}</div>
        <div class="modal-details">
          <img class="forecast-icon" src="${getIconUrl(per.weather)}" alt="${per.weather}"/>
          <b>${per.weather}</b><br>
          Max/Min Temp: ${per.maxTempC.toFixed(1)}°C / ${per.minTempC.toFixed(1)}°C<br>
          Feels Like: ${per.maxFeelslikeC ? per.maxFeelslikeC.toFixed(1) : "–"}°C<br>
          Dew Point: ${per.maxDewpointC ? per.maxDewpointC.toFixed(1) : "–"}°C<br>
          Wind: ${per.windSpeedMinKPH}–${per.windSpeedMaxKPH} km/h (${per.windDirMin}–${per.windDirMax})<br>
          Humidity: ${per.minHumidity}–${per.maxHumidity}%<br>
          Rainfall: ${per.precipMM.toFixed(1)} mm<br>
          Chance of Rain: ${per.pop}%<br>
          <hr>
          <b>Custom NZ Advice:</b><br>
          <span style="font-size:1.04em;">${getAdviceFromPeriod(per)}</span>
        </div>
      `;
      modalBg.style.display = '';
      // Focus trap for a11y
      setTimeout(()=>popup.querySelector(".modal-close-btn").focus(), 200);
    }
    function closeModal() {
      document.getElementById('modalBg').style.display = 'none';
    }
    document.getElementById('modalBg').onclick = (e) => {
      if (e.target === document.getElementById('modalBg')) closeModal();
    };
    // Reuse advice logic for popups
    function getAdviceFromPeriod(per) {
      // Copy the logic as in renderAdvice, using period fields
      const d = new Date(per.dateTimeISO);
      const month = d.getMonth()+1;
      const rain = per.precipMM;
      const temp = (per.maxTempC + per.minTempC) / 2;
      const humidity = per.maxHumidity;
      const wind = per.windSpeedMaxKPH;
      const weatherText = per.weather;
      let advice = [];
      if ([6,7,8].includes(month)) {
        if (temp <= 2) advice.push("Possible frost, icy tanker track.");
        if (rain > 10) advice.push("Very wet. Mud at break fence likely.");
        if (humidity > 97 && temp >= 12 && temp <= 17) advice.push("Facial eczema day, watch for spores.");
        if (wind > 30) advice.push("Windy – check fences/sheds.");
        if (weatherText.includes("Showers") && temp < 7) advice.push("Drizzly and cold. Extra bedding for calves.");
      }
      if ([9,10,11].includes(month)) {
        if (rain > 20) advice.push("Watch pugging/lameness after heavy spring rain.");
        if (humidity > 95 && temp > 15) advice.push("Facial eczema alert.");
        if (wind > 25) advice.push("Strong wind, check calf pens.");
      }
      if ([12,1,2].includes(month)) {
        if (temp > 28) advice.push("Heat stress day for cows.");
        if (rain === 0) advice.push("Dry, consider irrigating.");
      }
      if ([3,4,5].includes(month)) {
        if (rain > 15) advice.push("Wet – check tracks, drains.");
        if (temp < 9 && rain > 0) advice.push("Cold + wet. Cover young calves.");
      }
      if (rain > 40) advice.push("Heavy rain warning.");
      if (wind > 50) advice.push("Damaging wind gusts possible.");
      if (weatherText.includes("Thunderstorm")) advice.push("Thunder risk, unplug electronics.");
      if (advice.length === 0) advice.push("No special risks.");
      return advice.join("<br>");
    }

    // Render Rainfall history (actual + running totals)
    function renderRainPanel(actual, forecastPeriods) {
      const p = actual.periods[0];
      // Calculate 7d, 30d, YTD by summing forecast and actual (replace with DB/real historical later)
      let rainToday = (p.precip && p.precip.totalMM) || 0;
      let rain7 = 0, rain30 = 0, rainYTD = 0;
      forecastPeriods.forEach((per,i) => {
        if (i < 7) rain7 += per.precipMM;
        rain30 += per.precipMM; // Simulate – replace with DB history in future
        rainYTD += per.precipMM;
      });
      // Simulate totals with fake values for YTD (should be replaced by sum of actuals)
      rainYTD = 856 + rain7; // eg. sum from database or station history
      document.getElementById('rainPanel').innerHTML = `
        <span class="rain-label">Rainfall Totals</span><br>
        Today: <b>${rainToday.toFixed(1)} mm</b><br>
        Last 7 days: <b>${rain7.toFixed(1)} mm</b><br>
        Last 30 days: <b>${rain30.toFixed(1)} mm</b><br>
        Year-to-date: <b>${rainYTD.toFixed(0)} mm</b>
        <br>
        <span style="font-size:0.98em;opacity:0.66;">*7/30 day values use forecast data until full station history is loaded.</span>
      `;
    }

    // Initial load
    window.onload = loadWeatherApp;

    // For demo, station select/add is disabled, but structure is ready for more.
  </script>
</body>
</html>