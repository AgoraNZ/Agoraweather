<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>AgoraWeather NZ – Pro Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    html, body { background: #181e2a; color: #fff; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
    #main { max-width: 500px; margin: 0 auto; padding: 0 2px 32px 2px; }
    .block { background: #222c40; border-radius: 13px; padding: 12px; margin: 14px 0 20px 0; box-shadow: 0 2px 12px #0007; }
    #loc { font-size: 1.13rem; font-weight: 600; margin-bottom: 3px; letter-spacing: 0.01em; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .temp { font-size: 2.6rem; font-weight: bold; letter-spacing: -0.03em; }
    .icon { width: 58px; height: 58px; }
    .details { display: flex; flex-wrap: wrap; gap: 0 15px; }
    .details-col { flex: 1 1 45%; min-width: 120px; font-size: 1.06rem; color: #c8daf7; line-height: 1.44; }
    .advice { background: #253e62; color: #ffd25a; border-radius: 7px; font-size: 1.07rem; margin-top: 9px; padding: 8px 13px; font-weight: 500; box-shadow: 0 1px 8px #0002; line-height: 1.32; text-align: left; word-break: break-word; white-space: normal;}
    #tabs { display: flex; margin: 8px 0 0 0; }
    .tab-btn { flex:1; padding: 11px 0; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 7px 7px 0 0; background: #253e62; color: #ffe180; margin-right: 2px; cursor: pointer; }
    .tab-btn.active { background: #ffe180; color: #222c40; }
    #forecast, #rain-tab { display:none; }
    #forecast.active, #rain-tab.active { display:block; }
    #forecast-title { font-size: 1.05rem; font-weight: 600; margin: 3px 0 8px 3px; color: #ffe180; }
    .forecast-list { display: flex; flex-direction: column; gap: 8px; }
    .forecast-card { background: #232f47; border-radius: 9px; padding: 10px 10px 9px 10px; display: flex; align-items: center; gap: 12px; font-size: 1rem; box-shadow: 0 1px 4px #0002; cursor:pointer; transition:.12s; }
    .forecast-card:hover { background:#2d3964; }
    .forecast-card .day { font-weight: 700; width: 44px; color: #fff; }
    .forecast-card .ficon { width: 36px; height: 36px; }
    .forecast-card .info { flex: 1 1 0; font-size: 1rem; color: #dde5f3; line-height: 1.27; }
    .rain-summary { font-size: 0.98rem; color: #ffe180; margin-top: 10px;}
    #rainChart { width: 100%; min-height: 140px; max-width: 480px; }
    #popup-bg { position:fixed; z-index: 9999; top:0;left:0;right:0;bottom:0;background:rgba(12,20,32,0.95);display:none;align-items:center;justify-content:center;}
    #popup { background: #232f47; border-radius: 13px; box-shadow: 0 3px 22px #000b; max-width: 430px; width:96vw; padding: 19px 14px 18px 14px; font-size: 1.08rem; position:relative;}
    #popup-close {position:absolute;top:16px;right:24px;font-size:2rem;color:#ffe180;background:none;border:none;cursor:pointer;}
    #popup-title { font-size: 1.08rem; font-weight: 600; margin-bottom: 2px;}
    #popup-summary {font-size:1.01rem; color:#ffd25a;margin-bottom:9px;}
    .hourly-list {margin-top:6px;}
    .hour-row {display:flex;align-items:center;gap:7px;padding:7px 2px 6px 2px;border-bottom:1px solid #334155;}
    .hour-row:last-child{border-bottom:none;}
    .hour-row .hicon {width:29px;height:29px;}
    .hour-row .htime {width:62px; font-weight:500;}
    .hour-row .hdesc {flex:1; min-width:70px;}
    .hour-row .htemp {font-weight:600;width:44px;}
    .hour-row .hmeta {font-size:0.97em;color:#a0bacd;}
    @media (max-width:600px){
      #main {padding:0 1px;}
      .block {padding:10px 2px 12px 4px;}
      .forecast-card .day { width:38px;}
      #popup {padding:11px 2px 9px 3px;}
    }
  </style>
</head>
<body>
<div id="main">
  <div class="block" id="current">
    <div id="loc">Loading location…</div>
    <div class="row">
      <span class="temp" id="temp">--°C</span>
      <img id="icon" class="icon" src="" alt=""/>
    </div>
    <div class="details">
      <div class="details-col">
        <div>Feels: <span id="feels">--°C</span></div>
        <div>Humidity: <span id="hum">--%</span></div>
        <div>Wind: <span id="wind">--</span></div>
        <div>Pressure: <span id="pressure">--</span></div>
        <div>Visibility: <span id="vis">--</span></div>
        <div>UV: <span id="uv">--</span></div>
      </div>
      <div class="details-col">
        <div>Gusts: <span id="gust">--</span></div>
        <div>Dew Pt: <span id="dew">--</span></div>
        <div>Cloud: <span id="cloud">--</span></div>
        <div>Sunrise: <span id="sunrise">--</span></div>
        <div>Sunset: <span id="sunset">--</span></div>
      </div>
    </div>
    <div class="advice" id="advice1">Getting advice…</div>
    <div class="advice" id="advice2"></div>
  </div>
  <div id="tabs">
    <button class="tab-btn active" id="tab-forecast" onclick="switchTab('forecast')">Forecast</button>
    <button class="tab-btn" id="tab-rain" onclick="switchTab('rain-tab')">Rain History</button>
  </div>
  <div id="forecast" class="block active">
    <div id="forecast-title">Next 7 days</div>
    <div class="forecast-list" id="forecast-list"></div>
  </div>
  <div id="rain-tab" class="block">
    <div id="rainChartWrap">
      <canvas id="rainChart"></canvas>
    </div>
    <div class="rain-summary" id="rain-summary"></div>
  </div>
</div>
<div id="popup-bg">
  <div id="popup">
    <button id="popup-close" onclick="closePopup()">×</button>
    <div id="popup-title"></div>
    <div id="popup-summary"></div>
    <div id="popup-hourly"></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const iconUrl = icon => icon ? `https://cdn.aerisapi.com/wxblox/icons/${icon}.png` : '';
const cap = s => (s||'').charAt(0).toUpperCase()+(s||'').slice(1);
const dayOfWeek = d => new Date(d).toLocaleDateString('en-NZ', {weekday:'short'});
const timeHHMM = d => new Date(d).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'});
let forecastData = [], hourlyData = {}, locInfo = {};

// Tabs
function switchTab(tab){
  document.getElementById('forecast').classList.remove('active');
  document.getElementById('rain-tab').classList.remove('active');
  document.getElementById('tab-forecast').classList.remove('active');
  document.getElementById('tab-rain').classList.remove('active');
  document.getElementById(tab).classList.add('active');
  document.getElementById('tab-'+tab.split('-')[0]).classList.add('active');
}

// AI Advice function, tailored for NZ
function aiAdvice(d, locName){
  let now = new Date(), month = now.getMonth()+1;
  let a = [];
  if (month>=6 && month<=8) {
    if(d.temp<4) a.push(`Winter: Layer up and beware black ice.`);
    else a.push(`Winter: Cold day ahead in ${locName}, dress warmly.`);
  }
  if (month>=12 || month<=2) {
    if(d.temp>=28) a.push(`Summer heat in ${locName}, stay hydrated.`);
    if(d.uv>=7) a.push(`High UV in ${locName}, apply sunscreen.`);
  }
  if (d.wind>50) a.push(`Strong winds in ${locName}, secure loose outdoor items.`);
  if (d.precip>=20) a.push(`Heavy rain expected in ${locName}, watch for flooding.`);
  if(a.length<2) a.push("NZ: Weather can change rapidly. Check again before heading out.");
  return a.slice(0,2);
}

function getCloudPct(cloudsCoded){
  if(!cloudsCoded) return "--";
  if(/CL/i.test(cloudsCoded)) return "10%";
  if(/SC/i.test(cloudsCoded)) return "35%";
  if(/BK/i.test(cloudsCoded)) return "65%";
  if(/OV/i.test(cloudsCoded)) return "95%";
  return "--";
}

// Get location (fallback to NZ center)
function getNZLocation(cb){
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos){
      cb(pos.coords.latitude, pos.coords.longitude);
    }, function(){
      // Fallback to NZ center (Lake Taupo)
      cb(-38.6857, 176.0702);
    }, {timeout:9000,maximumAge: 1000*60*15});
  } else {
    cb(-38.6857, 176.0702);
  }
}

// MAIN APP
getNZLocation(async (lat, lon)=>{
  let baseURL = 'https://data.api.xweather.com';

  // --- Current weather ---
  let urlCur = `${baseURL}/conditions/${lat},${lon}?format=json&plimit=1&filter=minutelyprecip,1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,periods.weather,periods.icon,periods.feelslikeC,periods.precipMM,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq`;
  let cur = await fetch(urlCur).then(r=>r.json()).catch(()=>null);
  let p = cur && cur.success ? cur.response[0].periods[0] : {};
  let loc = cur && cur.success ? cur.response[0].loc : {};
  let locName = (loc.city||loc.town||loc.region||loc.country||"New Zealand");
  if(loc.region && loc.country && loc.region!==loc.country) locName = loc.region+", "+loc.country;
  document.getElementById('loc').textContent = locName;

  document.getElementById('temp').textContent = p.tempC!=null?Math.round(p.tempC)+'°C':'--°C';
  document.getElementById('icon').src = iconUrl(p.icon);
  document.getElementById('feels').textContent = p.feelslikeC!=null?Math.round(p.feelslikeC)+'°C':'--°C';
  document.getElementById('hum').textContent = p.humidity!=null?p.humidity+'%':'--%';
  document.getElementById('wind').textContent = p.windDir?(p.windDir+' '+(p.windSpeedKPH!=null?Math.round(p.windSpeedKPH)+' km/h':'--')):(p.windSpeedKPH!=null?Math.round(p.windSpeedKPH)+' km/h':'--');
  document.getElementById('pressure').textContent = p.pressureMB!=null?Math.round(p.pressureMB)+' hPa':'--';
  document.getElementById('vis').textContent = p.visibilityKM!=null?Math.round(p.visibilityKM)+' km':'--';
  document.getElementById('uv').textContent = p.uvIndex!=null?p.uvIndex:'--';
  document.getElementById('gust').textContent = p.windGustKPH!=null?Math.round(p.windGustKPH)+' km/h':'--';
  document.getElementById('dew').textContent = p.dewpointC!=null?Math.round(p.dewpointC)+'°C':'--';
  document.getElementById('cloud').textContent = getCloudPct(p.cloudsCoded);
  document.getElementById('sunrise').textContent = p.sunriseISO?timeHHMM(p.sunriseISO):'--';
  document.getElementById('sunset').textContent = p.sunsetISO?timeHHMM(p.sunsetISO):'--';

  let adviceArr = aiAdvice({
    temp:p.tempC||0, uv:p.uvIndex||0, wind:p.windSpeedKPH||0,
    humidity:p.humidity||0, sunrise:p.sunriseISO, sunset:p.sunsetISO,
    precip:p.precipMM||0
  }, locName);
  document.getElementById('advice1').textContent = adviceArr[0]||'';
  document.getElementById('advice2').textContent = adviceArr[1]||'';

  // --- Forecast data (vertical cards) ---
  let urlFc = `${baseURL}/forecasts/${lat},${lon}?format=json&plimit=8&fields=periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.dewpointC,periods.summary,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.sunriseISO,periods.sunsetISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq`;
  let fc = await fetch(urlFc).then(r=>r.json()).catch(()=>null);
  forecastData = (fc && fc.success && fc.response[0].periods) ? fc.response[0].periods : [];
  hourlyData = {}; // filled dynamically

  let list = document.getElementById('forecast-list'); list.innerHTML = "";
  forecastData.slice(0,7).forEach((f,i)=>{
    let card = document.createElement('div'); card.className = 'forecast-card';
    card.innerHTML = `<div class="day">${dayOfWeek(f.dateTimeISO)}</div>
      <img class="ficon" src="${iconUrl(f.icon)}" alt=""/>
      <div class="info">
        <div><b>${cap(f.weather||'')}</b></div>
        <div>${Math.round(f.maxTempC)}/${Math.round(f.minTempC)}°C</div>
        <div>Wind ${f.windDir||''} ${Math.round(f.windSpeedKPH||0)}km/h, Gusts ${Math.round(f.windGustKPH||0)}km/h</div>
        <div>Rain ${f.precipMM||0}mm • Hum ${f.humidity||'--'}%</div>
      </div>`;
    card.onclick = ()=>showHourlyPopup(f, i, lat, lon, locName);
    list.appendChild(card);
  });

  // --- Rain history (7d, 30d, YTD) ---
  let rain7 = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=7&daily=precipitation_sum&timezone=auto`).then(r=>r.json()).catch(()=>null);
  let rain30 = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=30&daily=precipitation_sum&timezone=auto`).then(r=>r.json()).catch(()=>null);
  let rain365 = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=365&daily=precipitation_sum&timezone=auto`).then(r=>r.json()).catch(()=>null);

  let sum = arr=>arr?arr.reduce((a,b)=>a+b,0):0;
  let l7=rain7?.daily?.time?.map((d,i)=>({date:d,precip:rain7.daily.precipitation_sum[i]}))||[];
  let l30=rain30?.daily?.precipitation_sum||[];
  let l365=rain365?.daily?.precipitation_sum||[];
  let weekTotal = sum(l7.map(x=>x.precip));
  let monthTotal = sum(l30);
  let ytdTotal = sum(l365);

  document.getElementById('rain-summary').innerHTML = `
    <b>Past 7 days:</b> ${weekTotal.toFixed(1)} mm<br>
    <b>Past 30 days:</b> ${monthTotal.toFixed(1)} mm<br>
    <b>Year to date:</b> ${ytdTotal.toFixed(1)} mm
  `;

  let ctx = document.getElementById('rainChart').getContext('2d');
  new Chart(ctx, {
    type:'bar',
    data:{labels:l7.map(x=>x.date.substr(5)),datasets:[{label:"Rain (mm)",data:l7.map(x=>x.precip),backgroundColor:'#85e7ff'}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
});

// Pop-up for forecast day (3-hourly breakdown)
async function showHourlyPopup(f, dayIdx, lat, lon, locName){
  let popup = document.getElementById('popup-bg');
  let title = `${dayOfWeek(f.dateTimeISO)}, ${locName}`;
  let adviceArr = aiAdvice({
    temp:f.maxTempC||f.tempC||0, uv:f.uvIndex||0, wind:f.windSpeedKPH||0, humidity:f.humidity||0, sunrise:f.sunriseISO, sunset:f.sunsetISO, precip:f.precipMM||0
  }, locName);

  // Get hourly forecast for this date (in 3-hr steps)
  let dt = new Date(f.dateTimeISO);
  let y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), d=String(dt.getDate()).padStart(2,'0');
  let urlHr = `https://data.api.xweather.com/forecasts/${lat},${lon}?format=json&filter=1hr&fields=periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.uvIndex,periods.visibilityKM,periods.sunriseISO,periods.sunsetISO&from=${y}-${m}-${d}&to=${y}-${m}-${d}&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq`;
  let hr = await fetch(urlHr).then(r=>r.json()).catch(()=>null);
  let hours = hr && hr.success && hr.response[0].periods ? hr.response[0].periods : [];
  // Filter to 3-hour intervals (e.g. 0:00, 3:00, ...)
  let filteredHours = hours.filter(h=>{
    let hh = new Date(h.dateTimeISO).getHours();
    return hh%3===0;
  });

  document.getElementById('popup-title').textContent = title;
  document.getElementById('popup-summary').innerHTML = adviceArr.map(a=>'<div class="advice">'+a+'</div>').join('');
  let hourlyHtml = '';
  if(filteredHours.length){
    hourlyHtml += `<div class="hourly-list">`;
    filteredHours.forEach(h=>{
      hourlyHtml += `
      <div class="hour-row">
        <span class="htime">${timeHHMM(h.dateTimeISO)}</span>
        <img class="hicon" src="${iconUrl(h.icon)}"/>
        <span class="htemp">${h.tempC!=null?Math.round(h.tempC)+'°C':'--'}</span>
        <span class="hdesc">${cap(h.weather||'')}</span>
      </div>
      <div class="hmeta">
        Wind: ${h.windSpeedKPH!=null?Math.round(h.windSpeedKPH)+'km/h':'--'} | Gusts: ${h.windGustKPH!=null?Math.round(h.windGustKPH)+'km/h':'--'}
        | Rain: ${h.precipMM!=null?h.precipMM+'mm':'--'} | Humidity: ${h.humidity!=null?h.humidity+'%':'--'}
        <br>UV: ${h.uvIndex!=null?h.uvIndex:'--'} | Visibility: ${h.visibilityKM!=null?Math.round(h.visibilityKM)+'km':'--'}
        ${h.sunriseISO?('<br>Sunrise: '+timeHHMM(h.sunriseISO)):""}${h.sunsetISO?(' | Sunset: '+timeHHMM(h.sunsetISO)):""}
      </div>`;
    });
    hourlyHtml += "</div>";
  } else {
    hourlyHtml = "<div style='color:#e37'>No hour-by-hour forecast found for this day.</div>";
  }
  document.getElementById('popup-hourly').innerHTML = hourlyHtml;
  popup.style.display='flex';
}

function closePopup(){
  document.getElementById('popup-bg').style.display='none';
}
</script>
</body>
</html>