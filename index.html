<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Agora NZ Weather – Smarter Kiwi Weather App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{margin:0;background:#f4f7fb;font-family:'Segoe UI',Arial,sans-serif;color:#15304b}
  .app-container{max-width:500px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 5px 30px #193a5e18;padding-bottom:34px;min-height:100vh;display:flex;flex-direction:column}
  header{background:linear-gradient(90deg,#18558e 68%,#15b2c1 100%);color:#fff;padding:34px 22px 18px;border-radius:0 0 30px 30px;box-shadow:0 3px 16px #18558e10}
  .main-title{font-size:2.07rem;font-weight:700;letter-spacing:-.5px;margin:0 0 6px}
  .sub-title{font-size:1.02rem;opacity:.95;margin:0}
  .station-select-row{display:flex;align-items:center;gap:9px;margin:14px 0 7px}
  select{font-size:1rem;padding:5px 10px;border-radius:6px;border:1px solid #18558e;background:#f4f7fb;color:#1c293a}

  .current-block{margin:17px 18px 0;padding:17px 11px;border-radius:12px;background:#eaf3fa;box-shadow:0 2px 8px #cad8e850;display:flex;gap:18px}
  .current-left{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:118px}
  .current-icon{width:72px;height:72px;object-fit:contain;background:#fff;border-radius:50%;border:2.5px solid #18558e;padding:8px;box-shadow:0 0 8px #18558e18}
  .current-temp-big{font-size:3rem;font-weight:700;color:#16549b;line-height:1}
  .moon-line{font-size:.94rem;color:#1e406a;text-align:center}
  .current-details{flex:1}
  .current-temp-label{font-size:1.05rem;color:#35526b;margin:-2px 0 8px}
  .current-grid{display:flex;flex-wrap:wrap;margin-top:6px}
  .current-field{width:48%;min-width:160px;font-size:.99rem;margin-bottom:4px}
  .current-label{font-weight:bold;color:#19558e}

  .advice-block{margin:17px 18px 0;padding:12px 14px;border-radius:10px;background:#eaf3ff;box-shadow:0 2px 8px #c8e6ff55;color:#163d64}
  .advice-title{font-weight:700;color:#154a88;margin-bottom:6px}
  .advice-ul{margin:0;padding-left:16px}
  .advice-ul li{margin:4px 0}

  .forecast-row{margin:18px 0 0;padding-left:14px;display:flex;overflow-x:auto;gap:9px;scrollbar-width:thin}
  .forecast-card{flex:0 0 136px;background:#f7faff;border-radius:12px;box-shadow:0 2px 7px #aac2e660;display:flex;flex-direction:column;align-items:center;padding:11px 7px 13px;cursor:pointer;transition:box-shadow .2s;border:2px solid transparent;min-width:110px}
  .forecast-card:hover{border:2.5px solid #18558e;box-shadow:0 6px 16px #aac2e680;background:#e2f3ff}
  .forecast-icon{width:41px;height:41px;margin:2px 0 6px}
  .forecast-day{font-weight:600;font-size:1.01rem;margin-bottom:2px}
  .forecast-summary{font-size:.97rem;margin-bottom:4px;color:#2857a1;min-height:18px;text-align:center}
  .forecast-temps{font-size:1.07rem;font-weight:500;color:#285680;margin-bottom:1px}
  .forecast-rain{font-size:.91rem;color:#0a6899;margin-bottom:0}
  .forecast-moon{font-size:.9rem;color:#1a3e2d;margin-top:2px;min-height:18px}

  .modal-bg{position:fixed;inset:0;background:#23324c45;z-index:50;display:none;align-items:flex-end;justify-content:center}
  .modal-popup{width:100%;max-width:470px;background:#fff;border-radius:22px 22px 0 0;box-shadow:0 10px 40px #23324c70;padding:23px 18px}
  .modal-header{font-size:1.22rem;font-weight:700;margin-bottom:8px;color:#18558e}
  .modal-close-btn{position:absolute;top:18px;right:23px;background:none;border:none;font-size:1.7rem;color:#6c7c8c;cursor:pointer}
  .modal-details{font-size:1.02rem;color:#23415c}
  .hourly-grid{margin-top:10px;border-top:1px solid #e8eef8;padding-top:8px;max-height:420px;overflow:auto}
  .hour-row{display:flex;align-items:center;justify-content:space-between;padding:6px 4px;border-radius:8px}
  .hour-row:nth-child(odd){background:#f5f9ff}
  .h-left{display:flex;align-items:center;gap:10px}
  .h-time{width:58px;color:#0f396e}
  .h-icon{width:28px;height:28px}
  .h-info{font-size:.96rem;color:#123b57}
  .h-meta{font-size:.9rem;color:#0a6899}

  .fish-banner{margin:10px 18px 0;padding:10px 12px;border-radius:10px;background:#eef8f5;color:#18558e;font-weight:600}
  .fishing-panel{margin:25px 18px 0;padding:14px;border-radius:12px;background:#eafaf7;box-shadow:0 2px 7px #bceadd33;color:#18558e;font-size:1.02rem}
  .fish-headline{font-size:1.18rem;font-weight:700;margin-bottom:6px}
  .fish-switch{display:flex;align-items:center;gap:10px;margin:6px 0 10px}
  .switch{position:relative;display:inline-block;width:54px;height:28px}
  .switch input{display:none}
  .slider{position:absolute;cursor:pointer;inset:0;background:#cfeee7;transition:.2s;border-radius:28px}
  .slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;top:3px;background:#fff;transition:.2s;border-radius:50%;box-shadow:0 1px 4px #0003}
  input:checked+.slider{background:#85d7c5}
  input:checked+.slider:before{transform:translateX(26px)}
  .fish-rating{margin-top:4px;font-weight:700}
  .fish-note{font-size:.95em;color:#217b6a;margin-top:2px}
  .tide-table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:.98rem;margin-top:8px}
  .tide-table th{text-align:left;color:#0f5c57;font-weight:700}
  .tide-note{font-size:.92em;color:#2f6d65;margin-top:6px}
  .fish-ico{width:18px;vertical-align:-3px;margin-right:4px}

  .rain-panel{margin:18px 18px 0;padding:12px;border-radius:10px;background:#ecf8ff;color:#15304b;box-shadow:0 2px 8px #c8e6ff40;font-size:1.03rem;line-height:1.35}
  .rain-label{font-weight:600;color:#18558e;margin-bottom:3px;font-size:1.08rem}

  .loader{margin:60px auto 34px;border:7px solid #d7e3f5;border-top:7px solid #0f82c6;border-radius:50%;width:44px;height:44px;animation:spin 1.05s linear infinite}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .credit{text-align:center;color:#b4c2d3;font-size:.96em;margin:31px auto 0}
</style>
</head>
<body>
<div class="app-container">
  <header>
    <div class="main-title">Agora NZ Weather</div>
    <div class="sub-title">Real station data • clear NZ advice</div>
    <div class="station-select-row">
      <label for="stationSelect">Station:</label>
      <select id="stationSelect">
        <!-- value: WU_ID | XW_token | coastPreset | xwMode -->
        <option value="IPAERO15|pws_paeroa|coros|direct">Paeroa (Actual Station – WU)</option>
        <option value="IHAMILTO1131|IHAMILTO1131|raglan|closest">Karakariki Home (WAITETUNAVALLEYRD01)</option>
      </select>
    </div>
  </header>

  <div id="loader" class="loader"></div>

  <div id="mainContent" style="display:none;">
    <section><div class="current-block" id="currentBlock"></div></section>
    <section><div class="advice-block"><div class="advice-title">Practical advice</div><ul id="adviceList" class="advice-ul"></ul></div></section>
    <section><div class="forecast-row" id="forecastRow"></div></section>
    <section><div id="fishBanner" class="fish-banner">Fishing today: <span id="fishRowVal">—</span></div></section>
    <section><div class="rain-panel" id="rainPanel"></div></section>
    <section><div class="fishing-panel" id="fishingPanel"></div></section>
  </div>

  <div id="modalBg" class="modal-bg" style="display:none;"><div class="modal-popup" id="modalPopup"></div></div>

  <div class="credit">Powered by live NZ station data • 2025 Agora</div>
</div>

<script>
/* ================== CONFIG ================== */
const WU_KEY = "17815bdf5f234a62815bdf5f239a6209";
const XW_ID = "U8feQfLlcEfcXDfsWZs4C";
const XW_SECRET = "HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";
const WORLDTIDES_KEY = "e29bf187-08ef-4cc0-abf9-95ef021e7c";

/* station select default (Paeroa) */
let SELECTED = { wu:"IPAERO15", xw:"pws_paeroa", preset:"coros", xwMode:"direct" };

const COASTS = {
  coromandel:{ label:"Coromandel",  lat:-36.760, lon:175.500, wu:"IWAIOMU2", aspectDeg:300, shelter:0.6 },
  whangapoua:{ label:"Whangapoua", lat:-36.723, lon:175.627, wu:"IMATAR74", aspectDeg:70,  shelter:0.2 },
  raglan:    { label:"Raglan",      lat:-37.800, lon:174.883, wu:"IRAGLA28", aspectDeg:260, shelter:0.5 }
};
let activeCoastKey = "coromandel";

/* ================== HELPERS ================== */
const $=id=>document.getElementById(id);
const to1=v=>(v==null||isNaN(v))?"—":Number(v).toFixed(1);
const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const fmtDay = iso => {const d=new Date(iso);return `${days[d.getDay()]} ${d.getDate()}`};
const fmtFull= iso => new Date(iso).toLocaleDateString("en-NZ",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
const safeHM = iso => {if(!iso) return "—"; const d=new Date(iso); return isNaN(d)?"—":d.toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'})};
function degToCardinal(deg){if(deg==null||isNaN(deg))return"";const dirs=["N","NE","E","SE","S","SW","W","NW"];return dirs[Math.round(((deg%360)/45))%8];}
function iconUrl(per){const i=per?.icon;if(i)return`https://cdn.aerisapi.com/wxblox/icons/${i}`;const p=(per?.weather&&(per.weather.phrase||per.weather))||"";if(/Sunny|Clear/i.test(p))return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2600.png";if(/Cloud/i.test(p))return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2601.png";if(/Rain|Shower/i.test(p))return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f327.png";if(/Thunder|Storm/i.test(p))return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c8.png";return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c5.png";}
const get = (url,ms=18000)=>Promise.race([fetch(url),new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),ms))]).then(r=>r.ok?r.json():null).catch(()=>null);
function localISO(date,tz="Pacific/Auckland"){const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);const o=Object.fromEntries(p.map(x=>[x.type,x.value]));return `${o.year}-${o.month}-${o.day}`;}
function moonSimple(name,illum){const i=+illum||0;const n=(name||"").toLowerCase();if(i<=5)return"new moon";if(i>=95)return"full moon";if(i>=45&&i<=55)return n.includes('wax')?"first quarter":(n.includes('wan')?"last quarter":"half");return n.includes('wax')?"waxing":"waning";}
function moonSVG(name,illum){const pct=Math.max(0,Math.min(100,+illum||0));const waxing=/wax/i.test(name)||(!/wan/i.test(name)&&pct<50);const r=20,cx=20,cy=20;const w=pct/100*40;const L=waxing?cx-w/2:cx-(40-w)/2;const R=waxing?cx+w/2:cx+(40-w)/2;const a=`M ${Math.max(0,L)} ${cy} A ${r} ${r} 0 1 0 ${Math.min(40,R)} ${cy} A ${r} ${r} 0 1 0 ${Math.max(0,L)} ${cy} Z`;return'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="#223241"/><path d="${a}" fill="#f5f7fb"/></svg>`);}

/* ================== ENDPOINTS ================== */
const wuCur = id=>`https://api.weather.com/v2/pws/observations/current?stationId=${id}&format=json&units=m&apiKey=${WU_KEY}`;
const wu7   = id=>`https://api.weather.com/v2/pws/dailysummary/7day?stationId=${id}&format=json&units=m&apiKey=${WU_KEY}`;

/* XWeather routes: direct vs closest */
function xwForecastDayNight(sel){
  return sel.xwMode==="closest"
    ? `https://data.api.xweather.com/forecasts/closest?p=${encodeURIComponent(sel.xw)}&format=json&filter=daynight&limit=14&fields=periods.dateTimeISO,loc,periods.pop,periods.precipMM,periods.weather,periods.minTempC,periods.maxTempC,periods.windSpeedMaxKPH,periods.windSpeedMinKPH,periods.windDirMax,periods.windDirMin,periods.icon,periods.uvi,periods.sunriseISO,periods.sunsetISO,periods.minHumidity,periods.maxHumidity&client_id=${XW_ID}&client_secret=${XW_SECRET}`
    : `https://data.api.xweather.com/forecasts/${sel.xw}?format=json&filter=daynight&limit=14&fields=periods.dateTimeISO,loc,periods.pop,periods.precipMM,periods.weather,periods.minTempC,periods.maxTempC,periods.windSpeedMaxKPH,periods.windSpeedMinKPH,periods.windDirMax,periods.windDirMin,periods.icon,periods.uvi,periods.sunriseISO,periods.sunsetISO,periods.minHumidity,periods.maxHumidity&client_id=${XW_ID}&client_secret=${XW_SECRET}`;
}
function xwHourly2h(sel){
  return sel.xwMode==="closest"
    ? `https://data.api.xweather.com/forecasts/closest?p=${encodeURIComponent(sel.xw)}&format=json&filter=1hr&limit=60&fields=periods.dateTimeISO,periods.tempC,periods.pop,periods.precipMM,periods.icon,periods.windSpeedKPH,periods.windDir,periods.weather,periods.uvi&client_id=${XW_ID}&client_secret=${XW_SECRET}`
    : `https://data.api.xweather.com/forecasts/${sel.xw}?format=json&filter=1hr&limit=60&fields=periods.dateTimeISO,periods.tempC,periods.pop,periods.precipMM,periods.icon,periods.windSpeedKPH,periods.windDir,periods.weather,periods.uvi&client_id=${XW_ID}&client_secret=${XW_SECRET}`;
}
function xwSunMoonRange(sel,days=14){
  const now=new Date(),to=new Date(now.getTime()+(days-1)*86400e3);
  const mdy=d=>`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`;
  return sel.xwMode==="closest"
    ? `https://data.api.xweather.com/sunmoon/closest?p=${encodeURIComponent(sel.xw)}&from=${mdy(now)}&to=${mdy(to)}&format=json&client_id=${XW_ID}&client_secret=${XW_SECRET}`
    : `https://data.api.xweather.com/sunmoon/${sel.xw}?from=${mdy(now)}&to=${mdy(to)}&format=json&client_id=${XW_ID}&client_secret=${XW_SECRET}`;
}
function xwHistory(sel,from,to){
  return sel.xwMode==="closest"
    ? `https://data.api.xweather.com/observations/closest?p=${encodeURIComponent(sel.xw)}&from=${from}&to=${to}&fields=periods.dateTimeISO,periods.precipMM&plimit=288&client_id=${XW_ID}&client_secret=${XW_SECRET}`
    : `https://data.api.xweather.com/observations/${sel.xw}?from=${from}&to=${to}&fields=periods.dateTimeISO,periods.precipMM&plimit=288&client_id=${XW_ID}&client_secret=${XW_SECRET}`;
}
const worldTides=(lat,lon,days)=>`https://www.worldtides.info/api?extremes&days=${days}&lat=${lat}&lon=${lon}&key=${WORLDTIDES_KEY}`;

/* ================== STATE ================== */
let tz="Pacific/Auckland", pressureBuf=[], daily=[], hourlyCache=[], astroByDate={};

/* ================== STATION SWITCH ================== */
const selEl = $('stationSelect');
selEl.addEventListener('change',()=>{
  const [wu,xw,preset,mode] = selEl.value.split('|');
  SELECTED = { wu, xw, preset, xwMode:(mode||'direct') };
  activeCoastKey = (preset==='raglan') ? 'raglan' : 'coromandel';
  initApp();
});

/* ================== START ================== */
window.addEventListener('load', initApp);

async function initApp(){
  $('loader').style.display='block'; $('mainContent').style.display='none';
  pressureBuf=[]; astroByDate={}; daily=[]; hourlyCache=[];

  const [wu, fcdn, hourly, sunmoon] = await Promise.all([
    get(wuCur(SELECTED.wu),10000),
    get(xwForecastDayNight(SELECTED),12000),
    get(xwHourly2h(SELECTED),12000),
    get(xwSunMoonRange(SELECTED,14),12000)
  ]);

  const cur=buildCurrent(wu);
  hourlyCache = (hourly?.response?.[0]?.periods)||[];
  daily = groupDayNight((fcdn?.response?.[0]?.periods)||[]);

  (sunmoon?.response||[]).forEach(d=>{
    tz=d?.profile?.tz||tz;
    astroByDate[d.dateTimeISO.slice(0,10)] = {
      moon:{name:moonSimple(d.moon?.phase?.name,d.moon?.phase?.illum),illum:d.moon?.phase?.illum, riseISO:d.moon?.riseISO, setISO:d.moon?.setISO, transitISO:d.moon?.transitISO, underfootISO:d.moon?.underfootISO},
      sun:{riseISO:d.sun?.riseISO,setISO:d.sun?.setISO}
    };
  });

  const todayKey=localISO(new Date(),tz);
  const rain = await computeRainTotals(); // WU today/yday + XW 7/30/YTD

  renderCurrent(cur, daily[0]?.day||{}, todayKey);
  renderAdvice(cur, daily[0]?.day||{}, rain);
  renderForecastCards(daily, todayKey);
  renderRainPanel(rain);
  await renderFishingPanel();

  $('loader').style.display='none'; $('mainContent').style.display='';
}

/* ================== BUILD/RENDER ================== */
function buildCurrent(wu){
  const o=wu?.observations?.[0]||{}, m=o.metric||{};
  const c={
    temp: m.temp ?? null,
    feelslike: m.heatIndex ?? null,
    humidity: o.humidity ?? null,
    windSpeed: m.windSpeed ?? null,
    windGust: m.windGust ?? null,
    windDir: (typeof o.winddir==='number'?o.winddir:null),
    precipRate: m.precipRate ?? null,
    precipTotalToday: (typeof m.precipTotal==='number')?m.precipTotal:0,
    pressure: m.pressure ?? null,
    dewpt: m.dewpt ?? null,
    uv: o.uv ?? null,
    visibility: o.visibility ?? null,
    solarRadiation: o.solarRadiation ?? null,
    obsEpoch: o.obsTimeUtc?Date.parse(o.obsTimeUtc):Date.now()
  };
  if(c.pressure!=null){pressureBuf.push({time:c.obsEpoch,value:+c.pressure});pressureBuf=pressureBuf.filter(x=>c.obsEpoch-x.time<3*3600e3);}
  return c;
}
function groupDayNight(arr){
  const by={}; arr.forEach(p=>{const d=p.dateTimeISO.slice(0,10); (by[d]??=([])).push(p);});
  return Object.keys(by).sort().map(d=>({date:d,day:by[d][0],night:by[d][1]}));
}
function pTrend(){ if(pressureBuf.length<2) return null; const s=pressureBuf.slice().sort((a,b)=>a.time-b.time); const d=s[s.length-1].value-s[0].value; if(Math.abs(d)<.5) return "steady"; return d>0?"rising":"falling"; }

function renderCurrent(p,todayDay,todayKey){
  const icon=iconUrl(todayDay);
  const windVal=(p.windSpeed!=null)?p.windSpeed.toFixed(1):null;
  const gustVal=(p.windGust!=null)?p.windGust.toFixed(1):null;
  const windDir=(typeof p.windDir==='number')?degToCardinal(p.windDir):"";
  let windTxt="—"; if(windVal!==null) windTxt=(windVal<0.6)?"Calm":`${windVal} / ${gustVal||windVal} km/h ${windDir?`(${windDir})`:""}`;
  let pressTxt=(p.pressure!=null)?`${(+p.pressure).toFixed(1)} hPa`:"—"; const tr=pTrend(); if(tr) pressTxt+=` (${tr})`;
  const m=astroByDate[todayKey]?.moon; const moonTxt=m?`${m.name}${m.illum!=null?` • ${m.illum}%`:``}`:"—";
  const moonImg=m?`<img src="${moonSVG(m.name,m.illum)}" alt="moon" style="width:40px;height:40px;margin-top:2px;">`:"";
  const grid=[
    ["Feels Like",(p.feelslike!=null)?to1(p.feelslike)+"°C":"—"],
    ["Weather",todayDay?.weather||"—"],
    ["Rain Rate",(p.precipRate!=null)?to1(p.precipRate)+" mm/hr":"—"],
    ["Humidity",(p.humidity!=null)?Math.round(p.humidity)+"%":"—"],
    ["Wind / Gust",windTxt],
    ["Pressure",pressTxt],
    ["Dew Point",(p.dewpt!=null)?`${to1(p.dewpt)}°C`:"—"],
    ["Visibility",(p.visibility!=null)?`${to1(p.visibility)} km`:"—"],
    ["Solar",(p.solarRadiation!=null)?`${p.solarRadiation} W/m²`:"—"],
    ["UV",(p.uv!=null)?p.uv:"—"],
    ["Sunrise",safeHM(astroByDate[todayKey]?.sun?.riseISO||todayDay.sunriseISO)],
    ["Sunset",safeHM(astroByDate[todayKey]?.sun?.setISO||todayDay.sunsetISO)]
  ].map(([k,v])=>`<div class="current-field"><span class="current-label">${k}:</span> ${v}</div>`).join("");
  $('currentBlock').innerHTML=`
    <div class="current-left">
      <img class="current-icon" src="${icon}" alt="icon"/>
      <div class="current-temp-big">${(p.temp!=null)?to1(p.temp)+"°C":"—"}</div>
      ${moonImg}
      <div class="moon-line">Moon: ${moonTxt}</div>
    </div>
    <div class="current-details">
      <div class="current-temp-label">Current conditions</div>
      <div class="current-grid">${grid}</div>
    </div>`;
}

/* -------- Advice -------- */
function renderAdvice(obs, day, rain){
  const tips=[];
  const uv = +((day?.uvi!=null)?day.uvi:obs.uv||0);
  const wind = +(day?.windSpeedMaxKPH||0);
  const pop = +(day?.pop||0);
  const swing=((day?.maxTempC??NaN) - (day?.minTempC??NaN));
  if (pop>=60) tips.push("Wet periods likely — have a rain layer handy.");
  else tips.push("Mostly dry — good window for jobs and errands.");
  if (wind>=45) tips.push("Windy on exposed hills — secure loose gear.");
  if (!isNaN(swing) && swing>=10) tips.push("Large day–night swing — dress in layers.");
  if (uv>=7) tips.push("High UV near midday — hat and sunscreen.");
  if ((rain?.last7||0)>=60) tips.push("Ground soft after recent rain — take care on paddocks.");
  const tonight = (day?.minTempC<=2) ? "Cold night — cover tender plants and watch shady bridges." : "Calm evening — quick walk or outside jobs should be fine.";
  const tomorrow = (pop>=50) ? "Keep a wet-weather backup for tomorrow." : "Another generally settled day likely tomorrow.";
  $('adviceList').innerHTML = [`Today: ${tips.join(' ')}`, `Tonight: ${tonight}`, `Tomorrow: ${tomorrow}`].map(s=>`<li>${s}</li>`).join("");
}

/* -------- Forecast cards (skip today) -------- */
function renderForecastCards(arr,todayKey){
  const row=$('forecastRow'); row.innerHTML='';
  arr.slice(1,8).forEach(d=>{
    const per=d.day || d.night || {};
    const astro=astroByDate[d.date];
    const min=(d.day?.minTempC ?? d.night?.minTempC);
    const max=(d.day?.maxTempC ?? d.night?.maxTempC);
    const card=document.createElement('div');
    card.className='forecast-card';
    card.innerHTML=`
      <div class="forecast-day">${fmtDay(d.date+"T12:00:00")}</div>
      <img class="forecast-icon" src="${iconUrl(per)}" alt="icon"/>
      <div class="forecast-summary">${(d.day?.weather || per.weather || "—")}</div>
      <div class="forecast-temps">${max!=null?to1(min):"—"}–${max!=null?to1(max):"—"}°C</div>
      <div class="forecast-rain">Rain: ${to1(d.day?.precipMM ?? per.precipMM)} mm • POP ${(d.day?.pop ?? per.pop ?? "—")}%</div>
      <div class="forecast-moon">${astro?.moon?`Moon: ${astro.moon.name}`:""}</div>`;
    card.addEventListener('click',()=>showForecastDetails(d.date));
    row.appendChild(card);
  });
}

/* -------- 2-hourly modal -------- */
function showForecastDetails(dateKey){
  const entry=daily.find(x=>x.date===dateKey)||{};
  const day=entry.day||{}, night=entry.night||{};
  const astro=astroByDate[dateKey]; const m=astro?.moon;
  const sunrise=astro?.sun?.riseISO || day.sunriseISO || null;
  const sunset =astro?.sun?.setISO  || day.sunsetISO  || null;
  const moonTxt=m?`${m.name}${(m.illum!=null?` (${m.illum}% illum)`:"")}`:"—";
  const moonImg=m?`<img src="${moonSVG(m.name,m.illum)}" alt="moon" style="width:40px;height:40px;vertical-align:middle;margin-bottom:-8px;">`:"";
  const hrs=(hourlyCache||[]).filter(h=>(h.dateTimeISO||"").slice(0,10)===dateKey).filter(h=>new Date(h.dateTimeISO).getHours()%2===0);
  const rows=hrs.map(h=>{
    const t=safeHM(h.dateTimeISO), ic=iconUrl(h), wind=h.windSpeedKPH!=null?`${Math.round(h.windSpeedKPH)} km/h ${h.windDir||""}`:"—";
    return `<div class="hour-row">
      <div class="h-left"><span class="h-time">${t}</span><img class="h-icon" src="${ic}" alt=""><span class="h-info">${to1(h.tempC)}°C • ${h.weather||""}</span></div>
      <div class="h-meta">POP ${h.pop!=null?h.pop:"—"}% • Rain ${h.precipMM!=null?to1(h.precipMM):"—"} mm • Wind ${wind}</div>
    </div>`;
  }).join('');
  $('modalPopup').innerHTML=`
    <button class="modal-close-btn" onclick="closeModal()">&times;</button>
    <div class="modal-header">${fmtFull(dateKey+"T12:00:00")}</div>
    <div class="modal-details">
      <b>Moon:</b> ${moonImg} ${moonTxt}<br><br>
      <b>Day</b><br>
      <img class="forecast-icon" src="${iconUrl(day)}" alt="day icon"/> ${day.weather||"—"}<br>
      Temp: ${to1(day.maxTempC ?? night.maxTempC)}°C / ${to1(day.minTempC ?? night.minTempC)}°C •
      Wind: ${(day.windSpeedMinKPH??"—")}–${(day.windSpeedMaxKPH??"—")} km/h (${day.windDirMin!=null?degToCardinal(day.windDirMin):""}${day.windDirMax!=null?"–"+degToCardinal(day.windDirMax):""}) •
      Rain: ${to1(day.precipMM)} mm • POP ${(day.pop??"—")}% • UV ${(day.uvi??"—")}<br>
      Sunrise: ${safeHM(sunrise)} • Sunset: ${safeHM(sunset)}<br><br>
      <b>Night</b><br>
      <img class="forecast-icon" src="${iconUrl(night)}" alt="night icon"/> ${night.weather||"—"}<br>
      Temp: ${to1(night.maxTempC ?? day.maxTempC)}°C / ${to1(night.minTempC ?? day.minTempC)}°C •
      Wind: ${(night.windSpeedMinKPH??"—")}–${(night.windSpeedMaxKPH??"—")} km/h (${night.windDirMin!=null?degToCardinal(night.windDirMin):""}${night.windDirMax!=null?"–"+degToCardinal(night.windDirMax):""}) •
      Rain: ${to1(night.precipMM)} mm • POP ${(night.pop??"—")}%<br>
      <div class="hourly-grid">${rows || "<div style='opacity:.7'>2-hourly detail not available.</div>"}</div>
    </div>`;
  $('modalBg').style.display='flex';
}
function closeModal(){ $('modalBg').style.display='none'; }
$('modalBg').addEventListener('click',e=>{ if(e.target===$('modalBg')) closeModal(); });

/* ================== RAIN TOTALS ================== */
async function computeRainTotals(){
  const today = new Date(), todayKey = localISO(today);
  // live + yday from WU
  const wu     = await get(wuCur(SELECTED.wu),9000);
  const s7     = await get(wu7(SELECTED.wu),9000);
  const live   = wu?.observations?.[0]?.metric?.precipTotal ?? 0;
  let yest = 0;
  const yKey = localISO(new Date(today.getTime()-86400e3));
  if (Array.isArray(s7?.summaries)){
    const y = s7.summaries.find(x=> (x?.obsTimeLocal||"").slice(0,10)===yKey);
    yest = Number(y?.metric?.precipTotal||0);
  }
  // XWeather history for robust last7/30/YTD
  const from7  = localISO(new Date(today.getTime()-6*86400e3));
  const from30 = localISO(new Date(today.getTime()-29*86400e3));
  const fromJan= `${today.getFullYear()}-01-01`;
  const [h7, h30, hY] = await Promise.all([
    get(xwHistory(SELECTED, from7,  todayKey), 15000),
    get(xwHistory(SELECTED, from30, todayKey), 15000),
    get(xwHistory(SELECTED, fromJan, todayKey),15000)
  ]);
  const sumDaily = (hist)=> {
    const out={}; (hist?.response?.[0]?.periods||[]).forEach(p=>{const d=(p.dateTimeISO||"").slice(0,10); out[d]=(out[d]||0)+(+p.precipMM||0);});
    return Object.values(out).reduce((a,b)=>a+b,0);
  };
  return {
    today: +live||0,
    yesterday: +yest||0,
    last7: +sumDaily(h7)||0,
    last30: +sumDaily(h30)||0,
    ytd: Math.round(+sumDaily(hY)||0)
  };
}
function renderRainPanel(r){
  $('rainPanel').innerHTML=`
    <span class="rain-label">Rainfall Totals</span><br>
    Today: <b>${to1(r.today)} mm</b><br>
    Yesterday: <b>${to1(r.yesterday)} mm</b><br>
    Last 7 days: <b>${to1(r.last7)} mm</b><br>
    Last 30 days: <b>${to1(r.last30)} mm</b><br>
    Year-to-date: <b>${Math.round(r.ytd)} mm</b><br>
    <span style="font-size:.95em;opacity:.7;">*Today/yesterday via WU; longer totals from XWeather station history.</span>`;
}

/* ================== FISHING / TIDES (14 DAYS) ================== */
async function renderFishingPanel(){
  const panel=$('fishingPanel');
  const preset = SELECTED.preset; // 'coros' or 'raglan'
  panel.innerHTML=`
    <div class="fish-headline">Fishing, Tides & Swell</div>
    ${preset==='coros'?`
    <div class="fish-switch">
      <span>Coromandel</span>
      <label class="switch"><input id="fishToggle" type="checkbox" ${activeCoastKey==='whangapoua'?'checked':''}><span class="slider"></span></label>
      <span>Whangapoua</span>
    </div>`:''}
    <div id="fishRating" class="fish-rating"></div>
    <div id="fishNote" class="fish-note"></div>
    <div id="tideWrap" style="margin-top:6px;"></div>
    <div id="fishOutlook" style="margin-top:8px;"></div>`;
  if(preset==='coros'){
    $('fishToggle').addEventListener('change', async (e)=>{activeCoastKey=e.target.checked?'whangapoua':'coromandel'; await renderFishingPanel();});
  }else{
    activeCoastKey='raglan';
  }

  const coast = COASTS[activeCoastKey];
  // Coast wind context from WU coastal station
  const wu = await get(wuCur(coast.wu),9000);
  const windKph = wu?.observations?.[0]?.metric?.windSpeed ?? null;
  const windDirDeg = typeof wu?.observations?.[0]?.winddir==='number' ? wu.observations[0].winddir : null;

  const rToday=rateFishingForDate(localISO(new Date(),"Pacific/Auckland"), {windKph,windDirDeg}, coast);
  $('fishRating').textContent = `Fishing: ${rToday.label}`; $('fishRating').style.color=rToday.color;
  $('fishNote').textContent   = rToday.note;

  const extremes = await get(worldTides(coast.lat, coast.lon, 14), 16000);
  $('tideWrap').innerHTML = buildTideTable((extremes?.extremes)||[], coast, windKph, windDirDeg);

  const outlook = daily.slice(0,7).map(d=>{
    const r = rateFishingForDate(d.date, {windKph,windDirDeg}, coast);
    return `${new Date(d.date+"T12:00:00").toLocaleDateString('en-NZ',{weekday:'short'})}: ${r.label}`;
  }).join(' • ');
  $('fishOutlook').textContent = `7-day fishing outlook: ${outlook}`;
}

function buildTideTable(extremes, coast, windKph, windDirDeg){
  const by={}; (extremes||[]).forEach(e=>{const d=e.date.slice(0,10); if(!by[d]) by[d]={H:[],L:[]}; (e.type==='High'?by[d].H:by[d].L).push(e);});
  const keys=Object.keys(by).sort().slice(0,14);
  const rows=keys.map(k=>{
    const H=by[k].H.sort((a,b)=>a.date<b.date?-1:1).slice(0,2).map(x=>safeHM(x.date)).join(', ')||'—';
    const L=by[k].L.sort((a,b)=>a.date<b.date?-1:1).slice(0,2).map(x=>safeHM(x.date)).join(', ')||'—';
    const m=astroByDate[k]?.moon||{}; const phase=m.name?`${m.name}${m.illum!=null?` (${m.illum}% illum)`:``}`:'—';
    const r=rateFishingForDate(k,{windKph,windDirDeg}, coast);
    return `<tr>
      <td style="padding:6px 4px;">${new Date(k+"T12:00:00").toLocaleDateString('en-NZ',{weekday:'short',month:'short',day:'numeric'})}</td>
      <td style="padding:6px 4px;">${H}</td>
      <td style="padding:6px 4px;">${L}</td>
      <td style="padding:6px 4px;">${phase}</td>
      <td style="padding:6px 4px;white-space:nowrap;">${fishIcon(r.label)} ${r.label}<div style="font-size:.88em;color:#1b6e61;">${r.reason}</div></td>
    </tr>`;
  }).join('');
  return `<table class="tide-table"><thead><tr><th>Day</th><th>High</th><th>Low</th><th>Moon</th><th>Fishing</th></tr></thead><tbody>${rows}</tbody></table><div class="tide-note">Official tides via WorldTides.</div>`;
}

/* -------- Fishing score -------- */
function rateFishingForDate(dateKey, marineIn, coast){
  const cfg=coast||COASTS[activeCoastKey];
  const d = daily.find(x=>x.date===dateKey) || daily[0] || {};
  const per = d.day || d.night || {};
  const astro=astroByDate[dateKey]||{};
  const wind = marineIn?.windKph ?? per.windSpeedMaxKPH ?? 0;
  const wdir = marineIn?.windDirDeg ?? per.windDirMax ?? null;

  let s=0, why=[];
  if (wind<=10){s+=2;why.push("light wind");}
  else if (wind<=20){s+=0.8;why.push("moderate wind");}
  else if (wind>30){s-= (cfg.shelter?1.0:1.6); why.push("strong wind");}
  if (wdir!=null){
    const dlt=Math.abs(((cfg.aspectDeg - wdir + 540) % 360) - 180);
    if (dlt>140){s+=1.0;why.push("offshore breeze");}
    else if (dlt<40){s-=1.0;why.push("onshore breeze");}
  }
  const mName=(astro.moon?.name||"").toLowerCase();
  if (/new|quarter/.test(mName)) s+=0.3;
  if (/full/.test(mName)) s-=0.2;

  let label,color;
  if (s<=-0.5){label="Bad";color="#c0392b";}
  else if (s<=1.5){label="Fair";color="#e67e22";}
  else if (s<=3.5){label="Good";color="#27ae60";}
  else {label="Excellent";color="#2ecc71";}

  const good=why.filter(x=>/offshore|light/.test(x)).slice(0,2).join(", ");
  const risk=why.find(x=>/onshore|strong/.test(x));
  const note = [good, risk?("watch "+risk):""].filter(Boolean).join(" — ");
  const reason = [good || "pick tide changes", risk?"avoid exposed spots":""].filter(Boolean).join("; ");
  $('fishRowVal').textContent = `${label} — ${note||"use local shelter and tide changes."}`;
  return {label,color,note,reason};
}
function fishIcon(label){const col=label==="Excellent"?"#2ecc71":label==="Good"?"#27ae60":label==="Fair"?"#e67e22":"#c0392b";return `<svg class="fish-ico" viewBox="0 0 64 32" xmlns="http://www.w3.org/2000/svg"><path fill="${col}" d="M36 4c-8 0-16 4-22 12 6 8 14 12 22 12 8 0 14-4 20-12-6-8-12-12-20-12zM6 16l-6 4 3-4-3-4 6 4z"/><circle cx="42" cy="12" r="2" fill="#fff"/></svg>`;}
</script>
</body>
</html>