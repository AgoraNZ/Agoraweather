<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Agora Weather – Mobile Pro NZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    html, body { background: #181e2a; color: #fff; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
    #main { max-width: 500px; margin: 0 auto; padding: 0 2px 32px 2px; }
    .block { background: #222c40; border-radius: 13px; padding: 12px; margin: 14px 0 20px 0; box-shadow: 0 2px 12px #0007; }
    #loc { font-size: 1.11rem; font-weight: 600; margin-bottom: 3px; letter-spacing: 0.01em; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .temp { font-size: 2.6rem; font-weight: bold; letter-spacing: -0.03em; }
    .icon { width: 58px; height: 58px; }
    .details { font-size: 1.03rem; color: #c8daf7; margin: 10px 0 2px 0; display: flex; flex-wrap: wrap; gap: 12px 18px; }
    .metrics { font-size: 1.01rem; color: #a0bacd; margin: 2px 0 0 0; display: flex; flex-wrap: wrap; gap: 9px 15px; }
    .advice { background: #253e62; color: #ffd25a; border-radius: 7px; font-size: 1.07rem; margin-top: 9px; padding: 8px 13px; font-weight: 500; box-shadow: 0 1px 8px #0002; line-height: 1.32; text-align: left; word-break: break-word; white-space: normal;}
    #forecast-title { font-size: 1.06rem; font-weight: 600; margin: 3px 0 6px 3px; color: #ffe180; }
    #forecast { display: flex; flex-direction: column; gap: 8px; }
    .forecast-card { background: #232f47; border-radius: 9px; padding: 8px 6px 7px 10px; display: flex; align-items: center; gap: 10px; font-size: 1rem; box-shadow: 0 1px 4px #0002; }
    .forecast-card .day { font-weight: 600; width: 45px; color: #fff; }
    .forecast-card .ficon { width: 34px; height: 34px; }
    .forecast-card .info { flex: 1 1 0; font-size: 0.99rem; color: #dde5f3; line-height: 1.22; }
    #rain-title { font-size: 1.05rem; font-weight: 600; color: #85e7ff; margin-bottom: 5px;}
    #rainChart { width: 100%; min-height: 140px; max-width: 490px;}
    .rain-summary { font-size: 0.95rem; color: #ffe180; margin-top: 7px;}
    .label-metric { color:#ffe180; font-weight:600;}
    @media (max-width:600px){
      #main {padding:0 1px;}
      .block {padding:10px 3px 12px 7px;}
      .forecast-card .day { width:38px;}
    }
  </style>
</head>
<body>
<div id="main">
  <div class="block" id="current">
    <div id="loc">Loading location…</div>
    <div class="row">
      <span class="temp" id="temp">--°C</span>
      <img id="icon" class="icon" src="" alt="" />
    </div>
    <div class="details">
      <span id="condition">--</span>
      <span id="wind">Wind: -- km/h</span>
      <span id="gust">Gusts: -- km/h</span>
      <span id="feels">Feels: --°C</span>
      <span id="hum">Humidity: --%</span>
      <span id="dew">Dew: --°C</span>
      <span id="uv">UV: --</span>
      <span id="pressure">Pressure: -- hPa</span>
      <span id="vis">Visibility: -- km</span>
      <span id="cloud">Cloud: --%</span>
      <span id="sun">Sunrise: -- | Sunset: --</span>
    </div>
    <div class="metrics" id="more-metrics"></div>
    <div class="advice" id="advice">Getting advice…</div>
  </div>
  <div class="block">
    <div id="rain-title">Rainfall History (mm)</div>
    <canvas id="rainChart"></canvas>
    <div class="rain-summary" id="rain-summary"></div>
  </div>
  <div class="block">
    <div id="forecast-title">Next 7 days</div>
    <div id="forecast"></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const weatherIcons = icon => icon ? `https://cdn.aerisapi.com/wxblox/icons/${icon}` : '';
const dayOfWeek = d => new Date(d).toLocaleDateString('en-NZ', {weekday:'short'});
const cap = s => (s||'').charAt(0).toUpperCase()+(s||'').slice(1);

function aiAdvice(d){
  let out = [], a = [];
  if(d.precip >= 25) a.push("Very heavy rain – check for flooding and avoid low-lying roads.");
  else if(d.precip >= 10) a.push("Bring waterproofs – outdoor plans could get soggy.");
  if(d.gust >= 65) a.push("Damaging wind gusts. Bring in bins & check trampolines!");
  if(d.uv>=7) a.push("High UV – sunburn in 15 minutes, slip/slop/slap.");
  if(d.temp >= 30) a.push("Extreme heat! Stay cool & hydrate often.");
  if(d.temp <= 0) a.push("Freezing temps – risk of black ice in the morning.");
  if(d.feelslike-d.temp>=3) a.push("Feels much colder than the temperature – dress for the windchill.");
  if(Math.abs(d.pressChange)>=5) a.push("Rapid pressure drop – expect wind and rain shifts.");
  if(d.vis<=1) a.push("Low visibility: drive with lights on & slow down.");
  if(/thunder/.test(d.weather.toLowerCase())) a.push("Thunderstorms: stay indoors if you hear thunder.");
  if((d.sunrise && d.sunset) && (new Date() > new Date(d.sunset))) a.push("Dark early – check outdoor lights work.");
  if(new Date().getHours()<8 && d.temp < 7) a.push("Frost risk for early commute. Watch out on bridges.");
  // Outdoor, fishing, sports etc
  if(d.precip < 1 && d.uv >= 5 && d.wind < 20) a.push("Great weather for outdoor sport, beach or picnic.");
  if(d.precip < 1 && d.wind < 10) a.push("Calm and clear – perfect for morning fishing.");
  if(d.gust>35 && d.gust<60) a.push("Windy: sailing, windsurf, and kite sports will be fun – check forecasts before heading out.");
  // Seasonal
  let m = d.month;
  if([12,1,2].includes(m)) a.push("Summer: UV and dehydration are main risks. Cool clothes and hats advised.");
  if([6,7,8].includes(m)) a.push("Winter: Layer up and check heating before bed.");
  // General safety/household
  a.push("NZ tip: Weather can change quickly – check again before leaving home.");
  // Remove duplicates, keep top 2-3 and never repeat advice text
  out = [...new Set(a)].filter(Boolean).slice(0,3);
  return out.join(" ");
}

// Helper to display pressure change (trend) if forecast loaded
let prevPressure = null;

(async function(){
  // Use XWeather's :auto location, no popup, reliable location label
  let cur = await fetch('https://data.api.xweather.com/conditions/:auto?format=json&plimit=1&filter=minutelyprecip,1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,periods.weather,periods.icon,periods.feelslikeC,periods.precipMM,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq').then(r=>r.json());
  if(!cur || !cur.success) { document.getElementById('advice').textContent="Weather unavailable"; return; }
  const p = cur.response[0].periods[0];
  // City/region from loc
  let locName = cur.response[0].loc ? (cur.response[0].loc.city || cur.response[0].loc.country || "Your Area") : "Your Area";
  if(cur.response[0].loc && cur.response[0].loc.region) locName += ", "+cur.response[0].loc.region;
  document.getElementById('loc').textContent = locName;

  document.getElementById('temp').textContent = Math.round(p.tempC)+'°C';
  document.getElementById('icon').src = weatherIcons(p.icon);
  document.getElementById('condition').textContent = cap(p.weather||'');
  document.getElementById('wind').textContent = "Wind: " + (p.windDir||'') + " " + (p.windSpeedKPH!=null?Math.round(p.windSpeedKPH)+' km/h':'--');
  document.getElementById('gust').textContent = "Gusts: "+(p.windGustKPH!=null?Math.round(p.windGustKPH)+' km/h':'--');
  document.getElementById('feels').textContent = "Feels: "+(p.feelslikeC!=null?Math.round(p.feelslikeC)+'°C':'--');
  document.getElementById('hum').textContent = "Humidity: "+(p.humidity!=null?p.humidity+'%':'--');
  document.getElementById('dew').textContent = "Dew: "+(p.dewpointC!=null?Math.round(p.dewpointC)+'°C':'--');
  document.getElementById('uv').textContent = "UV: "+(p.uvIndex!=null?p.uvIndex:'--');
  document.getElementById('pressure').textContent = "Pressure: "+(p.pressureMB!=null?Math.round(p.pressureMB)+' hPa':'--');
  document.getElementById('vis').textContent = "Visibility: "+(p.visibilityKM!=null?Math.round(p.visibilityKM)+' km':'--');
  document.getElementById('cloud').textContent = "Cloud: "+(p.cloudsCoded?parseInt(p.cloudsCoded.replace('CL','').replace('SC','').replace('BK','').replace('OV',''))+'%':'--');
  document.getElementById('sun').textContent = "Sunrise: "+(p.sunriseISO?new Date(p.sunriseISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):'--')+" | Sunset: "+(p.sunsetISO?new Date(p.sunsetISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):'--');

  // Advanced metrics row: dewpoint, pressure, UV, visibility, clouds, sunrise/sunset shown above (can add more if available)
  // Fetch forecast for pressure trend and for cards
  let forecast = await fetch('https://data.api.xweather.com/forecasts/:auto?format=json&plimit=8&fields=periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.dewpointC,periods.summary,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.sunriseISO,periods.sunsetISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq').then(r=>r.json());
  let trend = '';
  if(forecast && forecast.success && forecast.response[0].periods.length>=2) {
    let pres1 = forecast.response[0].periods[0].pressureMB || 0, pres2 = forecast.response[0].periods[1].pressureMB || 0;
    trend = pres2-pres1; // positive = rising, negative = falling
  }
  // Smart advice: all advanced context
  document.getElementById('advice').textContent = aiAdvice({
    ...p,
    month: (new Date(p.dateTimeISO)).getMonth()+1,
    feelslike: p.feelslikeC||p.tempC,
    pressChange: trend,
    uv: p.uvIndex,
    vis: p.visibilityKM
  });

  // 7 day forecast (cards) – skip today
  let fcDom = document.getElementById('forecast'); fcDom.innerHTML = "";
  if(forecast && forecast.success && forecast.response[0].periods){
    forecast.response[0].periods.slice(1,8).forEach(p2 => {
      let card = document.createElement('div'); card.className='forecast-card';
      card.innerHTML = `<div class="day">${dayOfWeek(p2.dateTimeISO)}</div>
        <img class="ficon" src="${weatherIcons(p2.icon)}" alt=""/>
        <div class="info">
          <div><b>${cap(p2.weather||'')}</b></div>
          <div>${Math.round(p2.maxTempC)}/${Math.round(p2.minTempC)}°C</div>
          <div>Wind ${p2.windDir||''} ${Math.round(p2.windSpeedKPH||0)}km/h, Gusts ${Math.round(p2.windGustKPH||0)}km/h</div>
          <div>Rain ${p2.precipMM||0}mm • Hum ${p2.humidity||'--'}%</div>
        </div>`;
      fcDom.appendChild(card);
    });
  }

  // Rainfall history (chart) – week, month, and year-to-date
  let lat = cur.response[0].loc.lat, lon = cur.response[0].loc.long;
  let rain30 = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=30&daily=precipitation_sum&timezone=auto`).then(r=>r.json());
  let rain365 = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=365&daily=precipitation_sum&timezone=auto`).then(r=>r.json());
  let days30 = rain30.daily && rain30.daily.time ? rain30.daily.time.map((d,i)=>({date:d,precip:rain30.daily.precipitation_sum[i]})) : [];
  let labels = days30.slice(-7).map(x=>x.date.substr(5));
  let values = days30.slice(-7).map(x=>x.precip);
  let weekTotal = values.reduce((a,b)=>a+b,0), monthTotal = days30.reduce((a,b)=>a+b.precip,0);
  let ytdTotal = rain365.daily && rain365.daily.precipitation_sum ? rain365.daily.precipitation_sum.slice(0, (new Date()).getDay()).reduce((a,b)=>a+b,0) : rain365.daily.precipitation_sum.reduce((a,b)=>a+b,0);
  document.getElementById('rain-summary').innerHTML = `Past week: <b>${weekTotal.toFixed(1)} mm</b> &nbsp; | &nbsp; Past month: <b>${monthTotal.toFixed(1)} mm</b> &nbsp; | &nbsp; Year-to-date: <b>${ytdTotal.toFixed(1)} mm</b>`;
  new Chart(document.getElementById('rainChart').getContext('2d'),{
    type:'bar',
    data:{labels, datasets:[{label:"Rain (mm)",data:values,backgroundColor:'#85e7ff'}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
})();
</script>
</body>
</html>