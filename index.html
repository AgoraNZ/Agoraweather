<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Paeroa AI Weather App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#006699" />
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1163/1163661.png">
  <style>
    :root {
      --main: #006699;
      --accent: #ffcc00;
      --bg: #f6faff;
      --white: #fff;
      --shadow: 0 2px 10px 0 #0001;
    }
    body {
      margin: 0;
      background: var(--bg);
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #123;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: var(--main);
      color: var(--white);
      padding: 1.1em 0 .7em 0;
      text-align: center;
      box-shadow: var(--shadow);
    }
    header h1 { margin: 0; font-size: 2.1em;}
    .station { font-size: 1.1em; opacity: 0.8;}
    .container { max-width: 500px; margin: auto; padding-bottom: 2.2em;}
    .current {
      background: var(--white);
      border-radius: 1em;
      margin: 1.2em 1em 1.3em 1em;
      padding: 1.2em 1.4em 1.2em 1.4em;
      box-shadow: var(--shadow);
      display: flex; flex-direction: column; align-items: center;
    }
    .current .temp-main {
      font-size: 4.7em;
      font-weight: 800;
      margin-bottom: -0.15em;
      color: #0072b2;
      letter-spacing: -0.03em;
      line-height: 1;
    }
    .current .weather-icon {
      width: 60px; height: 60px; margin-bottom: 0.35em;
    }
    .current .desc { font-size: 1.19em; font-weight: 600; margin-bottom: .4em; }
    .current .meta {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 0.82em; margin-top: .5em;
    }
    .current .meta span {
      font-size: 1.05em; background: #eef5fb; border-radius: 1em; padding: 0.36em 1em;
    }
    .advice-section {
      background: var(--accent);
      color: #333;
      border-radius: 1em;
      margin: 0 1em 1.3em 1em;
      padding: 1em 1.2em;
      box-shadow: var(--shadow);
      font-size: 1.13em;
      font-weight: 600;
      display: flex;
      align-items: flex-start;
      gap: 1em;
      min-height: 60px;
    }
    .advice-section .advice-icon { font-size: 2em; line-height: 1; }
    .forecast-bar {
      margin: 0.8em 0.2em 0 0.2em;
      display: flex; overflow-x: auto; gap: 0.75em;
      padding-bottom: 0.7em;
      scroll-snap-type: x mandatory;
    }
    .forecast-card {
      min-width: 120px; max-width: 120px;
      background: var(--white);
      border-radius: 0.95em;
      box-shadow: var(--shadow);
      padding: .9em 0.8em;
      display: flex; flex-direction: column; align-items: center; gap: 0.15em;
      cursor: pointer; transition: box-shadow .12s;
      scroll-snap-align: start;
      border: 2px solid transparent;
    }
    .forecast-card:hover, .forecast-card.active { border-color: var(--accent);}
    .forecast-card img { width: 36px; height: 36px;}
    .forecast-card .date { font-size: 1em; font-weight: 600;}
    .forecast-card .summary { font-size: 1em; opacity: 0.9;}
    .forecast-card .temp { font-size: 1.12em; font-weight: 600;}
    .forecast-card .rain { font-size: 0.98em; color: #1a58a5;}
    .forecast-card .wind { font-size: 0.98em; color: #3a4e88;}
    .moon-section {
      background: var(--white);
      margin: 1.3em 1em 1.3em 1em;
      border-radius: 1em;
      box-shadow: var(--shadow);
      padding: 1em 1.2em;
      font-size: 1.05em;
      display: flex;
      flex-direction: column;
      gap: 0.3em;
    }
    .moon-section .moon-title {
      font-weight: 700; margin-bottom: .3em; color: #24343c;
      font-size: 1.1em;
    }
    .moon-row {
      display: flex; flex-wrap: wrap; gap: 1em; margin-bottom: 0.2em;
      font-size: 1em;
    }
    .moon-row span { min-width: 120px; }
    .fishing-section {
      background: #e4f8f6;
      margin: 1.3em 1em 1.3em 1em;
      border-radius: 1em;
      box-shadow: var(--shadow);
      padding: 1em 1.2em;
      font-size: 1.04em;
      display: flex;
      flex-direction: column;
      gap: 0.3em;
    }
    .fishing-section .fishing-title {
      font-weight: 700; margin-bottom: .3em; color: #04796a; font-size: 1.08em;
    }
    .phrases-section {
      background: #f9f7e7;
      margin: 1.3em 1em 1.3em 1em;
      border-radius: 1em;
      box-shadow: var(--shadow);
      padding: 1em 1.2em;
      font-size: 1em;
      display: flex;
      flex-direction: column;
      gap: 0.25em;
    }
    footer {
      margin-top: auto;
      text-align: center;
      color: #666;
      font-size: 1em;
      background: #e0effc;
      padding: .8em 1em;
      border-top: 1px solid #d4e8f5;
      letter-spacing: 0.01em;
    }
    @media (max-width: 600px) {
      .container { padding-bottom: 1.5em; }
      .forecast-bar { gap: 0.5em;}
      .forecast-card { min-width: 95px; max-width: 110px;}
      .moon-row span { min-width: 95px;}
    }
  </style>
</head>
<body>
  <header>
    <h1>Paeroa AI Weather</h1>
    <div class="station">Live from Paeroa, NZ</div>
  </header>
  <main class="container">
    <section id="current" class="current" aria-live="polite"></section>
    <section id="advice" class="advice-section"></section>
    <section>
      <div class="forecast-bar" id="forecast-bar"></div>
    </section>
    <section id="moon-section" class="moon-section"></section>
    <section id="fishing-section" class="fishing-section"></section>
    <section id="phrases-section" class="phrases-section"></section>
  </main>
  <footer>
    &copy; 2025 Agora Weather NZ &mdash; Powered by Paeroa PWS data | v1.1
  </footer>
<script>
const urls = {
  current: "https://data.api.xweather.com/conditions/pws_paeroa?format=json&plimit=1&filter=1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windDir,periods.weather,periods.feelslikeC&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq",
  forecast: "https://developer.xweather.com/product/api/output?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvcHRpb25zIjp7ImxvYyI6eyJ2YWx1ZSI6InB3c19wYWVyb2EiLCJhdXRvIjpmYWxzZX0sImZvcm1hdCI6Impzb24iLCJwYXJhbWV0ZXJzIjp7ImZpbHRlciI6ImRheW5pZ2h0IiwibGltaXQiOjcsImZpZWxkcyI6WyJwZXJpb2RzLmRhdGVUaW1lSVNPIiwibG9jIiwicGVyaW9kcy5wb3AiLCJwZXJpb2RzLnByZWNpcE1NIiwicGVyaW9kcy5taW5EZXdwb2ludEMiLCJwZXJpb2RzLndlYXRoZXIiXX19LCJlbmRwb2ludCI6ImZvcmVjYXN0cyIsImFjdGlvbiI6ImlkIiwiaWF0IjoxNzUzNTE2NTc3fQ.5mDAisIJqg46Pp3XVFxkW4nU-C0uJ8Km52tcqqRCJKk",
  moon: (() => {
    let now = new Date();
    let from = now.toLocaleDateString("en-NZ").replace(/\//g,"/");
    let next = new Date(now); next.setDate(now.getDate()+1);
    let to = next.toLocaleDateString("en-NZ").replace(/\//g,"/");
    return `https://data.api.xweather.com/sunmoon/pws_paeroa?from=${from}&to=${to}&format=json&fields=dateTimeISO,timestamp,profile,loc,place,sun,moon&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq`;
  })(),
  phrases: "https://data.api.xweather.com/phrases/summary/pws_paeroa?format=json&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq",
  fishing: "https://data.api.xweather.com/maritime/pws_coromandeltown1?filter=1hr&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq"
};
function iconUrl(weather) {
  if (!weather) return "https://cdn-icons-png.flaticon.com/512/1163/1163661.png";
  const map = {
    "Clear": "https://cdn-icons-png.flaticon.com/512/869/869869.png",
    "Partly Cloudy": "https://cdn-icons-png.flaticon.com/512/1163/1163624.png",
    "Cloudy": "https://cdn-icons-png.flaticon.com/512/414/414825.png",
    "Rain": "https://cdn-icons-png.flaticon.com/512/1163/1163657.png",
    "Showers": "https://cdn-icons-png.flaticon.com/512/414/414974.png",
    "Thunderstorm": "https://cdn-icons-png.flaticon.com/512/414/414968.png",
    "Fog": "https://cdn-icons-png.flaticon.com/512/414/414972.png"
  };
  let w = String(weather).toLowerCase();
  if (w.includes("clear")) return map["Clear"];
  if (w.includes("partly")) return map["Partly Cloudy"];
  if (w.includes("cloud")) return map["Cloudy"];
  if (w.includes("rain")) return map["Rain"];
  if (w.includes("shower")) return map["Showers"];
  if (w.includes("thunder")) return map["Thunderstorm"];
  if (w.includes("fog")) return map["Fog"];
  return "https://cdn-icons-png.flaticon.com/512/1163/1163661.png";
}
function fmtNum(n, d=1) {
  return n !== undefined && n !== null ? Number(n).toFixed(d) : '—';
}
function fmtTime(iso) {
  if (!iso) return "—";
  let d = new Date(iso);
  return d.toLocaleTimeString("en-NZ",{hour:"2-digit",minute:"2-digit"});
}
function fmtDate(iso) {
  if (!iso) return "—";
  let d = new Date(iso);
  return d.toLocaleDateString("en-NZ",{weekday:"short", day:"numeric", month:"short"});
}
function windDirAbbr(val) {
  if (!val) return "";
  if (typeof val === "number") {
    const dirs = ["N","NE","E","SE","S","SW","W","NW"];
    return dirs[Math.round(val/45)%8];
  }
  return val;
}
async function getJson(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}
async function renderCurrent() {
  const data = await getJson(urls.current);
  const p = data.periods[0];
  document.getElementById("current").innerHTML = `
    <div class="temp-main">${fmtNum(p.tempC,1)}°</div>
    <img class="weather-icon" src="${iconUrl(p.weather)}" alt="" />
    <div class="desc">${p.weather || ""}</div>
    <div class="meta">
      <span>Feels like: ${fmtNum(p.feelslikeC,1)}°</span>
      <span>Dew pt: ${fmtNum(p.dewpointC,1)}°</span>
      <span>Humidity: ${fmtNum(p.humidity,0)}%</span>
      <span>Wind: ${fmtNum(p.windSpeedKPH,1)}km/h ${windDirAbbr(p.windDir)}</span>
      <span>Time: ${fmtTime(p.dateTimeISO)}</span>
    </div>
  `;
  return p; // for advice
}
async function renderForecast() {
  const data = await getJson(urls.forecast);
  const days = data.periods;
  const bar = document.getElementById("forecast-bar");
  bar.innerHTML = "";
  days.forEach((day, idx) => {
    const c = document.createElement("div");
    c.className = "forecast-card";
    c.tabIndex = 0;
    c.innerHTML = `
      <div class="date">${fmtDate(day.dateTimeISO)}</div>
      <img src="${iconUrl(day.weather)}" alt="${day.weather || ''}">
      <div class="summary">${day.weather || ''}</div>
      <div class="temp"><b>${fmtNum(day.precipMM,1)}mm</b> rain</div>
      <div class="temp">${fmtNum(day.minDewpointC,1)}° / ${fmtNum(day.maxDewpointC,1)}°</div>
      <div class="rain">PoP: ${fmtNum(day.pop,0)}%</div>
    `;
    c.onclick = () => {
      alert(
        `Date: ${fmtDate(day.dateTimeISO)}
Weather: ${day.weather}
PoP: ${fmtNum(day.pop,0)}%
Precip: ${fmtNum(day.precipMM,1)}mm
Min Dewpoint: ${fmtNum(day.minDewpointC,1)}°
Max Dewpoint: ${fmtNum(day.maxDewpointC,1)}°
      `
      );
    };
    bar.appendChild(c);
  });
  return days;
}
async function renderMoon() {
  const data = await getJson(urls.moon);
  const today = data.response[0];
  const moon = today.moon, sun = today.sun;
  document.getElementById("moon-section").innerHTML = `
    <div class="moon-title">🌙 Moon & Sun Today</div>
    <div class="moon-row">
      <span>Moon phase: ${moon.phase.name} (${fmtNum(moon.phase.illum,0)}%)</span>
      <span>Moonrise: ${fmtTime(moon.riseISO)}</span>
      <span>Moonset: ${fmtTime(moon.setISO)}</span>
    </div>
    <div class="moon-row">
      <span>Sunrise: ${fmtTime(sun.riseISO)}</span>
      <span>Sunset: ${fmtTime(sun.setISO)}</span>
    </div>
  `;
}
async function renderPhrases() {
  const data = await getJson(urls.phrases);
  const phrases = data.response[0]?.phrases || {};
  document.getElementById("phrases-section").innerHTML = `
    <b>Quick NZ Summary:</b>
    <div>${phrases.shortMET || phrases.short || ""}</div>
    <small style="color:#666;opacity:.8">${phrases.longMET || phrases.long || ""}</small>
  `;
}
async function renderFishing() {
  const data = await getJson(urls.fishing);
  const p = data.response[0]?.periods || [];
  // Best fishing logic: slack tide, lowest wave, warmest sea
  let bestHour = null, maxTide = -999, minWaves = 999;
  p.forEach(hr=>{
    if (hr.tidesM > maxTide && hr.significantWaveHeightM < minWaves) {
      maxTide = hr.tidesM;
      minWaves = hr.significantWaveHeightM;
      bestHour = hr;
    }
  });
  document.getElementById("fishing-section").innerHTML = `
    <div class="fishing-title">🎣 Best Fishing</div>
    <div>Best hour: <b>${bestHour ? fmtTime(bestHour.dateTimeISO) : "—"}</b></div>
    <div>Sea temp: <b>${bestHour ? fmtNum(bestHour.seaSurfaceTemperatureC,1) : "—"}°C</b></div>
    <div>Tide: <b>${bestHour ? fmtNum(bestHour.tidesM,2) : "—"}m</b></div>
    <div>Waves: <b>${bestHour ? fmtNum(bestHour.significantWaveHeightM,2) : "—"}m</b></div>
  `;
}
function genAdvice(current) {
  // Core NZ farming advice logic
  let tips = [];
  if (!current) return "No current advice available.";
  if (current.tempC < 4) tips.push("Frost possible, check water lines & gates.");
  if (current.humidity > 94) tips.push("Facial eczema alert. Monitor pasture.");
  if (current.windSpeedKPH > 40) tips.push("Strong wind warning, secure loose gear.");
  if (/rain|shower/i.test(current.weather || "")) tips.push("Wet paddocks, expect mud near gates.");
  if (current.tempC > 25) tips.push("Heat stress possible, shade stock.");
  if (current.tempC >= 10 && current.tempC <= 17 && current.humidity > 88) tips.push("Good conditions for fungal disease, monitor crop.");
  if (tips.length === 0) return "No major issues—carry on as usual!";
  return tips.join(" ");
}
async function main() {
  let current = null;
  try { current = await renderCurrent(); } catch(e){ document.getElementById("current").innerHTML = "<em>Error loading current data</em>"; }
  try { document.getElementById("advice").innerHTML = `<span class="advice-icon">🧠</span><span>${genAdvice(current)}</span>`;}catch{}
  try { await renderForecast(); } catch(e){}
  try { await renderMoon(); } catch(e){}
  try { await renderFishing(); } catch(e){}
  try { await renderPhrases(); } catch(e){}
}
main();
</script>
</body>
</html>
