<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agora Weather App</title>
  <style>
    body { background: #1B263B; color: #fff; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; }
    .container { max-width: 420px; margin: 20px auto; padding: 18px; background: #274472; border-radius: 18px; box-shadow: 0 4px 32px #1b263b77; }
    .loc { font-size: 2rem; font-weight: bold; text-align: center; margin: 0 0 10px; }
    .current-main { display: flex; align-items: center; justify-content: space-between; }
    .icon { width: 74px; }
    .ctemp { font-size: 3rem; font-weight: bold; }
    .cond { font-size: 1.3rem; font-weight: 600; margin-top: 4px; }
    .details { margin: 10px 0 0; font-size: 1rem; display: flex; flex-wrap: wrap; justify-content: space-between; }
    .details span { width: 47%; margin-bottom: 4px; }
    .advice { background: #415a77; border-radius: 7px; font-style: italic; font-size: 1.06rem; padding: 8px 10px; margin: 16px 0 8px; }
    .forecast-list { margin: 10px 0 0; }
    .day-item { background: #274472; margin: 5px 0; border-radius: 8px; display: flex; align-items: center; cursor: pointer; transition: background .2s;}
    .day-item:hover { background: #415a77; }
    .day-label { width: 55px; font-weight: bold; }
    .day-icon { width: 40px; }
    .day-cond { flex: 1; margin: 0 7px; font-size: 1.07rem; }
    .day-temp { width: 68px; text-align: right; font-weight: 500; }
    .info { margin-top: 10px; font-size: 1.02rem; }
    .info strong { color: #9ff; }
    .section-btn { background: #1B263B; color: #fff; border: 0; border-radius: 7px; padding: 8px 12px; margin: 12px 0 5px; cursor: pointer; width: 100%; font-size: 1.02rem; }
    .attribution { text-align: center; font-size: 0.8rem; color: #b5b5b5; margin-top: 22px; }
    .modal { display: none; position: fixed; z-index: 1000; top: 0; left: 0; width: 100vw; height: 100vh; background: #0c1424cc; align-items: center; justify-content: center; }
    .modal-content { background: #274472; border-radius: 13px; padding: 18px; max-width: 420px; width: 96vw; max-height: 82vh; overflow-y: auto; margin: 50px auto; }
    .modal-title { font-weight: bold; font-size: 1.15rem; margin-bottom: 9px; }
    .close-btn { position: absolute; right: 18px; top: 13px; font-size: 2rem; color: #fff; background: none; border: none; cursor: pointer; }
    .hourly-row { display: flex; align-items: center; margin-bottom: 8px; }
    .hour-time { width: 62px; font-weight: bold; }
    .hour-icon { width: 30px; }
    .hour-cond { flex: 1; margin: 0 8px; }
    .hour-temp { width: 38px; text-align: right; font-weight: 500; }
    .chart { display: flex; align-items: flex-end; height: 92px; gap: 8px; margin: 20px 0 6px; }
    .bar { background: #61aaff; width: 16px; border-radius: 4px 4px 0 0; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
    .bar-label { font-size: 0.85rem; text-align: center; margin-top: 2px; }
    .bar-value { font-size: 0.83rem; margin-bottom: 3px; }
    .rain-totals { margin: 11px 0 5px; font-size: 1.01rem;}
    @media (max-width: 520px) {
      .container, .modal-content { max-width: 99vw; padding: 10px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="loc" id="loc">Loading...</div>
    <div class="current-main">
      <img id="icon" class="icon" src="" alt="" />
      <div>
        <div class="ctemp" id="ctemp"></div>
        <div class="cond" id="cond"></div>
      </div>
    </div>
    <div class="details" id="details"></div>
    <div class="advice" id="advice"></div>
    <div class="forecast-list" id="forecast"></div>
    <div class="info" id="info"></div>
    <button class="section-btn" onclick="showRain()">üåß Rainfall History</button>
    <div class="attribution">Data powered by Vaisala Xweather</div>
  </div>
  <!-- Hourly Modal -->
  <div class="modal" id="hourModal">
    <div class="modal-content" id="hourModalContent">
      <button class="close-btn" onclick="closeModal('hourModal')">&times;</button>
      <div id="hourModalTitle" class="modal-title"></div>
      <div id="hourlyRows"></div>
    </div>
  </div>
  <!-- Rainfall Modal -->
  <div class="modal" id="rainModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('rainModal')">&times;</button>
      <div class="modal-title">Rainfall History</div>
      <div id="rainChart"></div>
      <div class="rain-totals" id="rainTotals"></div>
    </div>
  </div>
<script>
// === API CONFIG ===
const clientId = "U8feQfLlcEfcXDfsWZs4C";
const clientSecret = "HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";
const apiBase = "https://data.api.xweather.com";
let userLat, userLon, cityName="";
// === GEOLOCATION ===
function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(gotLoc, geoErr, {enableHighAccuracy:true, timeout:9000});
  } else {
    useFallbackLoc();
  }
}
function gotLoc(pos) {
  userLat = pos.coords.latitude;
  userLon = pos.coords.longitude;
  fetchAll();
}
function geoErr() { useFallbackLoc(); }
function useFallbackLoc() {
  // Hamilton, NZ fallback
  userLat = -37.7833;
  userLon = 175.2833;
  fetchAll();
}
// === FETCH ALL DATA ===
async function fetchAll() {
  let latlon = `${userLat},${userLon}`;
  // 1. Forecast
  let forecastRaw = await fetchJson(`${apiBase}/forecasts/${latlon}?format=json&filter=day&limit=7&fields=periods.dateTimeISO,loc,periods.maxTempC,periods.minTempC,periods.pop,periods.precipMM,periods.maxHumidity,periods.minHumidity,periods.maxDewpointC,periods.minDewpointC,periods.maxFeelslikeC,periods.windSpeedMaxKPH,periods.windSpeedMinKPH,periods.windDirMax,periods.windDirMin,periods.weather,periods.icon,periods.uvIndex,periods.sunriseISO,periods.sunsetISO,periods.sky&client_id=${clientId}&client_secret=${clientSecret}`);
  let forecast = forecastRaw && forecastRaw.response && forecastRaw.response[0] ? forecastRaw.response[0] : null;
  // 2. Current
  let condsRaw = await fetchJson(`${apiBase}/conditions/${latlon}?format=json&plimit=1&filter=minutelyprecip,5min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windDir,periods.weather,periods.feelslikeC,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.sky,periods.sunriseISO,periods.sunsetISO,periods.icon&client_id=${clientId}&client_secret=${clientSecret}`);
  let cur = condsRaw && condsRaw.response && condsRaw.response[0] && condsRaw.response[0].periods && condsRaw.response[0].periods[0] ? condsRaw.response[0].periods[0] : null;
  // 3. Hourly
  let hourlyRaw = await fetchJson(`${apiBase}/forecasts/${latlon}?format=json&filter=1hr&limit=48&fields=periods.dateTimeISO,periods.tempC,periods.feelslikeC,periods.weather,periods.icon&client_id=${clientId}&client_secret=${clientSecret}`);
  let hourly = hourlyRaw && hourlyRaw.response && hourlyRaw.response[0] && hourlyRaw.response[0].periods ? hourlyRaw.response[0].periods : [];
  // 4. Lightning
  let lightning = await fetchJson(`${apiBase}/lightning/${latlon}?format=json&filter=all&limit=10&fields=id,ob,loc,recISO&client_id=${clientId}&client_secret=${clientSecret}`);
  // 5. Road
  let road = await fetchJson(`${apiBase}/roadweather/${latlon}?client_id=${clientId}&client_secret=${clientSecret}`);
  // 6. Cyclone
  let cyclone = await fetchJson(`${apiBase}/tropicalcyclones/closest?p=${latlon}&radius=25mi&minradius=0mi&filter=all,&limit=2&client_id=${clientId}&client_secret=${clientSecret}`);
  // 7. Alerts
  let alerts = await fetchJson(`${apiBase}/alerts/${latlon}?format=json&limit=3&fields=details.name,loc,details.color,details.body,details.bodyFull,timestamps.beginsISO,timestamps.expiresISO,includes.zipcodes,includes.counties&client_id=${clientId}&client_secret=${clientSecret}`);
  // 8. Rain
  let rainDays = await fetchRainDays(latlon);
  // Location name
  cityName = (forecast && forecast.place && forecast.place.name) ? forecast.place.name : "Location";
  document.getElementById("loc").textContent = cityName;
  // Current
  let cicon = cur && cur.icon ? iconUrl(cur.icon) : "";
  document.getElementById("icon").src = cicon;
  document.getElementById("icon").alt = cur ? cur.weather : "";
  document.getElementById("ctemp").textContent = cur && cur.tempC!==undefined ? Math.round(cur.tempC)+"¬∞" : "--";
  document.getElementById("cond").textContent = cur && cur.weather ? cur.weather : (forecast && forecast.periods && forecast.periods[0] && forecast.periods[0].weather) ? forecast.periods[0].weather : "--";
  document.getElementById("details").innerHTML = `
    <span>Feels: ${cur && cur.feelslikeC!==undefined ? Math.round(cur.feelslikeC)+"¬∞" : "--"}</span>
    <span>Humidity: ${cur && cur.humidity!==undefined ? cur.humidity+"%" : "--"}</span>
    <span>Dew: ${cur && cur.dewpointC!==undefined ? Math.round(cur.dewpointC)+"¬∞" : "--"}</span>
    <span>UV: ${cur && cur.uvIndex!==undefined ? cur.uvIndex : "--"}</span>
    <span>Cloud: ${cur && cur.sky!==undefined ? cur.sky+"%" : "--"}</span>
    <span>Sunrise: ${cur && cur.sunriseISO ? hhmm(cur.sunriseISO) : "--"}</span>
    <span>Sunset: ${cur && cur.sunsetISO ? hhmm(cur.sunsetISO) : "--"}</span>
    <span>Wind: ${cur && cur.windSpeedKPH!==undefined ? Math.round(cur.windSpeedKPH)+"km/h" : "--"}</span>
    <span>Gusts: --</span>
    <span>Pressure: ${cur && cur.pressureMB!==undefined ? cur.pressureMB+" hPa" : "--"}</span>
    <span>Visibility: ${cur && cur.visibilityKM!==undefined ? cur.visibilityKM+" km" : "--"}</span>
  `;
  // AI Advice
  let advice = aiAdvice({
    forecast, cur, lightning, road, cyclone, alerts, rainDays
  });
  document.getElementById("advice").textContent = advice;
  // Forecast
  let fcHtml = "";
  if (forecast && forecast.periods) {
    forecast.periods.forEach((d, i) => {
      let label = i==0 ? "Today" : i==1 ? "Tomorrow" : dayName(d.dateTimeISO);
      fcHtml += `
        <div class="day-item" onclick="showHourly(${i})">
          <div class="day-label">${label}</div>
          <img src="${iconUrl(d.icon)}" class="day-icon" alt="${d.weather||''}"/>
          <div class="day-cond">${d.weather||''}</div>
          <div class="day-temp">${d.maxTempC!==undefined?Math.round(d.maxTempC)+"¬∞":""}/${d.minTempC!==undefined?Math.round(d.minTempC)+"¬∞":""}</div>
        </div>
      `;
    });
  }
  document.getElementById("forecast").innerHTML = fcHtml;
  // Info line (hazards)
  let infoArr = [];
  if (lightning && lightning.response && lightning.response.length>0) infoArr.push("‚ö° Lightning nearby");
  if (road && road.response && road.response[0] && road.response[0].periods && road.response[0].periods[0] && road.response[0].periods[0].summary) infoArr.push(`üõ£Ô∏è Road: ${road.response[0].periods[0].summary}`);
  if (cyclone && cyclone.response && cyclone.response.length>0) infoArr.push(`üåÄ Cyclone: ${cyclone.response[0].profile && cyclone.response[0].profile.name ? cyclone.response[0].profile.name : 'active'}`);
  if (alerts && alerts.response && alerts.response.length>0 && alerts.response[0].details) infoArr.push(`‚ö†Ô∏è Alerts: ${alerts.response[0].details.name}`);
  document.getElementById("info").innerHTML = infoArr.length ? infoArr.join("<br>") : "";
  // Save for hourly modal
  window._forecast = forecast;
  window._hourly = hourly;
}
// === HELPERS ===
function iconUrl(icon) {
  return icon ? `https://cdn.aerisapi.com/wxblox/icons/${icon}.png` : "";
}
function dayName(iso) { return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(iso).getDay()]; }
function hhmm(iso) { let d=new Date(iso);return d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0"); }
async function fetchJson(url) { try { let r = await fetch(url); return await r.json(); } catch { return null; } }
// === HOURLY POPUP ===
function showHourly(i) {
  let hourly = window._hourly || [];
  let fc = window._forecast && window._forecast.periods ? window._forecast.periods : [];
  if (!hourly.length || !fc[i]) { alert("Hourly not ready."); return; }
  // Show 24h starting from this day
  let d0 = new Date(fc[i].dateTimeISO); d0.setHours(0,0,0,0);
  let hlist = hourly.filter(h => {
    let hd = new Date(h.dateTimeISO); return hd >= d0 && hd < new Date(d0.getTime() + 86400000);
  });
  if (!hlist.length) { alert("Hourly not ready."); return; }
  let html = "";
  hlist.forEach(h => {
    html += `<div class="hourly-row">
      <span class="hour-time">${hhmm(h.dateTimeISO)}</span>
      <img src="${iconUrl(h.icon)}" class="hour-icon" alt=""/>
      <span class="hour-cond">${h.weather||""}</span>
      <span class="hour-temp">${h.tempC!==undefined?Math.round(h.tempC)+"¬∞":""}</span>
    </div>`;
  });
  document.getElementById("hourModalTitle").textContent = fc[i].weather + " - " + dayName(fc[i].dateTimeISO);
  document.getElementById("hourlyRows").innerHTML = html;
  document.getElementById("hourModal").style.display = "flex";
}
function closeModal(id) { document.getElementById(id).style.display="none"; }
// === RAINFALL POPUP ===
function showRain() {
  let rain = window._rainDays || [];
  if (!rain.length) { document.getElementById("rainChart").innerHTML="No rain data"; document.getElementById("rainTotals").textContent=""; }
  else {
    let max = Math.max(...rain.map(d=>d.mm));
    let chart = rain.map(d=>`
      <div class="bar" style="height:${Math.round((d.mm/max)*82)}px">
        <div class="bar-value">${d.mm||0}mm</div>
        <div class="bar-label">${d.day}</div>
      </div>
    `).join('');
    document.getElementById("rainChart").innerHTML = `<div class="chart">${chart}</div>`;
    let total7 = rain.reduce((a,b)=>a+b.mm,0);
    document.getElementById("rainTotals").innerHTML = `Past 7 days: <strong>${total7}mm</strong>`;
  }
  document.getElementById("rainModal").style.display = "flex";
}
// === FETCH 7 DAYS RAIN DATA ===
async function fetchRainDays(latlon) {
  let fcRaw = await fetchJson(`${apiBase}/forecasts/${latlon}?format=json&filter=day&limit=7&fields=periods.dateTimeISO,periods.precipMM&client_id=${clientId}&client_secret=${clientSecret}`);
  let fc = fcRaw && fcRaw.response && fcRaw.response[0] ? fcRaw.response[0] : null;
  if (!fc || !fc.periods) return [];
  let days = fc.periods.map(f=>({day:dayName(f.dateTimeISO), mm:Math.round(f.precipMM||0)}));
  window._rainDays = days;
  return days;
}
// === AI ADVICE GENERATOR ===
function aiAdvice({forecast,cur,lightning,road,cyclone,alerts,rainDays}) {
  let advice = [];
  if (alerts && alerts.response && alerts.response.length>0 && alerts.response[0].details) advice.push("‚ö†Ô∏è " + alerts.response[0].details.body);
  if (cyclone && cyclone.response && cyclone.response.length>0) advice.push("üåÄ Cyclone warning: " + (cyclone.response[0].profile && cyclone.response[0].profile.name ? cyclone.response[0].profile.name : ""));
  if (road && road.response && road.response[0] && road.response[0].periods && road.response[0].periods[0] && road.response[0].periods[0].summary) advice.push("üõ£Ô∏è Roads: " + road.response[0].periods[0].summary);
  if (lightning && lightning.response && lightning.response.length>0) advice.push("‚ö° Lightning activity nearby");
  let f = forecast && forecast.periods ? forecast.periods[0] : null;
  if (f) {
    let t = f.maxTempC;
    let pop = f.pop;
    let cond = (f.weather||"").toLowerCase();
    if (cond.includes("storm")) advice.push("Storms possible‚Äîtake care outdoors.");
    if (pop>70) advice.push("High chance of rain‚Äîkeep an umbrella handy.");
    if (t>=27) advice.push("Hot day‚Äîdrink plenty of water and use sunblock.");
    if (t<=3) advice.push("Freezing ‚Äì black ice risk early mornings.");
    if (f.uvIndex && f.uvIndex>6) advice.push("UV high‚Äîwear sunscreen.");
    if (cond.includes("snow")) advice.push("Possible snow‚Äîcheck road conditions.");
  }
  let month = (new Date()).getMonth()+1;
  if (month>=5&&month<=8) advice.push("Winter: check for frost, allow extra travel time.");
  else if (month>=11||month<=2) advice.push("Summer: Stay sun safe and hydrated.");
  let shown = (localStorage.getItem("last_advice")||"").split("|");
  let uniq = advice.filter(a=>a&&shown.indexOf(a)<0);
  let show = uniq.length ? uniq[0] : advice[0] || "All clear‚Äîenjoy your day!";
  let advOut = [show].concat(shown.slice(0,2)).join("|");
  try { localStorage.setItem("last_advice", advOut); } catch{}
  return show;
}
// ===== START =====
getLocation();
</script>
</body>
</html>