<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>AgoraWeather NZ Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #181e2a; color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #main {
      max-width: 500px; margin: 0 auto;
      padding: 0 2px 32px;
    }
    .block {
      background: #222c40;
      border-radius: 13px;
      padding: 13px 9px 15px 13px;
      margin: 18px 0 24px;
      box-shadow: 0 2px 14px #0007;
    }
    #loc {
      font-size: 1.13rem;
      font-weight: 600;
      margin-bottom: 4px;
      letter-spacing: 0.01em;
    }
    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }
    .temp {
      font-size: 2.7rem;
      font-weight: bold;
      letter-spacing: -0.03em;
    }
    .icon {
      width: 58px; height: 58px;
    }
    .details {
      font-size: 1.03rem;
      color: #c8daf7;
      margin: 10px 0 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px 18px;
    }
    .details span { min-width: 44%; }
    .advice-list {
      margin: 10px 0 0;
    }
    .advice-tip {
      background: #253e62;
      color: #ffd25a;
      border-radius: 7px;
      font-size: 1.07rem;
      margin-bottom: 8px;
      padding: 8px 13px;
      font-weight: 500;
      box-shadow: 0 1px 8px #0002;
      line-height: 1.32;
      text-align: left;
    }
    .tabs {
      display: flex; margin-bottom: 7px;
    }
    .tab-btn {
      flex: 1;
      padding: 9px 0;
      background: #181e2a;
      color: #ffe180;
      border: none;
      border-radius: 6px 6px 0 0;
      font-size: 1.08rem;
      font-weight:600;
      margin-right:2px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #ffe180;
      color: #222c40;
    }
    #forecast-cards, #rain-block {
      display: none;
    }
    #forecast-cards.active, #rain-block.active {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .forecast-card {
      background: #232f47;
      border-radius: 9px;
      padding: 11px 6px 11px 14px;
      display: flex;
      align-items: center;
      gap: 11px;
      font-size: 1rem;
      box-shadow: 0 1px 4px #0002;
      cursor: pointer;
    }
    .forecast-card .day {
      font-weight: 600;
      width: 55px;
      color: #fff;
    }
    .forecast-card .ficon {
      width: 36px; height: 36px;
    }
    .forecast-card .info {
      flex: 1 1 0;
      font-size: 1rem;
      color: #dde5f3;
      line-height: 1.25;
    }
    #rain-title {
      font-size: 1.07rem;
      font-weight: 600;
      color: #85e7ff;
      margin-bottom: 8px;
    }
    #rainChart {
      width: 100%;
      min-height: 110px;
      max-width: 490px;
      margin-bottom:10px;
    }
    .rain-summary, .rain-extra {
      font-size: 0.96rem;
      margin-top:7px;
    }
    .rain-summary { color: #ffe180; }
    .rain-extra   { color: #aad7ff; }
    .rain-table {
      width:100%; margin-top:10px; border-spacing:0;
    }
    .rain-table th, .rain-table td {
      font-size:0.95rem; padding:2px 6px;
    }
    .rain-table th {
      color:#85e7ff; text-align:left;
    }
    .rain-table td {
      color:#dde5f3;
    }
    .wettest { color:#8ae995; font-weight:600; }
    .driest  { color:#fddbdb; font-weight:600; }

    /* Popup */
    #popup-bg {
      position: fixed; inset:0;
      background: rgba(10,18,36,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #popup {
      background: #222c40;
      border-radius: 17px;
      padding: 22px 15px;
      color: #fff;
      max-width: 380px;
      width: 95vw;
      box-shadow: 0 8px 36px #000c;
      position: relative;
    }
    #popup .close {
      position: absolute;
      top:7px; right:15px;
      font-size:2rem;
      color:#aad7ff;
      background:none; border:none;
      cursor:pointer;
    }
    #popup .pday {
      font-size:1.11rem;
      font-weight:bold;
      margin-bottom:4px;
    }
    #popup .pdesc {
      font-size:1.01rem;
      color:#ffe180;
      margin-bottom:7px;
    }
    .hourly-vert {
      margin-top:15px;
      max-height:400px;
      overflow-y:auto;
    }
    .hour-block {
      background:#181e2a;
      border-radius:7px;
      padding:9px 7px;
      margin-bottom:7px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .htime {
      font-size:1.06rem;
      color:#ffe180;
      font-weight:600;
      width:50px;
    }
    .hicon {
      width:32px; height:32px;
    }
    .htemp {
      font-size:1.08rem;
      font-weight:600;
      width:40px;
    }
    .hrow {
      font-size:0.98rem;
      color:#dde5f3;
      flex:1;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    @media (max-width:600px){
      #main { padding:0 1px; }
      .block { padding:10px 3px 12px 7px; }
      .forecast-card .day { width:38px; }
      #popup { padding:13px 2px; }
    }
  </style>
</head>
<body>
  <div id="main">
    <!-- Current Conditions -->
    <div class="block" id="current">
      <div id="loc">Loading location…</div>
      <div class="row">
        <span class="temp" id="temp">--°C</span>
        <img id="icon" class="icon" src="" alt=""/>
      </div>
      <div class="details" id="details"></div>
      <div class="advice-list" id="advice-list"></div>
    </div>

    <!-- Tabs + Forecast + Rain -->
    <div class="block">
      <div class="tabs">
        <button class="tab-btn active" id="forecastTab" onclick="selectTab('forecast')">Forecast</button>
        <button class="tab-btn"           id="rainTab"     onclick="selectTab('rain')">Rain History</button>
      </div>
      <div id="forecast-cards" class="active"></div>
      <div id="rain-block">
        <div id="rain-title">Rainfall History (mm)</div>
        <canvas id="rainChart"></canvas>
        <div class="rain-summary" id="rain-summary"></div>
        <div class="rain-extra"   id="rain-extra"></div>
        <table class="rain-table" id="rain-table"></table>
      </div>
    </div>
  </div>

  <!-- Hourly Popup -->
  <div id="popup-bg">
    <div id="popup"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Helpers
    const iconUrl   = ic => ic ? `https://cdn.aerisapi.com/wxblox/icons/${ic}.png` : '';
    const dayOfWeek = d => new Date(d).toLocaleDateString('en-NZ',{weekday:'short'});
    const cap       = s => s ? s[0].toUpperCase()+s.slice(1) : '';

    function selectTab(which) {
      document.getElementById('forecast-cards').classList.toggle('active', which==='forecast');
      document.getElementById('rain-block').    classList.toggle('active', which==='rain');
      document.getElementById('forecastTab').classList.toggle('active', which==='forecast');
      document.getElementById('rainTab').    classList.toggle('active', which==='rain');
    }

    function closePopup(){ document.getElementById('popup-bg').style.display='none'; }

    function openPopup(day, periods) {
      // Find that day's hours & show every 2-hour block
      const dayIdx = periods.find(p=> dayOfWeek(p.dateTimeISO)===day );
      if(!dayIdx) return;
      const targetDay = new Date(dayIdx.dateTimeISO).getDay();
      const hours = periods
        .filter(p=> new Date(p.dateTimeISO).getDay()===targetDay)
        .filter(p=> new Date(p.dateTimeISO).getHours()%2===1); // every 2 hours starting 1am

      // Build HTML
      let html = `<button class="close" onclick="closePopup()">&times;</button>
        <div class="pday">${day}, ${new Date().toLocaleDateString('en-NZ')}</div>
        <div class="pdesc">${cap(dayIdx.weather)}</div>`;

      // AI advice for that day
      const advice = aiAdvice({
        ...dayIdx,
        month: new Date(dayIdx.dateTimeISO).getMonth()+1,
        feelslike: dayIdx.feelslikeC||dayIdx.tempC
      });
      advice.forEach(t=> html += `<div class="advice-tip">${t}</div>`);

      html += `<div class="hourly-vert">`;
      hours.forEach(h=>{
        html += `
          <div class="hour-block">
            <div class="htime">${("0"+new Date(h.dateTimeISO).getHours()).slice(-2)}:00</div>
            <img class="hicon" src="${iconUrl(h.icon)}"/>
            <div>
              <div class="htemp">${Math.round(h.tempC||0)}°C</div>
              <div class="hrow">
                Wind ${Math.round(h.windSpeedKPH||0)}km/h | Rain ${h.precipMM||0}mm<br>
                Hum ${h.humidity||0}% | UV ${h.uvIndex||'--'} | Vis ${Math.round(h.visibilityKM||0)}km
              </div>
            </div>
          </div>`;
      });
      html += `</div>`;

      document.getElementById('popup').innerHTML = html;
      document.getElementById('popup-bg').style.display = 'flex';
    }

    function aiAdvice(d){
      let tips = [];
      if(d.precipMM>=25) tips.push("Very heavy rain – check for flooding.");
      else if(d.precipMM>=10) tips.push("Bring waterproofs – outdoor plans could get soggy.");
      if(d.windSpeedKPH>=50) tips.push("Strong winds – secure loose items.");
      if(d.uvIndex>=7) tips.push("High UV – slip, slop, slap.");
      if(d.tempC>=30) tips.push("Extreme heat – hydrate & stay cool.");
      if(d.tempC<=0) tips.push("Freezing temps – watch for black ice.");
      if([6,7,8].includes(d.month)) tips.push("Winter: layer up & heat home.");
      if([12,1,2].includes(d.month)) tips.push("Summer: wear sunscreen & drink water.");
      tips.push("Weather changes fast – check again before heading out.");
      return [...new Set(tips)].slice(0,3);
    }

    // Geolocation
    function getCoords() {
      return new Promise(res=>{
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(
            p=> res({lat:p.coords.latitude, lon:p.coords.longitude}),
            ()=> res(null),
            {timeout:7000}
          );
        } else res(null);
      });
    }

    (async()=>{
      const coords = await getCoords();
      const base   = 'https://data.api.xweather.com';
      const auth   = 'client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';

      // --- Current ---
      const curUrl = coords
        ? `${base}/conditions/${coords.lat},${coords.lon}?format=json&plimit=1&filter=1min` +
          `&fields=loc,periods.dateTimeISO,periods.tempC,periods.feelslikeC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,periods.weather,periods.icon,periods.precipMM,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&${auth}`
        : `${base}/conditions/:auto?format=json&plimit=1&filter=1min` +
          `&fields=periods.tempC,periods.feelslikeC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,periods.weather,periods.icon,periods.precipMM,periods.pressureMB,periods.uvIndex,periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&${auth}`;

      let curRes = await fetch(curUrl).then(r=>r.json()).catch(()=>null);
      let p      = curRes?.success ? curRes.response[0].periods[0] : {};
      let loc    = coords
        ? (curRes.response[0].loc.city || curRes.response[0].loc.region || 'Your Area')
        : 'Your Area';

      document.getElementById('loc').textContent = loc;
      document.getElementById('icon').src       = iconUrl(p.icon);
      document.getElementById('temp').textContent= p.tempC!=null ? Math.round(p.tempC)+'°C':'--°C';

      const fields = [
        `Feels: ${p.feelslikeC!=null?Math.round(p.feelslikeC)+'°C':'--'}`,
        `Humidity: ${p.humidity!=null?p.humidity+'%':'--'}`,
        `Wind: ${p.windDir? p.windDir+' '+Math.round(p.windSpeedKPH||0)+'km/h':'--'}`,
        `Gusts: ${p.windGustKPH!=null?Math.round(p.windGustKPH)+'km/h':'--'}`,
        `Pressure: ${p.pressureMB!=null?Math.round(p.pressureMB)+'hPa':'--'}`,
        `Dew Pt: ${p.dewpointC!=null?Math.round(p.dewpointC)+'°C':'--'}`,
        `Visibility: ${p.visibilityKM!=null?Math.round(p.visibilityKM)+'km':'--'}`,
        `Cloud: ${p.cloudsCoded?parseInt(p.cloudsCoded.replace(/\D/g,''))+'%':'--'}`,
        `UV: ${p.uvIndex!=null?p.uvIndex:'--'}`,
        `Sunrise: ${p.sunriseISO?new Date(p.sunriseISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):'--'}`,
        `Sunset: ${p.sunsetISO? new Date(p.sunsetISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):'--'}`
      ];
      document.getElementById('details').innerHTML = fields.map(f=>`<span>${f}</span>`).join('');

      // AI advice
      document.getElementById('advice-list').innerHTML = aiAdvice({
        weather:p.weather,
        precipMM:p.precipMM||0,
        windSpeedKPH:p.windSpeedKPH||0,
        uvIndex:p.uvIndex||0,
        tempC:p.tempC||0,
        month:new Date().getMonth()+1
      }).map(t=>`<div class="advice-tip">${t}</div>`).join('');

      // --- 7-Day Forecast ---
      const fcUrl = coords
        ? `${base}/forecasts/${coords.lat},${coords.lon}?format=json&filter=day&limit=7` +
          `&fields=periods.dateTimeISO,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.windSpeedKPH,periods.windDir,periods.windGustKPH,periods.precipMM,periods.humidity,periods.uvIndex&${auth}`
        : `${base}/forecasts/:auto?format=json&filter=day&limit=7` +
          `&fields=periods.dateTimeISO,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.windSpeedKPH,periods.windDir,periods.windGustKPH,periods.precipMM,periods.humidity,periods.uvIndex&${auth}`;

      let fcRes = await fetch(fcUrl).then(r=>r.json()).catch(()=>null);
      let days  = fcRes?.success ? fcRes.response[0].periods : [];

      const fcDiv = document.getElementById('forecast-cards');
      fcDiv.innerHTML = '';
      days.forEach(d=>{
        const c = document.createElement('div');
        c.className = 'forecast-card';
        c.innerHTML = `
          <div class="day">${dayOfWeek(d.dateTimeISO)}</div>
          <img class="ficon" src="${iconUrl(d.icon)}"/>
          <div class="info">
            <div><b>${cap(d.weather)}</b></div>
            <div>${Math.round(d.maxTempC)}/${Math.round(d.minTempC)}°C</div>
            <div>Wind ${d.windDir} ${Math.round(d.windSpeedKPH)}km/h, Gusts ${Math.round(d.windGustKPH)}km/h</div>
            <div>Rain ${d.precipMM}mm • Hum ${d.humidity}%</div>
          </div>`;
        c.onclick = ()=> openPopup(dayOfWeek(d.dateTimeISO), days);
        fcDiv.appendChild(c);
      });

      // --- Rain History ---
      if(coords){
        const r7  = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&past_days=7&daily=precipitation_sum&timezone=auto`).then(r=>r.json()).catch(()=>null);
        const r30 = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&past_days=30&daily=precipitation_sum&timezone=auto`).then(r=>r.json()).catch(()=>null);
        const r365= await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&past_days=365&daily=precipitation_sum&timezone=auto`).then(r=>r.json()).catch(()=>null);

        const w7  = r7?.daily?.precipitation_sum || [];
        const total7  = w7.reduce((a,b)=>a+b,0).toFixed(1);
        const total30 = (r30?.daily?.precipitation_sum||[]).reduce((a,b)=>a+b,0).toFixed(1);
        const total365= (r365?.daily?.precipitation_sum||[]).reduce((a,b)=>a+b,0).toFixed(1);

        document.getElementById('rain-summary').innerHTML = `
          Week: <b>${total7} mm</b> |
          Month: <b>${total30} mm</b> |
          YTD: <b>${total365} mm</b>`;

        // Chart
        new Chart(document.getElementById('rainChart').getContext('2d'), {
          type:'bar',
          data:{
            labels: r7.daily.time.map(d=>d.substr(5)),
            datasets:[{ label:'Rain', data:w7, backgroundColor:'#85e7ff' }]
          },
          options:{ plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true} }}
        });

        // Table last 7
        let tbl = '<tr><th>Date</th><th>Rain</th></tr>';
        r7.daily.time.forEach((dt,i)=>{
          tbl += `<tr>
            <td>${dt.substr(5)}</td>
            <td>${w7[i].toFixed(1)}</td>
          </tr>`;
        });
        document.getElementById('rain-table').innerHTML = tbl;
      } else {
        document.getElementById('rain-summary').textContent = 'Enable location for rain history';
      }

    })();
  </script>
</body>
</html>