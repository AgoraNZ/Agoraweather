<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Agora NZ Weather – Smarter Kiwi Weather App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="The only weather app built on real NZ station data with uniquely Kiwi weather advice." />
<style>
  body{margin:0;background:#f4f7fb;font-family:'Segoe UI',Arial,sans-serif;color:#15304b}
  .app-container{max-width:500px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 5px 30px #193a5e18;padding-bottom:34px;min-height:100vh;display:flex;flex-direction:column}
  header{background:linear-gradient(90deg,#18558e 68%,#15b2c1 100%);color:#fff;padding:34px 22px 18px;border-radius:0 0 30px 30px;box-shadow:0 3px 16px #18558e10}
  .main-title{font-size:2.07rem;font-weight:700;letter-spacing:-.5px;margin-bottom:6px}
  .sub-title{font-size:1.09rem;opacity:.94;font-weight:400;margin-bottom:0}
  .station-select-row{display:flex;align-items:center;gap:9px;margin:14px 0 7px}
  select{font-size:1rem;padding:5px 10px;border-radius:6px;border:1px solid #18558e;background:#f4f7fb;color:#1c293a}
  select:disabled{background:#e7eaf3;color:#888}

  .current-block{margin:17px 18px 0;padding:17px 11px;border-radius:12px;background:#eaf3fa;box-shadow:0 2px 8px #cad8e850;display:flex;align-items:center;gap:18px}
  .current-left{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:120px}
  .current-icon{width:72px;height:72px;object-fit:contain;background:#fff;border-radius:50%;border:2.5px solid #18558e;padding:8px;box-shadow:0 0 8px #18558e18}
  .current-temp-big{font-size:3rem;font-weight:700;color:#16549b;line-height:1}
  .moon-line{font-size:.94rem;color:#1e406a;text-align:center}
  .current-details{flex:1;display:flex;flex-direction:column}
  .current-temp-label{font-size:1.13rem;color:#35526b;margin:-2px 0 8px}
  .current-grid{display:flex;flex-wrap:wrap;margin-top:6px}
  .current-field{width:48%;min-width:160px;font-size:.99rem;margin-bottom:4px}
  .current-label{font-weight:bold;color:#19558e}

  .advice-block{margin:17px 18px 0;padding:13px 15px;border-radius:10px;background:#e5f2ff;color:#1e364a;font-size:1.1rem;font-weight:500;box-shadow:0 2px 8px #c8e6ff55;min-height:58px}

  .forecast-row{margin:18px 0 0;padding-left:14px;display:flex;overflow-x:auto;gap:9px;scrollbar-width:thin}
  .forecast-card{flex:0 0 136px;background:#f7faff;border-radius:12px;box-shadow:0 2px 7px #aac2e660;display:flex;flex-direction:column;align-items:center;padding:11px 7px 13px;cursor:pointer;transition:box-shadow .2s;border:2px solid transparent;min-width:110px;max-width:160px}
  .forecast-card:hover{border:2.5px solid #18558e;box-shadow:0 6px 16px #aac2e680;background:#e2f3ff}
  .forecast-icon{width:41px;height:41px;margin:2px 0 6px}
  .forecast-day{font-weight:600;font-size:1.01rem;margin-bottom:2px}
  .forecast-summary{font-size:.97rem;margin-bottom:4px;color:#2857a1;min-height:18px;text-align:center}
  .forecast-temps{font-size:1.07rem;font-weight:500;color:#285680;margin-bottom:1px}
  .forecast-rain{font-size:.91rem;color:#0a6899;margin-bottom:0}
  .forecast-moon{font-size:.9rem;color:#1a3e2d;margin-top:2px;min-height:18px}

  .modal-bg{position:fixed;inset:0;background:#23324c45;z-index:50;display:none;align-items:flex-end;justify-content:center}
  .modal-popup{width:100%;max-width:470px;background:#fff;border-radius:22px 22px 0 0;box-shadow:0 10px 40px #23324c70;padding:23px 18px 18px;animation:modalIn .3s}
  @keyframes modalIn{from{transform:translateY(100px);opacity:0}to{transform:translateY(0);opacity:1}}
  .modal-header{font-size:1.3rem;font-weight:bold;margin-bottom:7px;color:#18558e}
  .modal-close-btn{position:absolute;top:18px;right:23px;background:none;border:none;font-size:1.7rem;color:#6c7c8c;cursor:pointer;z-index:100}
  .modal-details{margin-top:6px;font-size:1.07rem;color:#23415c}

  .rain-panel{margin:18px 18px 0;padding:12px;border-radius:10px;background:#ecf8ff;color:#15304b;box-shadow:0 2px 8px #c8e6ff40;font-size:1.03rem;line-height:1.35}
  .rain-label{font-weight:600;color:#18558e;margin-bottom:3px;font-size:1.08rem}

  .fishing-panel{margin:25px 18px 0;padding:14px;border-radius:12px;background:#eafaf7;box-shadow:0 2px 7px #bceadd33;color:#18558e;font-size:1.02rem;font-weight:500}
  .fish-headline{font-size:1.18rem;font-weight:bold;margin-bottom:6px}
  .fish-switch{display:flex;align-items:center;gap:10px;margin:6px 0 8px}
  .switch{position:relative;display:inline-block;width:54px;height:28px}
  .switch input{display:none}
  .slider{position:absolute;cursor:pointer;inset:0;background:#cfeee7;transition:.2s;border-radius:28px}
  .slider:before{position:absolute;content:"";height:22px;width:22px;left:3px;top:3px;background:#fff;transition:.2s;border-radius:50%;box-shadow:0 1px 4px #0003}
  input:checked+.slider{background:#85d7c5}
  input:checked+.slider:before{transform:translateX(26px)}
  .fish-rating{margin-top:6px;font-weight:700}
  .fish-note{font-size:.95em;color:#217b6a;margin-top:4px}
  .fish-swell{margin:12px 0;text-align:center}
  .fish-swell img{width:100%;max-width:320px;border-radius:6px;box-shadow:0 2px 12px #2684c222}
  .tide-table{width:100%;border-collapse:separate;border-spacing:0 6px;font-size:.98rem}
  .tide-table th{text-align:left;color:#0f5c57;font-weight:700}
  .tide-note{font-size:.92em;color:#2f6d65;margin-top:6px}
  .fish-outlook{margin-top:10px;font-size:.96rem;color:#0e5c4f}
  .loader{margin:60px auto 34px;border:7px solid #d7e3f5;border-top:7px solid #0f82c6;border-radius:50%;width:44px;height:44px;animation:spin 1.05s linear infinite}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  .credit{text-align:center;color:#b4c2d3;font-size:.96em;margin:31px auto 0}
  @media (max-width:600px){.app-container{box-shadow:none;border-radius:0}.forecast-row{padding-left:3px}.modal-popup{border-radius:21px 21px 0 0;padding:11px 6px 17px}}
</style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="main-title">Agora NZ Weather</div>
      <div class="sub-title">The only NZ weather app with real station data &amp; truly practical Kiwi advice</div>
      <div class="station-select-row">
        <label for="stationSelect">Station:</label>
        <select id="stationSelect" disabled>
          <option value="IPAERO15" selected>Paeroa (Actual Station – WU)</option>
        </select>
      </div>
    </header>

    <div id="loader" class="loader"></div>

    <div id="mainContent" style="display:none;">
      <section><div class="current-block" id="currentBlock"></div></section>
      <section><div class="advice-block" id="adviceBlock"></div></section>
      <section><div class="forecast-row" id="forecastRow"></div></section>
      <section>
        <div id="fishRow" style="margin:10px 18px 0 18px;padding:10px 12px;border-radius:10px;background:#eef8f5;color:#18558e;font-weight:600;">
          Fishing today: <span id="fishRowVal">—</span>
        </div>
      </section>
      <section><div class="rain-panel" id="rainPanel"></div></section>
      <section><div class="fishing-panel" id="fishingPanel"></div></section>
    </div>

    <div id="modalBg" class="modal-bg"><div class="modal-popup" id="modalPopup"></div></div>

    <div class="credit">Powered by live NZ station data • 2025 Agora<br><span style="font-size:0.89em;opacity:0.8;">Proudly New Zealand owned & built for Kiwis</span></div>
  </div>

<script>
/*** CONFIG ***/
const wuStationId = "IPAERO15";
const wuApiKey    = "17815bdf5f234a62815bdf5f239a6209";

const xwStationId     = "pws_paeroa";
const apiClientId     = "U8feQfLlcEfcXDfsWZs4C";
const apiClientSecret = "HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";

/* site coords for maritime “closest” (diff coasts) */
const siteCoords = {
  coromandel:  {lat:-36.760, long:175.500}, // Firth / west side
  whangapoua:  {lat:-36.720, long:175.670}  // east coast
};
const tideOffsets = {
  /* minute offsets applied to moon-based tide windows so coasts differ */
  coromandel: {high:+0,  low:+0},
  whangapoua:{high:+25, low:+10}  // tweak if you want
};
const fishingSites = {
  coromandel: { label:"Coromandel", maritimeId:"pws_coromandeltown1", swellSlug:"thames",      altLink:"https://www.swellmap.com/surf/forecast/thames" },
  whangapoua: { label:"Whangapoua", maritimeId:"",                       swellSlug:"whangapoua", altLink:"https://www.swellmap.com/surf/forecast/whangapoua" }
};
let activeFishingKey = "coromandel";

/*** HELPERS ***/
const $ = (id)=>document.getElementById(id);
const to1=(v)=> (v==null||isNaN(v))?"—":Number(v).toFixed(1);
const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const safeHM=(iso)=>{ if(!iso) return "—"; const d=new Date(iso); return isNaN(d)?"—":d.toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}); };
const fmtDay=(iso)=>{const d=new Date(iso);return `${days[d.getDay()]} ${d.getDate()}`};
const fmtFull=(iso)=>{const d=new Date(iso);return d.toLocaleDateString("en-NZ",{weekday:"long",year:"numeric",month:"long",day:"numeric"})};
function degToCardinal(deg){ if(deg==null||isNaN(deg))return ""; const dirs=["N","NE","E","SE","S","SW","W","NW"]; return dirs[Math.round(((deg%360)/45))%8]; }
function iconUrl(per){ const i=per?.icon; if(i) return `https://cdn.aerisapi.com/wxblox/icons/${i}`; const p=(per?.weather&&(per.weather.phrase||per.weather))||""; if(p.includes('Sunny')||p.includes('Clear'))return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2600.png"; if(p.includes('Cloud'))return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2601.png"; if(p.includes('Rain')||p.includes('Showers'))return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f327.png"; if(p.includes('Thunder'))return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c8.png"; return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c5.png"; }
function localISO(date, tz="Pacific/Auckland"){
  const p = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
  const o = Object.fromEntries(p.map(x=>[x.type,x.value]));
  return `${o.year}-${o.month}-${o.day}`;
}
/* simplified moon name */
function simpleMoonName(name, illum){
  const i = Number(illum||0);
  const n = (name||"").toLowerCase();
  if (i <= 5) return "new moon";
  if (i >= 95) return "full moon";
  if (i>=45 && i<=55) return n.includes('wax') ? "first quarter" : (n.includes('wan') ? "last quarter" : "half");
  return n.includes('wax') ? "waxing" : (n.includes('wan') ? "waning" : (i<50?"waxing":"waning"));
}

/*** FETCH HELPERS ***/
const timeout = ms=>new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms));
const safeJson = async (res)=>{ if(!res||!res.ok) throw new Error('http'); return res.json(); };
const get = (url,ms=10000)=>Promise.race([fetch(url),timeout(ms)]).then(safeJson).catch(()=>null);

/*** ENDPOINTS ***/
const wuCur = id=>`https://api.weather.com/v2/pws/observations/current?stationId=${id}&format=json&units=m&apiKey=${wuApiKey}`;
const xwCond = id=>`https://data.api.xweather.com/conditions/${id}?format=json&plimit=1&filter=1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windDir,periods.weather,periods.feelslikeC,periods.visibilityKM,periods.uvi&client_id=${apiClientId}&client_secret=${apiClientSecret}`;
const xwFc = id=>`https://data.api.xweather.com/forecasts/${id}?format=json&filter=daynight&limit=14&fields=periods.dateTimeISO,loc,periods.pop,periods.precipMM,periods.minDewpointC,periods.maxDewpointC,periods.weather,periods.minTempC,periods.maxTempC,periods.windSpeedMaxKPH,periods.windSpeedMinKPH,periods.windDirMax,periods.windDirMin,periods.icon,periods.uvi,periods.sunriseISO,periods.sunsetISO,periods.minHumidity,periods.maxHumidity&client_id=${apiClientId}&client_secret=${apiClientSecret}`;
const xwSunMoon = (id,days=14)=>{const now=new Date(),to=new Date(now.getTime()+(days-1)*86400e3);const mdy=d=>`${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`;return `https://data.api.xweather.com/sunmoon/${id}?from=${mdy(now)}&to=${mdy(to)}&format=json&fields=dateTimeISO,profile,moon,sun&client_id=${apiClientId}&client_secret=${apiClientSecret}`};
const xwObs = (id,fromISO,toISO)=>`https://data.api.xweather.com/observations/${id}?from=${fromISO}&to=${toISO}&fields=periods.dateTimeISO,periods.precipMM&plimit=10000&client_id=${apiClientId}&client_secret=${apiClientSecret}`;
const xwMarineId     = id=>`https://data.api.xweather.com/maritime/${id}?filter=1hr&client_id=${apiClientId}&client_secret=${apiClientSecret}`;
const xwMarineClosest= ({lat,long})=>`https://data.api.xweather.com/maritime/closest?p=${lat},${long}&filter=1hr&limit=1&client_id=${apiClientId}&client_secret=${apiClientSecret}`;

/*** STATE ***/
let pressureBuf=[];
let daily=[];               // [{date, day, night}]
let astroByDate={};         // date -> {moon:{...}, sun:{riseISO,setISO}}
let tz = "Pacific/Auckland";

/*** CORE ***/
async function start(){
  $('loader').style.display='block'; $('mainContent').style.display='none';

  // CURRENT (WU first, then XW fill)
  let cur={};
  const wu = await get(wuCur(wuStationId),9000);
  if (wu?.observations?.[0]){
    const o=wu.observations[0], m=o.metric||{};
    cur = {
      temp:m.temp??null, feelslike:m.heatIndex??null, humidity:o.humidity??null,
      windSpeed:m.windSpeed??o.windSpeed??null, windGust:m.windGust??o.windGust??null,
      windDir:(typeof o.winddir==='number'?o.winddir:null),
      precipRate:m.precipRate??null, precipTotalToday:m.precipTotal??0,
      precipTotalLast24h:m.precipTotalLast24h??null,
      pressure:m.pressure??null, dewpt:m.dewpt??null,
      uv:o.uv??null, visibility:(o.visibility!=null?o.visibility:null), solarRadiation:o.solarRadiation??null,
      obsEpoch:o.obsTimeUtc?Date.parse(o.obsTimeUtc):Date.now()
    };
  }
  const xwc = await get(xwCond(xwStationId),9000);
  const p0 = xwc?.response?.[0]?.periods?.[0];
  if (p0){
    cur.temp = cur.temp ?? p0.tempC ?? null;
    cur.feelslike = cur.feelslike ?? p0.feelslikeC ?? null;
    cur.humidity = cur.humidity ?? p0.humidity ?? null;
    cur.windSpeed = cur.windSpeed ?? p0.windSpeedKPH ?? null;
    cur.windDir = cur.windDir ?? p0.windDir ?? null;
    cur.dewpt = cur.dewpt ?? p0.dewpointC ?? null;
    cur.visibility = cur.visibility ?? p0.visibilityKM ?? null;   // visibility fallback
    cur.uv = cur.uv ?? p0.uvi ?? null;
    cur.obsEpoch = cur.obsEpoch ?? (p0.dateTimeISO?Date.parse(p0.dateTimeISO):Date.now());
  }
  if (cur.pressure!=null){ pressureBuf.push({time:cur.obsEpoch,value:Number(cur.pressure)}); pressureBuf=pressureBuf.filter(x=>cur.obsEpoch-x.time<3*3600e3); }

  // FORECAST + SUN/MOON
  const [fcJ, smJ] = await Promise.all([ get(xwFc(xwStationId),12000), get(xwSunMoon(xwStationId,14),12000) ]);
  const periods = (fcJ?.response?.[0]?.periods||[]).filter(p=>p && p.dateTimeISO);
  daily = groupDayNight(periods);

  astroByDate={};
  (smJ?.response||[]).forEach(d=>{
    tz = d?.profile?.tz || tz;
    const key=d.dateTimeISO.slice(0,10);
    astroByDate[key]={
      moon:{
        name:simpleMoonName(d.moon?.phase?.name,d.moon?.phase?.illum),
        illum:d.moon?.phase?.illum??null,
        riseISO:d.moon?.riseISO||null,
        setISO:d.moon?.setISO||null,
        transitISO:d.moon?.transitISO||null,
        underfootISO:d.moon?.underfootISO||null
      },
      sun:{
        riseISO:d.sun?.riseISO||null,
        setISO:d.sun?.setISO||null
      }
    };
  });

  const todayKey = localISO(new Date(), tz);
  const astroToday = astroByDate[todayKey];
  const todayDay = daily[0]?.day || {};
  cur.sunrise = astroToday?.sun?.riseISO || todayDay.sunriseISO || null;
  cur.sunset  = astroToday?.sun?.setISO  || todayDay.sunsetISO  || null;

  // Rain totals (today/yesterday = WU; longer = XW obs from Jan 1)
  const rain = await computeRainTotals(cur);

  renderCurrent(cur, todayDay, todayKey);
  renderAdvice(cur, todayDay, rain.today, new Date());
  renderForecastCards(daily, todayKey);
  renderRainPanel(rain);
  await renderFishingPanels();

  $('loader').style.display='none'; $('mainContent').style.display='';
}

function groupDayNight(perArr){
  const byDate = {};
  (perArr||[]).forEach(per=>{
    const d = per.dateTimeISO.slice(0,10);
    if (!byDate[d]) byDate[d] = {date:d, list:[]};
    byDate[d].list.push(per);
  });
  return Object.values(byDate).sort((a,b)=> (a.date<b.date?-1:1)).map(x=>{
    const [day,night] = x.list;
    return { date:x.date, day, night };
  });
}

function pressureTrend(){
  if (pressureBuf.length<2) return null;
  const s=pressureBuf.slice().sort((a,b)=>a.time-b.time);
  const d=s[s.length-1].value - s[0].value;
  if (Math.abs(d)<0.5) return "steady";
  return d>0?"rising":"falling";
}

/* Moon SVG */
function moonSVG(name, illum){
  const pct = Math.max(0, Math.min(100, Number(illum||0)));
  const waxing = /wax/i.test(name)||(!/wan/i.test(name)&&pct<50);
  const rad = 20, cx=20, cy=20;
  const w = (pct/100)*40;
  const left = waxing ? cx - w/2 : cx - (40 - w)/2;
  const right= waxing ? cx + w/2 : cx + (40 - w)/2;
  const shineLeft = Math.max(0,left), shineRight=Math.min(40,right);
  const arc = `M ${shineLeft} ${cy} A ${rad} ${rad} 0 1 0 ${shineRight} ${cy} A ${rad} ${rad} 0 1 0 ${shineLeft} ${cy} Z`;
  const svg = `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
    <circle cx="${cx}" cy="${cy}" r="${rad}" fill="#223241"/>
    <path d="${arc}" fill="#f5f7fb"/>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function renderCurrent(p, todayDay, todayKey){
  const icon = iconUrl(todayDay);
  const windVal = (p.windSpeed!=null)?Number(p.windSpeed).toFixed(1):null;
  const gustVal = (p.windGust!=null)?Number(p.windGust).toFixed(1):null;
  const windDirCard = (typeof p.windDir==='number')?degToCardinal(p.windDir):(typeof p.windDir==='string'?p.windDir:"");
  let windTxt="—"; if(windVal!==null) windTxt = (windVal<0.6)?"Calm":`${windVal} / ${gustVal||windVal} km/h ${windDirCard?`(${windDirCard})`:""}`;
  let pressTxt = (p.pressure!=null)?`${Number(p.pressure).toFixed(1)} hPa`:"—"; const tr=pressureTrend(); if(tr) pressTxt+=` (${tr})`;

  const astro = astroByDate[todayKey]; const m=astro?.moon;
  const moonTxt = m ? `${m.name}${m.illum!=null?` • ${m.illum}%`:``}` : "—";
  const moonImg = m ? `<img src="${moonSVG(m.name,m.illum)}" alt="moon" style="width:40px;height:40px;display:block;margin-top:2px;">`:"";

  const grid = [
    ["Feels Like", (p.feelslike!=null)?to1(p.feelslike)+"°C":"—"],
    ["Weather", todayDay?.weather||"—"],
    ["Rain Rate", (p.precipRate!=null)?to1(p.precipRate)+" mm/hr":"—"],
    ["Humidity", (p.humidity!=null)?Math.round(p.humidity)+"%":"—"],
    ["Wind / Gust", windTxt],
    ["Pressure", pressTxt],
    ["Dew Point", (p.dewpt!=null)?`${to1(p.dewpt)}°C`:"—"],
    ["Visibility", (p.visibility!=null)?`${to1(p.visibility)} km`:"—"],
    ["Solar", (p.solarRadiation!=null)?`${p.solarRadiation} W/m²`:"—"],
    ["UV", (p.uv!=null)?p.uv:"—"],
    ["Sunrise", safeHM(p.sunrise)],
    ["Sunset",  safeHM(p.sunset)]
  ].map(([k,v])=>`<div class="current-field"><span class="current-label">${k}:</span> ${v}</div>`).join("");

  $('currentBlock').innerHTML = `
    <div class="current-left">
      <img class="current-icon" src="${icon}" alt="icon"/>
      <div class="current-temp-big">${(p.temp!=null)?to1(p.temp)+"°C":"—"}</div>
      ${moonImg}
      <div class="moon-line">Moon: ${moonTxt}</div>
    </div>
    <div class="current-details">
      <div class="current-temp-label">Current conditions</div>
      <div class="current-grid">${grid}</div>
    </div>`;
}

/* Kiwi advice – varied & seasonal */
function renderAdvice(p, todayDay, rainToday, now){
  const month = (now||new Date()).getMonth()+1;
  const winter = (month>=6 && month<=8), summer=(month>=12||month<=2);
  const bits = new Set();

  const add=(s)=>{ if(s) bits.add(s); };

  if (rainToday>10) add("Heavy rain so far — watch low spots and farm tracks.");
  else if (rainToday>2) add("Showery — take the jacket.");
  if ((p.windGust??0)>35) add("Windy — tie things down.");
  else if ((p.windGust??0)>20) add("Breezy at times.");
  if ((p.temp??99)<6 && winter) add("Frost risk at dawn.");
  if ((p.uv??0)>=7 && summer) add("High UV — slap on sunblock.");
  if (pressureTrend()==="falling") add("Barometer easing — changeable later.");
  if (!bits.size) add("Looks settled this morning.");

  $('adviceBlock').textContent = Array.from(bits).join(" ");
}

function renderForecastCards(dailyArr){
  const row=$('forecastRow'); row.innerHTML='';
  dailyArr.slice(0,7).forEach((d,idx)=>{
    const per = d.day || d.night || {};
    const astro=astroByDate[d.date]; const moon=astro?.moon;
    const moonLine = moon ? `Moon: ${moon.name}` : '';
    const min = (d.day?.minTempC ?? d.night?.minTempC ?? null);
    const max = (d.day?.maxTempC ?? d.night?.maxTempC ?? null);
    const card=document.createElement('div');
    card.className='forecast-card'; card.dataset.index=String(idx);
    card.innerHTML=`
      <div class="forecast-day">${fmtDay(d.date+"T12:00:00")}</div>
      <img class="forecast-icon" src="${iconUrl(per)}" alt="icon"/>
      <div class="forecast-summary">${(d.day?.weather || per.weather || "—")}</div>
      <div class="forecast-temps">${max!=null?to1(min):"—"}–${max!=null?to1(max):"—"}°C</div>
      <div class="forecast-rain">Rain: ${to1(d.day?.precipMM ?? per.precipMM)} mm • POP ${(d.day?.pop ?? per.pop ?? "—")}%</div>
      <div class="forecast-moon">${moonLine}</div>`;
    card.addEventListener('click',()=>showForecastDetails(idx));
    row.appendChild(card);
  });
}

function showForecastDetails(index){
  const d = daily[index] || {};
  const day = d.day || {};
  const night = d.night || {};
  const k = d.date;
  const astro = astroByDate[k];
  const m = astro?.moon;
  const moonTxt = m ? `${m.name}${(m.illum!=null?` (${m.illum}% illum)`:"")}` : "—";
  const sunrise = astro?.sun?.riseISO || day.sunriseISO || null;
  const sunset  = astro?.sun?.setISO  || day.sunsetISO  || null;

  const summary = makeDailySummary(day, night, new Date(k));
  const moonImg = m ? `<img src="${moonSVG(m.name,m.illum)}" alt="moon" style="width:40px;height:40px;vertical-align:middle;margin-bottom:-8px;">`:"";

  const popup=$('modalPopup');
  popup.innerHTML=`
    <button class="modal-close-btn" onclick="closeModal()">&times;</button>
    <div class="modal-header">${fmtFull(k+"T12:00:00")}</div>
    <div class="modal-details">
      <b>Moon:</b> ${moonImg} ${moonTxt}<br><br>

      <b>Day</b><br>
      <img class="forecast-icon" src="${iconUrl(day)}" alt="day icon"/>
      ${day.weather||"—"}<br>
      Temp: ${to1(day.maxTempC ?? night.maxTempC)}°C / ${to1(day.minTempC ?? night.minTempC)}°C<br>
      Wind: ${(day.windSpeedMinKPH??"—")}–${(day.windSpeedMaxKPH??"—")} km/h (${day.windDirMin!=null?degToCardinal(day.windDirMin):""}${day.windDirMax!=null?"–"+degToCardinal(day.windDirMax):""})<br>
      Rain: ${to1(day.precipMM)} mm • POP ${(day.pop??"—")}% • UV ${(day.uvi??"—")}<br>
      Sunrise: ${safeHM(sunrise)} • Sunset: ${safeHM(sunset)}<br>
      <br>

      <b>Night</b><br>
      <img class="forecast-icon" src="${iconUrl(night)}" alt="night icon"/>
      ${night.weather||"—"}<br>
      Temp: ${to1(night.maxTempC ?? day.maxTempC)}°C / ${to1(night.minTempC ?? day.minTempC)}°C<br>
      Wind: ${(night.windSpeedMinKPH??"—")}–${(night.windSpeedMaxKPH??"—")} km/h (${night.windDirMin!=null?degToCardinal(night.windDirMin):""}${night.windDirMax!=null?"–"+degToCardinal(night.windDirMax):""})<br>
      Rain: ${to1(night.precipMM)} mm • POP ${(night.pop??"—")}%<br>
      <hr>
      <b>Summary:</b> ${summary}
    </div>`;
  $('modalBg').style.display='flex';
}
function closeModal(){ $('modalBg').style.display='none'; }

function makeDailySummary(day, night, dateObj){
  const month = dateObj.getMonth()+1;
  const isWinter = (month>=6 && month<=8);
  const isSpring = (month>=9 && month<=11);
  const isSummer = (month==12 || month<=2);
  const max = Number(day?.maxTempC ?? night?.maxTempC ?? NaN);
  const min = Number(day?.minTempC ?? night?.minTempC ?? NaN);
  const pop = Math.max(Number(day?.pop ?? 0), Number(night?.pop ?? 0));
  const wind = Math.max(Number(day?.windSpeedMaxKPH ?? 0), Number(night?.windSpeedMaxKPH ?? 0));
  const bits=[];
  if (!isNaN(max) && !isNaN(min)){
    const swing = max - min;
    bits.push(`${isWinter?"Cool":(isSummer?"Warm":"Mild")} ${Math.round(max)}°/${Math.round(min)}°`);
    if (swing >= 10) bits.push("big temp swing");
  }
  if (pop>=60) bits.push("wet at times");
  else if (pop>=30) bits.push(isSpring?"chance of showers":"a few showers");
  else bits.push("mainly dry");
  if (wind>=45) bits.push("windy — take care");
  else if (wind>=25) bits.push("breezy");
  return bits.join(", ") + ".";
}

/* ---- Rain totals ----
   WU for today/yesterday; longer via XWeather obs (same PWS) */
async function computeRainTotals(cur){
  const now = new Date();
  const fromYTD = `${now.getFullYear()}-01-01`;
  const toISO = localISO(now);
  const his = await get(xwObs(xwStationId,fromYTD,toISO),12000);
  let byDay = {};
  (his?.response?.[0]?.periods||[]).forEach(p=>{
    const d = (p.dateTimeISO||"").slice(0,10);
    byDay[d] = (byDay[d]||0) + (Number(p.precipMM)||0);
  });
  const keyToday = localISO(now);
  const key7ago = localISO(new Date(now.getTime()-6*86400e3));
  const key30ago= localISO(new Date(now.getTime()-29*86400e3));
  const last7 = sumRange(byDay,key7ago,keyToday);
  const last30= sumRange(byDay,key30ago,keyToday);
  const ytd   = sumRange(byDay,fromYTD,keyToday);

  const todayWU = Number(cur.precipTotalToday||0);
  let yestWU = (cur.precipTotalLast24h!=null)?Number(cur.precipTotalLast24h):null;
  if (yestWU==null){
    const yKey = localISO(new Date(now.getTime()-86400e3));
    yestWU = byDay[yKey]||0;
  }
  return {today:todayWU,yesterday:yestWU,last7,last30,ytd};
}
function sumRange(map,fromISO,toISO){
  const from=new Date(fromISO+"T00:00:00"), to=new Date(toISO+"T23:59:59");
  let tot=0;
  for(const k in map){ const d=new Date(k+"T12:00:00"); if(d>=from && d<=to) tot+=Number(map[k]||0); }
  return Number(tot.toFixed(1));
}

/* ---- RAIN PANEL ---- */
function renderRainPanel(r){
  $('rainPanel').innerHTML = `
    <span class="rain-label">Rainfall Totals</span><br>
    Today: <b>${to1(r.today)} mm</b><br>
    Yesterday: <b>${to1(r.yesterday)} mm</b><br>
    Last 7 days: <b>${to1(r.last7)} mm</b><br>
    Last 30 days: <b>${to1(r.last30)} mm</b><br>
    Year-to-date: <b>${Math.round(r.ytd)} mm</b><br>
    <span style="font-size:.95em;opacity:.7;">*Today / yesterday from your WU station. Longer totals from your station’s history via XWeather.</span>`;
}

/* ---- Fishing, Tides & Swell ---- */
async function renderFishingPanels(){
  const f0 = daily[0]?.day || {};
  const mar0 = await getMarine(activeFishingKey);
  const rating0 = rateFishing(f0, mar0);
  $('fishRowVal').textContent = `${rating0.label} — ${rating0.note}`;
  await renderFishingPanelFull();
}

async function renderFishingPanelFull(){
  const panel=$('fishingPanel');
  panel.innerHTML=`
    <div class="fish-headline">Fishing, Tides & Swell</div>
    <div class="fish-switch">
      <span>Coromandel</span>
      <label class="switch"><input id="fishToggle" type="checkbox" ${activeFishingKey==='whangapoua'?'checked':''}><span class="slider"></span></label>
      <span>Whangapoua</span>
    </div>
    <div id="fishRating" class="fish-rating"></div>
    <div id="fishNote" class="fish-note"></div>
    <div id="fishMarine"></div>
    <div id="tideWrap"></div>
    <div id="swellWrap" class="fish-swell"></div>
    <div id="fishOutlook" class="fish-outlook"></div>`;
  $('fishToggle').addEventListener('change',async(e)=>{activeFishingKey=e.target.checked?'whangapoua':'coromandel'; await renderFishingPanelFull();});

  /* “Tide-like” table from moon (approx) with coastal offsets */
  const rows=(Object.keys(astroByDate).sort()).slice(0,14).map(k=>{
    const off = tideOffsets[activeFishingKey]||{high:0,low:0};
    const m=astroByDate[k]?.moon||{};
    const adj=(iso,mins)=> iso?new Date(new Date(iso).getTime()+mins*60000).toISOString():null;
    const highs=[adj(m.transitISO,off.high),adj(m.underfootISO,off.high)].filter(Boolean).map(safeHM).join(', ')||'—';
    const lows =[adj(m.riseISO,off.low),   adj(m.setISO,off.low)].filter(Boolean).map(safeHM).join(', ')||'—';
    const phase = m.name?`${m.name}${(m.illum!=null?` (${m.illum}% illum)`:``)}`:'—';
    const d=new Date(k+"T12:00:00");
    const dayTxt=d.toLocaleDateString('en-NZ',{weekday:'short',month:'short',day:'numeric'});
    return `<tr><td style="padding:6px 4px;">${dayTxt}</td><td style="padding:6px 4px;">${highs}</td><td style="padding:6px 4px;">${lows}</td><td style="padding:6px 4px;">${phase}</td></tr>`;
  }).join('');
  $('tideWrap').innerHTML=`<table class="tide-table"><thead><tr><th>Day</th><th>High (approx)</th><th>Low (approx)</th><th>Moon</th></tr></thead><tbody>${rows}</tbody></table><div class="tide-note">*Windows inferred from moon transit/underfoot (highs) and moonrise/set (lows) with local offset. For navigation, use official tide tables.</div>`;

  // Marine snapshot + rating
  const mar = await getMarine(activeFishingKey);
  const label = fishingSites[activeFishingKey].label;
  $('fishMarine').textContent = `Marine (${label}, ~1hr): ${mar.text}`;
  const rating = rateFishing(daily[0]?.day||{}, mar);
  $('fishRating').textContent=`Fishing: ${rating.label}`; $('fishRating').style.color=rating.color; $('fishNote').textContent=rating.note;

  // 7-day fishing outlook
  const outlook = daily.slice(0,7).map(d=>{
    const r = rateFishing(d.day||d.night||{}, mar);
    const wd = new Date(d.date+"T12:00:00").toLocaleDateString('en-NZ',{weekday:'short'});
    return `${wd}: ${r.label}`;
  }).join(' • ');
  $('fishOutlook').textContent = `7-day fishing outlook: ${outlook}`;

  // Swell snapshot (static image or link)
  const siteMeta = fishingSites[activeFishingKey];
  const img=document.createElement('img');
  img.alt=`${siteMeta.label} Swell`;
  img.src=`https://www.swellmap.com/static/surf/forecasts/${siteMeta.swellSlug}/${siteMeta.swellSlug}-surf-forecast-large.png`;
  img.onerror=()=>{$('swellWrap').innerHTML=`<a href="${siteMeta.altLink}" target="_blank" rel="noopener">Open Swellmap for ${siteMeta.label}</a>`;};
  $('swellWrap').innerHTML=''; $('swellWrap').appendChild(img);
}

async function getMarine(siteKey){
  const id = fishingSites[siteKey].maritimeId;
  let p=null;
  if (id){
    const mar = await get(xwMarineId(id),9000);
    p = mar?.response?.[0]?.periods?.[0] || mar?.response?.[0] || null;
  }
  if (!p){
    const closest = await get(xwMarineClosest(siteCoords[siteKey]),9000);
    p = closest?.response?.[0]?.periods?.[0] || closest?.response?.[0] || null;
  }
  const waveM = firstNum([p?.waveHeightM, p?.significantWaveHeightM, p?.seaHeightM, p?.waveHeight]);
  const swlP  = firstNum([p?.swellPeriodS, p?.swellPeriod, p?.wavePeriodS, p?.wavePeriod]);
  const swlD  = p?.swellDir || p?.primarySwellDirection || p?.waveDir || null;
  const windKts = firstNum([p?.windSpeedKTS, p?.windKts]);
  const windKph = firstNum([p?.windSpeedKPH, p?.windSpeedKMH]);
  const txt = `Wave ${waveM!=null?to1(waveM):"—"} m, Swell ${swlP!=null?to1(swlP):"—"} s${swlD? " "+swlD:""}, Wind ${windKts!=null?to1(windKts)+" kt":(windKph!=null?to1(windKph)+" km/h":"—")}`;
  return {waveM, swlP, swlD, windKts, windKph, text:txt};
}
function firstNum(arr){ for(const v of arr){ if(v!=null && !isNaN(Number(v))) return Number(v); } return null; }

function rateFishing(f,marine){
  const pop=Number(f?.pop??0);
  const wind=Number(f?.windSpeedMaxKPH??0);
  const wave=(marine&&marine.waveM!=null)?Number(marine.waveM):null;
  const sp=(marine&&marine.swlP!=null)?Number(marine.swlP):null;
  let score=0;
  if (wind<10) score+=2; else if (wind<=20) score+=1; else if (wind>25) score-=2; else score-=1;
  if (pop<=20) score+=2; else if (pop<=50) score+=0; else score-=2;
  if (wave!=null){ if (wave<=1.0) score+=2; else if (wave<=1.5) score+=1; else if (wave>2) score-=2; else score-=1; }
  if (sp!=null){ if (sp>10) score+=1; else if (sp<7) score-=1; }
  if (score<=-1) return {label:"Bad",color:"#c0392b",note:"Strong wind or messy swell; sheltered spots only."};
  if (score<= 1) return {label:"Fair",color:"#e67e22",note:"Usable windows; pick calmer periods."};
  if (score<= 3) return {label:"Good",color:"#27ae60",note:"Light winds and manageable swell."};
  return {label:"Excellent",color:"#2ecc71",note:"Calm winds, low seas; best near tide changes."};
}

/* ---------- FAIL-SAFE & DEBUG ---------- */
function showDebug(msg){
  let el = document.getElementById('debugBanner');
  if (!el){
    el = document.createElement('div');
    el.id = 'debugBanner';
    el.style.cssText = 'position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:#fff4d6;border:1px solid #f0c36d;border-radius:8px;padding:8px 10px;color:#5c3b00;font:14px/1.35 system-ui,Segoe UI,Arial;box-shadow:0 2px 10px #0002';
    document.body.appendChild(el);
  }
  el.innerHTML = `<b>Debug:</b> ${msg}`;
}
async function safeStart(){
  try { await start(); }
  catch(e){ console.error('start() failed:', e); showDebug(e && e.message ? e.message : String(e)); }
  finally{
    const loader = document.getElementById('loader');
    const main   = document.getElementById('mainContent');
    if (loader) loader.style.display = 'none';
    if (main)   main.style.display   = '';
  }
}
window.addEventListener('load', safeStart);
window.addEventListener('unhandledrejection', (ev)=>{
  console.error('Unhandled rejection:', ev.reason);
  showDebug('Unhandled promise rejection: ' + (ev.reason?.message || ev.reason));
});
window.addEventListener('error', (ev)=>{
  console.error('Window error:', ev.error || ev.message);
  showDebug('Script error: ' + (ev.error?.message || ev.message));
});
</script>
</body>
</html>