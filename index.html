<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NZ Weather</title>
  <style>
    body {
      margin: 0; padding: 0; background: #181818; color: #fff; font-family: Arial, sans-serif;
    }
    .main-container { max-width: 450px; margin: auto; padding: 1rem; }
    .main-card {
      background: #232323; border-radius: 20px; box-shadow: 0 2px 24px #0008;
      margin-top: 1.2rem; padding: 2rem 1rem 1rem 1rem; text-align: center;
    }
    .city { font-size: 1.35rem; font-weight: bold; letter-spacing: 1px; margin-bottom: 0.5rem; }
    .weather-icon { width: 90px; height: 90px; display: block; margin: 0 auto; }
    .temp { font-size: 3.5rem; font-weight: bold; color: #ffd700; }
    .summary { font-size: 1.3rem; font-weight: 400; margin: 0.5rem 0; color: #fff;}
    .row { display: flex; justify-content: space-between; margin: 0.3rem 0; font-size: 1rem;}
    .card {
      background: #222; border-radius: 16px; margin: 1rem 0 0 0; padding: 1.1rem;
      box-shadow: 0 1px 6px #0006;
    }
    .advice { font-size: 1.1rem; font-style: italic; color: #ddd; margin-bottom: 0.3rem; }
    .tab-btns { display: flex; gap: 1rem; justify-content: center; margin: 1.2rem 0 0.2rem 0;}
    .tab-btn { background: #333; color: #fff; padding: 0.6rem 1.6rem; border-radius: 20px; border: none; font-size: 1rem; cursor: pointer; transition: background 0.2s;}
    .tab-btn.active, .tab-btn:hover { background: #ffd700; color: #232323; }
    .forecast-row { display: flex; gap: 1.2rem; overflow-x: auto; padding-bottom: 0.2rem;}
    .forecast-card {
      flex: 0 0 80px; background: #232323; border-radius: 16px;
      text-align: center; margin-bottom: 0.6rem; cursor: pointer; padding: 0.7rem 0.2rem;
      transition: box-shadow 0.15s;
    }
    .forecast-card:hover { box-shadow: 0 2px 12px #000a;}
    .fc-day { font-weight: 700; }
    .fc-temp { font-weight: 500; margin: 0.2rem 0; font-size: 1.2rem;}
    .fc-summary { font-size: 0.9rem; color: #ccc;}
    .extras { margin-top: 1.5rem; }
    .extras-row { display: flex; gap: 1.3rem; justify-content: center; font-size: 0.97rem;}
    .extras-item { background: #232323; border-radius: 10px; padding: 0.7rem 1rem; }
    .rainfall-btn { margin: 1.5rem auto 0 auto; display: block; background: #232323; color: #fff; font-size: 1.1rem; border-radius: 18px; border: none; padding: 0.7rem 1.7rem; box-shadow: 0 1px 7px #0003; cursor: pointer; }
    .rainfall-btn:hover { background: #ffd700; color: #232323; }
    .bottom { text-align: center; color: #888; font-size: 0.8rem; margin: 1.5rem 0 0 0; }
    /* Modal full-screen overlay */
    .modal-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1000; background: #181818ee; display: flex; justify-content: center; align-items: center;}
    .modal-content { background: #222; border-radius: 16px; padding: 2rem 1.2rem 1.2rem 1.2rem; max-width: 96vw; width: 390px; box-shadow: 0 2px 20px #0009; position: relative; }
    .modal-close { position: absolute; top: 13px; right: 17px; font-size: 2rem; color: #fff; cursor: pointer; }
    .rain-chart { width: 100%; height: 120px; display: flex; gap: 7px; align-items: flex-end; margin-top: 1.2rem;}
    .rain-bar { background: #40a5fa; width: 24px; border-radius: 8px 8px 0 0; position: relative;}
    .rain-bar-label { position: absolute; bottom: -22px; width: 100%; text-align: center; font-size: 0.85rem; color: #fff; }
    .rain-bar-val { position: absolute; top: -26px; width: 100%; text-align: center; font-size: 0.9rem; color: #ffd700;}
    .rain-totals { margin-top: 1.2rem; font-size: 1.1rem; color: #fff;}
    .rain-totals span { color: #ffd700; }
    @media (max-width: 510px) { .main-container { padding: 0.2rem; } .main-card, .card, .modal-content { padding: 1rem 0.3rem; } }
  </style>
</head>
<body>
<div class="main-container">
  <div class="main-card" id="mainCard">
    <div class="city" id="cityName">Loading...</div>
    <img id="mainIcon" class="weather-icon" style="display:none;">
    <div class="temp" id="mainTemp"></div>
    <div class="summary" id="mainSummary"></div>
    <div id="mainDetails"></div>
  </div>
  <div class="advice" id="advice"></div>
  <div class="tab-btns">
    <button class="tab-btn active" id="tabForecast">Forecast</button>
    <button class="tab-btn" id="tabRain">Rainfall</button>
  </div>
  <div class="card" id="tabContent"></div>
  <div class="extras">
    <div class="extras-row" id="extrasRow"></div>
    <button class="rainfall-btn" onclick="showRainfallModal()">☔ Rainfall History</button>
  </div>
  <div class="bottom">Data by Vaisala Xweather</div>
</div>
<div id="modalBG" class="modal-bg" style="display:none;">
  <div class="modal-content" id="modalContent"></div>
  <div class="modal-close" onclick="closeModal()">&times;</div>
</div>
<script>
const clientId = "U8feQfLlcEfcXDfsWZs4C";
const clientSecret = "HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";
const apiBase = "https://data.api.xweather.com";

// === Helper functions ===
function iconUrl(icon) {
  return `https://cdn.aerisapi.com/wxblox/icons/${icon || "na.png"}`;
}
function dayName(dateISO) {
  let d = new Date(dateISO);
  return d.toLocaleDateString('en-NZ', {weekday:'short'});
}
function pad(n) { return n < 10 ? '0'+n : n; }
function showRainfallModal() {
  document.getElementById('modalBG').style.display = '';
  document.getElementById('modalContent').innerHTML = rainModalHtml;
}
function closeModal() { document.getElementById('modalBG').style.display='none'; }
// ===============

// =========== Data Fetch Logic ===========
let userLat, userLon, cityName = "Loading...", rainModalHtml = "";

function setCity(c) {
  cityName = c;
  document.getElementById("cityName").textContent = cityName;
}
function getLocationAndLoad() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      fetchCityName(userLat, userLon);
      loadWeather(userLat, userLon);
    }, () => {
      // Default to Auckland CBD
      userLat = -36.8485; userLon = 174.7633;
      setCity("Auckland");
      loadWeather(userLat, userLon);
    });
  } else {
    userLat = -36.8485; userLon = 174.7633;
    setCity("Auckland");
    loadWeather(userLat, userLon);
  }
}
function fetchCityName(lat, lon) {
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
    .then(res => res.json())
    .then(j => {
      let city = j.address.city || j.address.town || j.address.village || j.address.state_district || "New Zealand";
      setCity(city);
    })
    .catch(() => setCity("New Zealand"));
}
function loadWeather(lat, lon) {
  // Conditions
  fetch(`${apiBase}/conditions/${lat},${lon}?format=json&client_id=${clientId}&client_secret=${clientSecret}`)
    .then(r=>r.json()).then(j=>{
      let ob = j.response && j.response[0] && j.response[0].periods[0];
      if (!ob) return setMainCardUnavailable();
      document.getElementById("mainIcon").src = iconUrl(ob.icon);
      document.getElementById("mainIcon").style.display = '';
      document.getElementById("mainTemp").textContent = Math.round(ob.tempC)+"°";
      document.getElementById("mainSummary").textContent = ob.weatherPrimary || ob.weather || "";
      document.getElementById("mainDetails").innerHTML =
        `<div class="row"><span>Feels:</span><span>${Math.round(ob.feelslikeC)}°</span></div>
         <div class="row"><span>Humidity:</span><span>${ob.humidity}%</span></div>
         <div class="row"><span>Wind:</span><span>${ob.windSpeedKPH||0} km/h ${ob.windDir||""}</span></div>
         <div class="row"><span>Pressure:</span><span>${ob.pressureMB||""} hPa</span></div>
         <div class="row"><span>Sunrise:</span><span>${(ob.sunriseISO||"").slice(11,16)}</span></div>
         <div class="row"><span>Sunset:</span><span>${(ob.sunsetISO||"").slice(11,16)}</span></div>`;
    })
    .catch(() => setMainCardUnavailable());
  // Forecast
  fetch(`${apiBase}/forecasts/${lat},${lon}?format=json&filter=day&limit=7&fields=periods.dateTimeISO,periods.maxTempC,periods.minTempC,periods.icon,periods.weatherPrimary&client_id=${clientId}&client_secret=${clientSecret}`)
    .then(r=>r.json()).then(j=>{
      let fc = j.response && j.response[0] && j.response[0].periods;
      if (!fc) return document.getElementById("tabContent").innerHTML = "<div style='text-align:center;'>Forecast not available.</div>";
      document.getElementById("tabContent").innerHTML =
        `<div class="forecast-row">` +
        fc.map(day =>
          `<div class="forecast-card">
             <div class="fc-day">${dayName(day.dateTimeISO)}</div>
             <img src="${iconUrl(day.icon)}" width="44" style="margin:0.2rem 0">
             <div class="fc-temp">${Math.round(day.maxTempC)}°/${Math.round(day.minTempC)}°</div>
             <div class="fc-summary">${day.weatherPrimary||""}</div>
           </div>`
        ).join('') +
        `</div>`;
    });
  // Rainfall History
  fetch(`${apiBase}/conditions/summary/${lat},${lon}?format=json&from=${new Date(Date.now()-7*864e5).toISOString().slice(0,10)}&to=${new Date().toISOString().slice(0,10)}&client_id=${clientId}&client_secret=${clientSecret}`)
    .then(r=>r.json()).then(j=>{
      let days = j.response && j.response[0] && j.response[0].periods;
      if (!days) return rainModalHtml = "<div>Rainfall data not available.</div>";
      let max = Math.max(...days.map(d=>d.precip?.totalMM||0));
      rainModalHtml =
        `<div style="font-size:1.3rem;text-align:center;">Rainfall - Last 7 Days</div>
         <div class="rain-chart">` +
        days.map(d=>`<div class="rain-bar" style="height:${(d.precip?.totalMM||0)/max*100||2}%">
          <div class="rain-bar-val">${(d.precip?.totalMM||0).toFixed(1)}mm</div>
          <div class="rain-bar-label">${dayName(d.dateTimeISO)}</div>
        </div>`).join('') + `</div>
        <div class="rain-totals">
          Past 7 days: <span>${days.reduce((a,b)=>a+(b.precip?.totalMM||0),0).toFixed(1)}mm</span>
        </div>`;
    });
  // AI Advice
  document.getElementById("advice").textContent = getAdvice();
  // Extras
  document.getElementById("extrasRow").innerHTML =
    `<div class="extras-item" id="lightningInfo">Lightning: --</div>
     <div class="extras-item" id="roadInfo">Road: --</div>
     <div class="extras-item" id="alertInfo">Alert: --</div>`;
  // Lightning
  fetch(`${apiBase}/lightning/${lat},${lon}?format=json&filter=all&limit=10&client_id=${clientId}&client_secret=${clientSecret}`)
    .then(r=>r.json()).then(j=>{
      let l = j.response ? j.response.length : 0;
      document.getElementById("lightningInfo").textContent = "Lightning: " + (l ? l+" strikes" : "None");
    });
  // Road
  fetch(`${apiBase}/roadweather/${lat},${lon}?client_id=${clientId}&client_secret=${clientSecret}`)
    .then(r=>r.json()).then(j=>{
      let c = j.response && j.response[0] && j.response[0].periods && j.response[0].periods[0] && j.response[0].periods[0].summary;
      document.getElementById("roadInfo").textContent = "Road: " + (c||"N/A");
    });
  // Alerts
  fetch(`${apiBase}/alerts/${lat},${lon}?format=json&limit=1&client_id=${clientId}&client_secret=${clientSecret}`)
    .then(r=>r.json()).then(j=>{
      let a = j.response && j.response[0] && j.response[0].details && j.response[0].details.headline;
      document.getElementById("alertInfo").textContent = "Alert: " + (a||"None");
    });
}
function setMainCardUnavailable() {
  document.getElementById("mainTemp").textContent = "--";
  document.getElementById("mainSummary").textContent = "Weather unavailable";
  document.getElementById("mainDetails").innerHTML = "";
}
function getAdvice() {
  // Returns a daily rotating weather advice
  const advs = [
    "Stay hydrated and enjoy the day!",
    "Check for local weather alerts before heading out.",
    "Keep an umbrella handy—just in case.",
    "Layer up if heading out early.",
    "Remember sun protection, even on cloudy days.",
    "Ideal weather for a short walk or cuppa.",
    "Check rainfall tab for recent history and trends."
  ];
  let i = (new Date()).getDate() % advs.length;
  return advs[i];
}
// === Tabs logic ===
document.getElementById("tabForecast").onclick = function() {
  this.classList.add("active");
  document.getElementById("tabRain").classList.remove("active");
  document.getElementById("tabContent").style.display = "";
  // just triggers forecast reload (already loaded)
  loadWeather(userLat, userLon);
};
document.getElementById("tabRain").onclick = function() {
  this.classList.add("active");
  document.getElementById("tabForecast").classList.remove("active");
  // Show rainfall modal
  showRainfallModal();
  document.getElementById("tabContent").style.display = "none";
};
// === START ===
getLocationAndLoad();
</script>
</body>
</html>