<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>AgoraWeather NZ Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  html,body{margin:0;padding:0;background:#181e2a;color:#fff;font-family:'Segoe UI',Arial,sans-serif;}
  #main{max-width:500px;margin:0 auto;padding:0 2px 32px;}
  .block{background:#222c40;border-radius:13px;padding:13px 9px 15px 13px;margin:18px 0 24px;box-shadow:0 2px 14px #0007;}
  #loc{font-size:1.13rem;font-weight:600;margin-bottom:4px;letter-spacing:.01em;}
  .row{display:flex;align-items:center;justify-content:space-between;gap:14px;}
  .temp{font-size:2.7rem;font-weight:bold;letter-spacing:-.03em;}
  .icon{width:58px;height:58px;}
  .details{font-size:1.03rem;color:#c8daf7;margin:10px 0 4px;display:flex;flex-wrap:wrap;gap:12px 18px;}
  .details span{min-width:44%;}
  .advice-list{margin:10px 0 0;}
  .advice-tip{background:#253e62;color:#ffd25a;border-radius:7px;font-size:1.07rem;margin-bottom:8px;
    padding:8px 13px;font-weight:500;box-shadow:0 1px 8px #0002;line-height:1.32;text-align:left;}
  .tabs{display:flex;margin-bottom:7px;}
  .tab-btn{flex:1;padding:9px 0;background:#181e2a;color:#ffe180;border:none;border-radius:6px 6px 0 0;
    font-size:1.08rem;font-weight:600;margin-right:2px;cursor:pointer;}
  .tab-btn.active{background:#ffe180;color:#222c40;}
  #forecast-cards,#rain-block{display:none;}
  #forecast-cards.active,#rain-block.active{display:flex;flex-direction:column;gap:8px;}
  .forecast-card{background:#232f47;border-radius:9px;padding:11px 6px 11px 14px;display:flex;align-items:center;
    gap:11px;font-size:1rem;box-shadow:0 1px 4px #0002;cursor:pointer;}
  .forecast-card .day{font-weight:600;width:55px;color:#fff;}
  .forecast-card .ficon{width:36px;height:36px;}
  .forecast-card .info{flex:1 1 0;font-size:1rem;color:#dde5f3;line-height:1.25;}
  #rain-title{font-size:1.07rem;font-weight:600;color:#85e7ff;margin-bottom:8px;}
  #rainChart{width:100%;min-height:110px;max-width:490px;margin-bottom:10px;}
  .rain-summary{font-size:0.96rem;color:#ffe180;margin-top:7px;}
  .rain-extra{font-size:0.96rem;color:#aad7ff;}
  .rain-table{width:100%;margin-top:10px;border-spacing:0;}
  .rain-table th,.rain-table td{font-size:0.95rem;padding:2px 6px;}
  .rain-table th{text-align:left;color:#85e7ff;}
  .rain-table td{color:#dde5f3;}
  .wettest{color:#8ae995;font-weight:600;}
  .driest{color:#fddbdb;font-weight:600;}
  #popup-bg{position:fixed;inset:0;background:rgba(10,18,36,0.97);display:none;align-items:center;
    justify-content:center;z-index:9999;}
  #popup{background:#222c40;border-radius:17px;padding:22px 15px;color:#fff;max-width:380px;width:95vw;
    box-shadow:0 8px 36px #000c;position:relative;}
  #popup .close{position:absolute;top:7px;right:15px;font-size:2rem;color:#aad7ff;background:none;
    border:none;cursor:pointer;}
  #popup .pday{font-size:1.11rem;font-weight:bold;margin-bottom:4px;}
  #popup .pdesc{font-size:1.01rem;color:#ffe180;margin-bottom:7px;}
  .hourly-vert{margin-top:15px;max-height:400px;overflow-y:auto;}
  .hour-block{background:#181e2a;border-radius:7px;padding:9px 7px;margin-bottom:7px;
    display:flex;align-items:center;gap:12px;}
  .htime{font-size:1.06rem;color:#ffe180;font-weight:600;width:50px;}
  .hicon{width:32px;height:32px;}
  .hrow{font-size:0.98rem;color:#dde5f3;flex:1;display:flex;flex-wrap:wrap;gap:4px;}
  @media(max-width:600px){
    #main{padding:0 1px;}
    .block{padding:10px 3px 12px 7px;}
    .forecast-card .day{width:38px;}
    #popup{padding:13px 2px;}
  }
</style>
</head>
<body>
  <div id="main">
    <!-- current -->
    <div class="block" id="current">
      <div id="loc">Loading…</div>
      <div class="row">
        <span class="temp" id="temp">--°C</span>
        <img id="icon" class="icon" src="" alt=""/>
      </div>
      <div class="details" id="details"></div>
      <div class="advice-list" id="advice-list"></div>
    </div>

    <!-- forecast / rain -->
    <div class="block">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('forecast')">Forecast</button>
        <button class="tab-btn" onclick="switchTab('rain')">Rain History</button>
      </div>
      <div id="forecast-cards" class="active"></div>
      <div id="rain-block">
        <div id="rain-title">Rainfall History</div>
        <canvas id="rainChart"></canvas>
        <div class="rain-summary" id="rain-summary"></div>
        <div class="rain-extra"   id="rain-extra"></div>
        <table class="rain-table" id="rain-table"></table>
      </div>
    </div>
  </div>

  <!-- hourly popup -->
  <div id="popup-bg"><div id="popup"></div></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Helper functions
    const iconUrl = ic => ic
      ? `https://cdn.aerisapi.com/wxblox/icons/${ic}.svg`
      : '';
    const dayOfWeek = d => new Date(d).toLocaleDateString('en-NZ',{weekday:'short'});
    const cap = s => s? s[0].toUpperCase()+s.slice(1):'';

    function switchTab(tab){
      document.getElementById('forecast-cards').classList.toggle('active', tab==='forecast');
      document.getElementById('rain-block').    classList.toggle('active', tab==='rain');
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelector(`.tab-btn[onclick*="${tab}"]`).classList.add('active');
    }

    // Build AI advice (smarter NZ/local/seasonal)
    function aiAdvice(d){
      let tips = [];
      if(d.precipMM>=25) tips.push("Very heavy rain—avoid flood-prone roads.");
      else if(d.precipMM>=10) tips.push("Bring waterproofs—showers likely.");
      if(d.windSpeedKPH>=50) tips.push("Strong winds—secure loose items.");
      if(d.uvIndex>=7) tips.push("High UV—slip, slop, slap.");
      if(d.tempC>=30) tips.push("Heatwave—hydrate & stay cool.");
      if(d.tempC<=0) tips.push("Freezing—risk of black ice.");
      if([6,7,8].includes(d.month)) tips.push("Winter—layer up & heat home.");
      if([12,1,2].includes(d.month)) tips.push("Summer—wear sunscreen & drink water.");
      if(d.region && d.region.toLowerCase().includes('wellington') && d.windSpeedKPH>=35) tips.push("Windy Wellington day—brace for gusts!");
      tips.push("Weather changes fast—check again before leaving.");
      return [...new Set(tips)].slice(0,3);
    }

    function openPopup(day, all){
      const idx = all.find(p=>dayOfWeek(p.dateTimeISO)===day);
      if(!idx) return;
      const targetDay = new Date(idx.dateTimeISO).getDay();
      const hrs = all.filter(p=> new Date(p.dateTimeISO).getDay()===targetDay);

      let html = `<button class="close" onclick="closePopup()">&times;</button>
        <div class="pday">${dayOfWeek(idx.dateTimeISO)}, ${new Date(idx.dateTimeISO).toLocaleDateString('en-NZ')}</div>
        <div class="pdesc">${cap(idx.weather)}</div>`;
      aiAdvice({...idx,month:new Date(idx.dateTimeISO).getMonth()+1})
        .forEach(t=>html+=`<div class="advice-tip">${t}</div>`);
      html += `<div class="hourly-vert">`;
      hrs.forEach(h=>{
        html+=`
          <div class="hour-block">
            <div class="htime">${("0"+new Date(h.dateTimeISO).getHours()).slice(-2)}:00</div>
            <img class="hicon" src="${iconUrl(h.icon)}"/>
            <div>
              <div class="htemp">${Math.round(h.tempC)}°C</div>
              <div class="hrow">
                Wind ${Math.round(h.windSpeedKPH)}km/h | Rain ${h.precipMM}mm<br>
                Hum ${h.humidity}% | UV ${h.uvIndex||'--'} | Vis ${Math.round(h.visibilityKM)}km
              </div>
            </div>
          </div>`;
      });
      html+=`</div>`;
      document.getElementById('popup').innerHTML=html;
      document.getElementById('popup-bg').style.display='flex';
    }
    function closePopup(){document.getElementById('popup-bg').style.display='none';}

    // Geolocate
    async function getCoords(){
      return new Promise(res=>{
        navigator.geolocation?.getCurrentPosition(
          p=>res({lat:p.coords.latitude,lon:p.coords.longitude}),
          ()=>res(null),
          {timeout:7000}
        );
      });
    }

    (async()=>{
      const coords = await getCoords();
      const BASE   = 'https://data.api.xweather.com';
      const AUTH   = 'client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq';

      // --- CURRENT ---
      const curUrl = coords
        ? `${BASE}/conditions/${coords.lat},${coords.lon}?format=json&plimit=1&filter=1min`+
          `&fields=loc,periods.dateTimeISO,periods.tempC,periods.feelslikeC,periods.dewpointC,`+
          `periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,`+
          `periods.weather,periods.icon,periods.precipMM,periods.pressureMB,periods.uvIndex,`+
          `periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&${AUTH}`
        : `${BASE}/conditions/:auto?format=json&plimit=1&filter=1min`+
          `&fields=loc,periods.dateTimeISO,periods.tempC,periods.feelslikeC,periods.dewpointC,`+
          `periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,`+
          `periods.weather,periods.icon,periods.precipMM,periods.pressureMB,periods.uvIndex,`+
          `periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&${AUTH}`;

      const curRes = await fetch(curUrl).then(r=>r.json()).catch(()=>null);
      const p      = curRes?.success ? curRes.response[0].periods[0] : {};
      const locRaw = curRes?.response?.[0]?.loc || {};
      const loc    = locRaw.city||locRaw.town||locRaw.region||locRaw.country||'Your Area';
      const region = locRaw.region||'';

      document.getElementById('loc').textContent = loc;
      document.getElementById('icon').src       = iconUrl(p.icon);
      document.getElementById('temp').textContent= p.tempC!=null?Math.round(p.tempC)+'°C':'--°C';

      const details = [
        `Feels: ${p.feelslikeC!=null?Math.round(p.feelslikeC)+'°C':'--'}`,
        `Humidity: ${p.humidity!=null?p.humidity+'%':'--'}`,
        `Wind: ${p.windDir? p.windDir+' '+Math.round(p.windSpeedKPH)+'km/h':'--'}`,
        `Gusts: ${p.windGustKPH!=null?Math.round(p.windGustKPH)+'km/h':'--'}`,
        `Pressure: ${p.pressureMB!=null?Math.round(p.pressureMB)+'hPa':'--'}`,
        `Dew Pt: ${p.dewpointC!=null?Math.round(p.dewpointC)+'°C':'--'}`,
        `Visibility: ${p.visibilityKM!=null?Math.round(p.visibilityKM)+'km':'--'}`,
        `Cloud: ${p.cloudsCoded?parseInt(p.cloudsCoded.replace(/\D/g,''))+'%':'--'}`,
        `UV: ${p.uvIndex!=null?p.uvIndex:'--'}`,
        `Sunrise: ${p.sunriseISO?new Date(p.sunriseISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):'--'}`,
        `Sunset: ${p.sunsetISO? new Date(p.sunsetISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):'--'}`
      ];
      document.getElementById('details').innerHTML = details.map(x=>`<span>${x}</span>`).join('');

      document.getElementById('advice-list').innerHTML =
        aiAdvice({ ...p, region, month:new Date().getMonth()+1 })
          .map(t=>`<div class="advice-tip">${t}</div>`).join('');

      // --- 7-DAY FORECAST (with hourly for each day on click) ---
      const fcUrl = coords
        ? `${BASE}/forecasts/${coords.lat},${coords.lon}?format=json&filter=all&limit=64`+
          `&fields=periods.dateTimeISO,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.tempC,`+
          `periods.windSpeedKPH,periods.windDir,periods.windGustKPH,periods.precipMM,periods.humidity,periods.uvIndex,periods.visibilityKM&${AUTH}`
        : `${BASE}/forecasts/:auto?format=json&filter=all&limit=64`+
          `&fields=periods.dateTimeISO,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.tempC,`+
          `periods.windSpeedKPH,periods.windDir,periods.windGustKPH,periods.precipMM,periods.humidity,periods.uvIndex,periods.visibilityKM&${AUTH}`;

      const fcRes = await fetch(fcUrl).then(r=>r.json()).catch(()=>null);
      const periods = fcRes?.success ? fcRes.response[0].periods : [];
      const days = periods.filter((_,i,a) => {
        // Pick only 1 entry per day for forecast cards (around midday)
        const dt = new Date(_.dateTimeISO); return dt.getHours()===12;
      });

      const fcDiv = document.getElementById('forecast-cards');
      fcDiv.innerHTML = '';
      days.forEach(d=>{
        const card = document.createElement('div');
        card.className = 'forecast-card';
        card.innerHTML = `
          <div class="day">${dayOfWeek(d.dateTimeISO)}</div>
          <img class="ficon" src="${iconUrl(d.icon)}"/>
          <div class="info">
            <div><b>${cap(d.weather)}</b></div>
            <div>${Math.round(d.maxTempC||d.tempC)}/${Math.round(d.minTempC||d.tempC)}°C</div>
            <div>Wind ${d.windDir||''} ${Math.round(d.windSpeedKPH||0)}km/h, Gusts ${Math.round(d.windGustKPH||0)}km/h</div>
            <div>Rain ${d.precipMM||0}mm • Hum ${d.humidity||'--'}%</div>
          </div>`;
        card.onclick = ()=>openPopup(dayOfWeek(d.dateTimeISO), periods);
        fcDiv.appendChild(card);
      });

      // --- RAIN HISTORY ---
      if(coords){
        const r7  = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&past_days=7&daily=precipitation_sum&timezone=auto`).then(r=>r.json()).catch(()=>null);
        const arr7= r7?.daily?.precipitation_sum || [];
        const sum7= arr7.reduce((a,b)=>a+b,0).toFixed(1);
        document.getElementById('rain-summary').innerHTML = `Past 7 days: <b>${sum7} mm</b>`;

        new Chart(document.getElementById('rainChart').getContext('2d'),{
          type:'bar',
          data:{
            labels: r7.daily.time.map(d=>d.substr(5)),
            datasets:[{ data:arr7, backgroundColor:'#85e7ff' }]
          },
          options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
        });

        let tbl = '<tr><th>Date</th><th>Rain mm</th></tr>';
        r7.daily.time.forEach((dt,i)=> tbl+=`<tr><td>${dt.substr(5)}</td><td>${arr7[i].toFixed(1)}</td></tr>`);
        document.getElementById('rain-table').innerHTML = tbl;
      } else {
        document.getElementById('rain-summary').textContent = 'Enable location to see rain history.';
      }
    })();
  </script>
</body>
</html>