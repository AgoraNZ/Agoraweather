<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>AgoraWeather NZ â€“ Blue Pro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    html,body{background:#181e2a;color:#fff;margin:0;padding:0;font-family:'Segoe UI',Arial,sans-serif;}
    #main{max-width:540px;margin:0 auto;padding:0 2px 48px 2px;}
    .block{background:#222c40;border-radius:13px;padding:16px 12px 18px 16px;margin:18px 0 22px 0;box-shadow:0 2px 12px #0007;}
    #loc{font-size:1.2rem;font-weight:700;margin-bottom:7px;letter-spacing:0.01em;color:#80bfff;}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .temp{font-size:2.7rem;font-weight:700;letter-spacing:-0.03em;}
    .icon{width:64px;height:64px;}
    .label-main{font-size:1.5rem;font-weight:600;line-height:1.13;color:#f8f7fa;margin-bottom:7px;}
    .details{font-size:1.03rem;color:#c8daf7;margin:11px 0 3px 0;display:flex;flex-wrap:wrap;gap:13px 18px;}
    .details span.label{color:#ffe180;font-weight:600;}
    .metrics{font-size:1.03rem;color:#a0bacd;margin:2px 0 0 0;display:flex;flex-wrap:wrap;gap:9px 14px;}
    .advice{background:#253e62;color:#ffd25a;border-radius:7px;font-size:1.11rem;margin-top:13px;padding:11px 16px;font-weight:500;box-shadow:0 1px 8px #0002;line-height:1.38;}
    .alert-badges{display:flex;flex-wrap:wrap;gap:7px 10px;margin:8px 0 0 0;}
    .alert-badge{background:#ffe180;color:#3d2b00;font-weight:700;border-radius:7px;padding:5px 10px;font-size:1.01rem;}
    #hazards{font-size:1.03rem;color:#85e7ff;margin:7px 0 0 1px;}
    #forecast-title{font-size:1.09rem;font-weight:700;margin:3px 0 10px 4px;color:#ffe180;}
    #forecast{display:flex;flex-direction:column;gap:12px;}
    .forecast-card{background:#232f47;border-radius:9px;padding:10px 8px 12px 14px;display:flex;align-items:center;gap:13px;box-shadow:0 1px 4px #0002;cursor:pointer;}
    .forecast-card .day{font-weight:700;width:54px;color:#fff;}
    .forecast-card .ficon{width:38px;height:38px;}
    .forecast-card .info{flex:1 1 0;font-size:1.05rem;color:#dde5f3;line-height:1.24;}
    .forecast-card .label-main{font-size:1.2rem;margin:0 0 2px 0;}
    #rain-btn{margin:14px 0 0 0;display:inline-block;background:#1976d2;color:#fff;font-weight:600;padding:9px 23px;border-radius:8px;cursor:pointer;font-size:1.09rem;box-shadow:0 1px 6px #0002;border:none;}
    .attribution{text-align:center;font-size:0.82rem;color:#668;}
    /* Hourly modal */
    #hourly-popup-bg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000;background:rgba(16,24,40,0.97);align-items:center;justify-content:center;}
    #hourly-popup-card{background:#232c42;border-radius:13px;max-width:95vw;width:410px;padding:0 0 19px 0;box-shadow:0 7px 33px #000b;position:relative;}
    #hourly-popup-close{position:absolute;right:20px;top:9px;color:#ffe180;background:none;border:none;font-size:2.1rem;cursor:pointer;}
    #hourly-popup-header{padding:17px 30px 7px 23px;font-size:1.2rem;font-weight:700;}
    #hourly-popup-advice{font-size:1.09rem;color:#ffd25a;background:#253e62;border-radius:7px;margin:11px 22px 8px 22px;padding:9px 13px;}
    #hourly-table{width:100%;border-collapse:collapse;font-size:1.03rem;margin:0 auto;}
    #hourly-table th,#hourly-table td{padding:5px 8px;text-align:center;}
    #hourly-table th{color:#ffe180;font-weight:600;border-bottom:1px solid #383e56;}
    #hourly-table tr:nth-child(even){background:#253e62;}
    /* Rain modal */
    #rain-popup-bg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:10001;background:rgba(16,24,40,0.97);align-items:center;justify-content:center;}
    #rain-popup-card{background:#232c42;border-radius:13px;max-width:95vw;width:410px;padding:0 0 17px 0;box-shadow:0 7px 33px #000b;position:relative;}
    #rain-popup-close{position:absolute;right:20px;top:9px;color:#85e7ff;background:none;border:none;font-size:2.1rem;cursor:pointer;}
    #rain-popup-header{padding:15px 30px 7px 23px;font-size:1.13rem;font-weight:700;color:#85e7ff;}
    .rain-bar-ct{display:flex;align-items:flex-end;justify-content:space-between;margin:15px 17px 8px 17px;height:99px;}
    .rain-bar{background:#80bfff;border-radius:7px;width:23px;position:relative;}
    .rain-bar-label{font-size:0.87rem;text-align:center;margin-top:3px;}
    .rain-bar-val{position:absolute;top:-1.3em;left:0;width:100%;text-align:center;font-size:0.9rem;color:#ffe180;}
    .rain-summary{font-size:1.01rem;color:#ffe180;margin:18px 0 0 19px;}
    .rain-desc{color:#c8daf7;font-size:0.97rem;margin:13px 0 0 21px;}
    /* Responsive tweaks */
    @media(max-width:600px){
      #main{padding:0 1px;}
      .block{padding:11px 3px 13px 7px;}
      .forecast-card .day{width:38px;}
      #hourly-popup-card,#rain-popup-card{max-width:99vw;}
    }
  </style>
</head>
<body>
<div id="main">
  <div class="block" id="current">
    <div id="loc">Loading locationâ€¦</div>
    <div class="row">
      <span class="temp" id="temp">--Â°C</span>
      <img id="icon" class="icon" src="" alt="" />
    </div>
    <div class="label-main" id="mainLabel"></div>
    <div class="details" id="details"></div>
    <div class="metrics" id="metrics"></div>
    <div class="advice" id="advice">Getting adviceâ€¦</div>
    <div class="alert-badges" id="alerts-badges"></div>
    <div id="hazards"></div>
  </div>
  <div class="block">
    <div id="forecast-title">Next 7 days</div>
    <div id="forecast"></div>
    <button id="rain-btn">View Rainfall History</button>
  </div>
  <div class="attribution">Powered by Vaisala Xweather â€“ NZ Pro â€¢ <span style="color:#80bfff">Agora</span></div>
</div>
<!-- Hourly Forecast Popup -->
<div id="hourly-popup-bg"><div id="hourly-popup-card">
  <button id="hourly-popup-close" onclick="closeHourlyPopup()">&times;</button>
  <div id="hourly-popup-header"></div>
  <div id="hourly-popup-advice"></div>
  <table id="hourly-table"></table>
</div></div>
<!-- Rainfall History Popup -->
<div id="rain-popup-bg"><div id="rain-popup-card">
  <button id="rain-popup-close" onclick="closeRainPopup()">&times;</button>
  <div id="rain-popup-header">Rainfall History</div>
  <div class="rain-bar-ct" id="rain-bars"></div>
  <div class="rain-summary" id="rain-summary"></div>
  <div class="rain-desc" id="rain-desc"></div>
</div></div>
<script>
// ---- Helper functions ----
const wxicon = i => i ? `https://cdn.aerisapi.com/wxblox/icons/${i}` : '';
const cap = s => (s||'').charAt(0).toUpperCase()+(s||'').slice(1);
const dayName = d => new Date(d).toLocaleDateString('en-NZ',{weekday:'short'});
const cityString = (loc) => {
  if(!loc)return'';
  if(loc.city) return loc.city;
  if(loc.county) return loc.county;
  if(loc.region) return loc.region;
  if(loc.country) return loc.country;
  return '';
};
let lastAdviceIdx = -1;
// ---- AI Advice Pool ----
function aiAdvice(ctx){
  const pool = [
    ctx.alerts?.length ? "âš ï¸ Weather alerts in effect â€“ tap above for details." : null,
    ctx.hazards?.includes('lightning') ? "âš¡ Lightning nearby â€“ stay indoors if possible." : null,
    ctx.hazards?.includes('cyclone') ? "ðŸŒ€ Cyclone risk near your area â€“ monitor updates." : null,
    ctx.road?.status === "RED" ? "ðŸš— Roads hazardous: Avoid travel if possible." : null,
    ctx.rain7 >= 30 ? "Flooding possible â€“ avoid low-lying areas." : null,
    ctx.rainToday > 20 ? "Heavy rain today â€“ watch for surface flooding." : null,
    ctx.current.feelslikeC!=null && ctx.current.tempC!=null && (ctx.current.feelslikeC-ctx.current.tempC<=-3) ? "Feels much colder than air temp â€“ dress for the windchill." : null,
    ctx.current.uvIndex>=7 ? "â˜€ï¸ High UV â€“ use sunscreen and wear a hat." : null,
    ctx.current.tempC>=28 ? "Extreme heat â€“ drink plenty of water." : null,
    ctx.current.tempC<=0 ? "Freezing â€“ black ice risk early mornings." : null,
    ctx.current.windGustKPH>=65 ? "ðŸŒ¬ï¸ Damaging wind gusts â€“ secure trampolines and bins." : null,
    ctx.forecast[0]?.precipMM>=10 && ctx.forecast[0]?.maxTempC<=12 ? "Cold, wet day â€“ best for indoor plans." : null,
    ctx.season=="summer" ? "Classic NZ summer: Hydrate, slip-slop-slap, and enjoy the sun!" : null,
    ctx.season=="spring" ? "Sudden chills possible â€“ keep a jacket handy." : null,
    ctx.season=="autumn" ? "Falling leaves can make roads slippery." : null,
    ctx.season=="winter" ? "Frost risk mornings. Take care on rural roads." : null,
    "Weather can change quickly in NZ â€“ check before heading out.",
  ].filter(Boolean);
  let idx = Math.floor(Date.now()/8.64e7)%pool.length;
  // Avoid repeat
  if(idx===lastAdviceIdx) idx=(idx+3)%pool.length;
  lastAdviceIdx=idx;
  return pool[idx]||"Stay weather aware!";
}
// ---- Data holders ----
let CITY="Loadingâ€¦",lat=null,lon=null,locObj={},forecast7=[],hourlyAll=[],alerts=[],hazards=[],rain7=0,rain30=0,rainYTD=0,rainDays=[],season="";
// ---- Fetch all ----
(async function(){
  // 1. Geo (browser, fallback, never prompt twice)
  let stored=localStorage.getItem("agora_latlon");
  if(stored){[lat,lon]=stored.split(',').map(Number);}
  if(!lat||!lon){
    try{
      await new Promise((resolve,reject)=>{
        navigator.geolocation.getCurrentPosition(pos=>{
          lat=pos.coords.latitude;lon=pos.coords.longitude;
          localStorage.setItem("agora_latlon",lat+","+lon);resolve();
        },reject,{timeout:7000});
      });
    }catch{lat=-37.8;lon=175.3;}
  }
  // 2. Conditions
  let cond=await fetch(`https://data.api.xweather.com/conditions/:auto?format=json&plimit=1&filter=minutelyprecip,5min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.windDir,periods.weather,periods.icon,periods.feelslikeC,periods.uvIndex,periods.pressureMB,periods.visibilityKM,periods.cloudsCoded,periods.sunriseISO,periods.sunsetISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq`).then(r=>r.json());
  let p=cond?.response?.[0]?.periods?.[0]||{};
  locObj=cond?.response?.[0]?.loc||{};
  CITY=cityString(locObj)||"Your Area";
  // 3. 7-day forecast
  let forecast=await fetch('https://data.api.xweather.com/forecasts/:auto?format=json&filter=day&limit=7&fields=periods.dateTimeISO,loc,periods.maxTempC,periods.minTempC,periods.pop,periods.precipMM,periods.maxHumidity,periods.minHumidity,periods.maxDewpointC,periods.minDewpointC,periods.maxFeelslikeC,periods.windSpeedMaxKPH,periods.windSpeedMinKPH,periods.windDirMax,periods.windDirMin,periods.weather,periods.icon&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq').then(r=>r.json());
  forecast7=forecast?.response?.[0]?.periods||[];
  // 4. Hourly (entire next 48h+)
  let hourly=await fetch('https://data.api.xweather.com/forecasts/:auto?format=json&filter=hour&limit=48&fields=periods.dateTimeISO,periods.tempC,periods.feelslikeC,periods.humidity,periods.windSpeedKPH,periods.windGustKPH,periods.precipMM,periods.weather,periods.icon,periods.uvIndex,periods.pressureMB,periods.visibilityKM,periods.cloudsCoded,periods.pop&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq').then(r=>r.json());
  hourlyAll=hourly?.response?.[0]?.periods||[];
  // 5. Alerts
  let alertR=await fetch('https://data.api.xweather.com/alerts/:auto?format=json&limit=5&fields=details.name,loc,details.color,details.body,details.bodyFull,timestamps.beginsISO,timestamps.expiresISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq').then(r=>r.json());
  alerts=alertR?.response||[];
  // 6. Lightning
  let lightningR=await fetch('https://data.api.xweather.com/lightning/:auto?format=json&filter=all&limit=5&fields=id,ob,loc,recISO&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq').then(r=>r.json());
  // 7. Cyclone
  let cycR=await fetch('https://data.api.xweather.com/tropicalcyclones/closest?p=:auto&radius=25mi&minradius=0mi&filter=all,&limit=2&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq').then(r=>r.json());
  // 8. Road
  let roadR=await fetch('https://data.api.xweather.com/roadweather/:auto?filter=&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq').then(r=>r.json());
  // 9. Rain
  let rain30R=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=30&daily=precipitation_sum&timezone=auto`).then(r=>r.json());
  let rain365R=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&past_days=365&daily=precipitation_sum&timezone=auto`).then(r=>r.json());
  rainDays=rain30R?.daily?.precipitation_sum?.slice(-7)||[];
  rain7=rainDays.reduce((a,b)=>a+b,0);
  rain30=rain30R?.daily?.precipitation_sum?.reduce((a,b)=>a+b,0)||0;
  rainYTD=rain365R?.daily?.precipitation_sum?.reduce((a,b)=>a+b,0)||0;
  // Hazards logic
  hazards=[];
  if(lightningR?.response?.length)hazards.push('lightning');
  if(cycR?.response?.length)hazards.push('cyclone');
  // Road
  let roadStatus=roadR?.response?.[0]?.periods?.[0]?.condition||"";
  // --- Determine NZ Season
  let m=(new Date).getMonth()+1;
  season=(m>=12||m<=2)?"summer":(m>=3&&m<=5)?"autumn":(m>=6&&m<=8)?"winter":"spring";
  // --- BUILD UI ---
  // 1. Current
  document.getElementById('loc').textContent=CITY;
  document.getElementById('temp').textContent=p.tempC!=null?Math.round(p.tempC)+"Â°C":"--";
  document.getElementById('icon').src=wxicon(p.icon)||'';
  document.getElementById('mainLabel').innerHTML=p.weather?`<span style="font-size:1.2em">${cap(p.weather)}</span>`:"";
  let dhtm=`<span class="label">Feels:</span> ${p.feelslikeC!=null?Math.round(p.feelslikeC)+"Â°C":"--"}`;
  dhtm+=`<span class="label">Humidity:</span> ${p.humidity!=null?p.humidity+"%":"--"}`;
  dhtm+=`<span class="label">Dew:</span> ${p.dewpointC!=null?Math.round(p.dewpointC)+"Â°C":"--"}`;
  dhtm+=`<span class="label">UV:</span> ${p.uvIndex!=null?p.uvIndex:"--"}`;
  dhtm+=`<span class="label">Cloud:</span> ${p.cloudsCoded?parseInt((p.cloudsCoded||"00").slice(2))*10+"%":"--"}`;
  dhtm+=`<span class="label">Sunrise:</span> ${p.sunriseISO?new Date(p.sunriseISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):"--"}`;
  dhtm+=`<span class="label">Sunset:</span> ${p.sunsetISO?new Date(p.sunsetISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'}):"--"}`;
  document.getElementById('details').innerHTML=dhtm;
  let mhtm=`<span>Wind: ${p.windDir||"--"} ${p.windSpeedKPH!=null?Math.round(p.windSpeedKPH)+" km/h":"--"}</span>
            <span>Gusts: ${p.windGustKPH!=null?Math.round(p.windGustKPH)+" km/h":"--"}</span>
            <span>Pressure: ${p.pressureMB!=null?Math.round(p.pressureMB)+" hPa":"--"}</span>
            <span>Visibility: ${p.visibilityKM!=null?Math.round(p.visibilityKM)+" km":"--"}</span>`;
  document.getElementById('metrics').innerHTML=mhtm;
  // 2. Advice (with all context)
  document.getElementById('advice').textContent=aiAdvice({
    current:p,season,forecast:forecast7,alerts,hazards,road:{status:roadStatus},rain7,rainToday:rainDays[6]||0
  });
  // 3. Alerts
  let badges=alerts.map(al=>`<span class="alert-badge" style="background:${al.details?.color||'#ffe180'}">${al.details?.name||"Alert"}</span>`);
  document.getElementById('alerts-badges').innerHTML=badges.join('');
  // 4. Hazards
  let hazarr=[];
  if(lightningR?.response?.length)hazarr.push("âš¡ Recent lightning nearby!");
  if(cycR?.response?.length)hazarr.push("ðŸŒ€ Cyclone activity within 25 mi");
  if(roadStatus)hazarr.push("ðŸš— Road: "+cap(roadStatus));
  document.getElementById('hazards').innerHTML=hazarr.join("&nbsp;â€¢&nbsp;");
  // 5. 7-day Forecast
  let fcDom=document.getElementById('forecast');fcDom.innerHTML="";
  forecast7.forEach((f,idx)=>{
    let card=document.createElement('div');card.className='forecast-card';
    card.onclick=()=>showHourlyPopup(idx);
    card.innerHTML=`<div class="day">${dayName(f.dateTimeISO)}</div>
      <img class="ficon" src="${wxicon(f.icon)}" alt=""/>
      <div class="info">
        <div class="label-main">${cap(f.weather)}</div>
        <div>${Math.round(f.maxTempC)}/${Math.round(f.minTempC)}Â°C</div>
        <div>Rain ${f.precipMM||0}mm â€¢ Hum ${f.maxHumidity||"--"}â€“${f.minHumidity||"--"}%</div>
        <div>Wind ${f.windDirMin||""}-${f.windDirMax||""} ${Math.round(f.windSpeedMinKPH||0)}â€“${Math.round(f.windSpeedMaxKPH||0)}km/h</div>
      </div>`;
    fcDom.appendChild(card);
  });
  // 6. Rain modal
  document.getElementById('rain-btn').onclick=()=>showRainPopup();
})();
// ---- Hourly modal ----
function showHourlyPopup(dayIdx){
  // Gather hours for that day
  let f7=window.forecast7, hAll=window.hourlyAll;
  if(!f7||!hAll){alert("Hourly not ready.");return;}
  let day=new Date(f7[dayIdx].dateTimeISO).getDate();
  let hours=hAll.filter(h=>new Date(h.dateTimeISO).getDate()===day);
  let html=`<tr>
    <th>Time</th><th>Cond.</th><th>Temp</th><th>Feels</th><th>Rain</th>
    <th>Wind</th><th>Gusts</th><th>Hum</th><th>UV</th>
  </tr>`;
  hours.forEach(h=>{
    html+=`<tr>
      <td>${new Date(h.dateTimeISO).toLocaleTimeString('en-NZ',{hour:'2-digit',minute:'2-digit'})}</td>
      <td><img src="${wxicon(h.icon)}" style="width:23px;height:23px;vertical-align:middle"> ${cap(h.weather||'')}</td>
      <td>${h.tempC!=null?Math.round(h.tempC)+'Â°C':'--'}</td>
      <td>${h.feelslikeC!=null?Math.round(h.feelslikeC)+'Â°C':'--'}</td>
      <td>${h.precipMM!=null?h.precipMM+'mm':'--'}</td>
      <td>${h.windSpeedKPH!=null?Math.round(h.windSpeedKPH)+'km/h':'--'}</td>
      <td>${h.windGustKPH!=null?Math.round(h.windGustKPH)+'km/h':'--'}</td>
      <td>${h.humidity!=null?h.humidity+'%':'--'}</td>
      <td>${h.uvIndex!=null?h.uvIndex:'--'}</td>
    </tr>`;
  });
  document.getElementById('hourly-popup-header').innerHTML=`${dayName(window.forecast7[dayIdx].dateTimeISO)} â€“ ${window.CITY}`;
  document.getElementById('hourly-popup-advice').textContent="Tip: Scroll for full day's detail.";
  document.getElementById('hourly-table').innerHTML=html;
  document.getElementById('hourly-popup-bg').style.display='flex';
}
function closeHourlyPopup(){document.getElementById('hourly-popup-bg').style.display='none';}
// ---- Rain modal ----
function showRainPopup(){
  // Rain bars last 7 days
  let barsHtml="",days=window.rainDays||[];
  let max=Math.max(...days,1);
  days.forEach((v,i)=>{
    barsHtml+=`<div><div class="rain-bar" style="height:${(v/max)*96}px"><div class="rain-bar-val">${Math.round(v)}mm</div></div>
    <div class="rain-bar-label">${["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][(new Date(Date.now()-((6-i)*864e5))).getDay()]}</div></div>`;
  });
  document.getElementById('rain-bars').innerHTML=barsHtml;
  document.getElementById('rain-summary').innerHTML=`Past week: <b>${Math.round(window.rain7)} mm</b> &nbsp; | &nbsp; Past 30 days: <b>${Math.round(window.rain30)} mm</b> &nbsp; | &nbsp; Year-to-date: <b>${Math.round(window.rainYTD)} mm</b>`;
  document.getElementById('rain-desc').innerHTML="NZ rainfall: YTD totals help monitor drought risk and farm planning.";
  document.getElementById('rain-popup-bg').style.display='flex';
}
function closeRainPopup(){document.getElementById('rain-popup-bg').style.display='none';}
</script>
</body>
</html>