<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agora NZ Weather – Smarter Kiwi Weather App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="NZ weather with live tides, swell, fishing, and accurate forecast for the Thames/Coromandel region.">
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      margin: 0; padding: 0;
      background: #f4f7fb;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #15304b;
      min-height: 100vh;
    }
    .app-container {
      max-width: 500px; margin: 0 auto;
      background: #fff; border-radius: 12px;
      box-shadow: 0 5px 30px #193a5e18;
      padding-bottom: 34px;
      min-height: 100vh; display: flex; flex-direction: column;
    }
    header {
      background: linear-gradient(90deg, #18558e 68%, #15b2c1 100%);
      color: #fff; padding: 34px 22px 18px 22px;
      border-radius: 0 0 30px 30px;
      box-shadow: 0 3px 16px #18558e10; text-align: left;
    }
    .main-title { font-size: 2.07rem; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 6px;}
    .sub-title { font-size: 1.09rem; opacity: 0.94; font-weight: 400; margin-bottom: 0;}
    .current-block {
      margin: 17px 18px 0 18px;
      padding: 17px 11px;
      border-radius: 12px;
      background: #eaf3fa;
      box-shadow: 0 2px 8px #cad8e850;
      display: flex; align-items: center; gap: 14px;
    }
    .current-icon { width: 68px; height: 68px; object-fit: contain; margin-right: 8px; }
    .current-temp {
      font-size: 3.3rem; font-weight: bold; color: #18558e; line-height: 1; margin-bottom: 5px;
    }
    .current-details { flex: 1; }
    .current-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 2px 16px;
      font-size: 1.01rem; margin-top: 2px;
    }
    .current-label { font-weight: 600; color: #19558e; }
    .forecast-row {
      margin: 18px 0 0 0; padding-left: 14px;
      display: flex; overflow-x: auto; gap: 9px; scrollbar-width: thin;
    }
    .forecast-card {
      flex: 0 0 140px; background: #f7faff;
      border-radius: 12px; box-shadow: 0 2px 7px #aac2e660;
      display: flex; flex-direction: column; align-items: center;
      padding: 11px 7px 13px 7px; cursor: pointer; transition: box-shadow 0.2s;
      border: 2px solid transparent; min-width: 110px; max-width: 160px;
    }
    .forecast-card.selected, .forecast-card:hover {
      border: 2.5px solid #18558e;
      box-shadow: 0 6px 16px #aac2e680; background: #e2f3ff;
    }
    .forecast-icon { width: 44px; height: 44px; margin-bottom: 6px; margin-top: 2px;}
    .forecast-day { font-weight: 600; font-size: 1.01rem; margin-bottom: 2px; }
    .forecast-summary { font-size: 0.97rem; margin-bottom: 4px; color: #2857a1; min-height: 18px; text-align: center;}
    .forecast-temps { font-size: 1.07rem; font-weight: 500; color: #285680; margin-bottom: 1px;}
    .forecast-rain { font-size: 0.91rem; color: #0a6899; margin-bottom: 0;}
    .forecast-advice { font-size:0.97em; color:#1a3e2d; min-height:28px; margin-top:2px;}
    .modal-bg { position: fixed; left:0; top:0; right:0; bottom:0; background: #23324c45; z-index: 50; display: flex; align-items: flex-end; justify-content: center;}
    .modal-popup { width: 100%; max-width: 470px; background: #fff; border-radius: 22px 22px 0 0; box-shadow: 0 10px 40px #23324c70; padding: 23px 18px 18px 18px; animation: modalIn 0.3s;}
    @keyframes modalIn { from { transform: translateY(100px); opacity: 0;} to { transform: translateY(0); opacity: 1;} }
    .modal-header { font-size: 1.30rem; font-weight: bold; margin-bottom: 7px; color: #18558e;}
    .modal-close-btn { position: absolute; top: 18px; right: 23px; background: none; border: none; font-size: 1.7rem; color: #6c7c8c; cursor: pointer; z-index: 100;}
    .modal-details { margin-top: 6px; font-size: 1.07rem; color: #23415c;}
    .rain-panel { margin: 18px 18px 0 18px; padding: 12px 12px 10px 12px; border-radius: 10px; background: #ecf8ff; color: #15304b; box-shadow: 0 2px 8px #c8e6ff40; font-size: 1.03rem; line-height: 1.35em;}
    .rain-label { font-weight: 600; color: #18558e; margin-bottom: 3px; font-size: 1.08rem;}
    .marine-panel { margin: 24px 18px 0 18px; padding: 13px 13px 17px 13px; border-radius: 12px; background: #eafaf7; box-shadow: 0 2px 7px #bceadd33; color: #18558e; font-size: 1.12rem; font-weight: 500; min-height: 90px;}
    .marine-headline { font-size: 1.18rem; font-weight: bold; margin-bottom: 7px;}
    .credit { text-align: center; color: #b4c2d3; font-size: 0.96em; margin: 31px auto 0 auto;}
    .station-select-row label { font-size: 1em; color: #133958;}
    @media (max-width: 600px) {
      .app-container { box-shadow: none; border-radius: 0;}
      .forecast-row { padding-left: 3px;}
      .modal-popup { border-radius: 21px 21px 0 0; padding: 11px 6px 17px 7px;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="main-title">Agora NZ Weather</div>
      <div class="sub-title">NZ weather with live marine, tides & fishing for Thames Coast</div>
      <div class="station-select-row" style="margin-top:12px;margin-bottom:-4px;">
        <label for="stationSelect">Station:</label>
        <select id="stationSelect" disabled>
          <option value="pws_paeroa" selected>Paeroa (Xweather)</option>
        </select>
      </div>
    </header>
    <div id="loader" class="loader" style="margin:50px auto 44px auto; border: 7px solid #d7e3f5; border-top: 7px solid #0f82c6; border-radius: 50%; width: 44px; height: 44px; animation: spin 1.05s linear infinite;"></div>
    <div id="mainContent" style="display:none;">
      <section><div class="current-block" id="currentBlock"></div></section>
      <section><div class="forecast-row" id="forecastRow"></div></section>
      <section><div class="rain-panel" id="rainPanel"></div></section>
      <section><div class="marine-panel" id="marinePanel">
        <div style="text-align:center;opacity:.8;margin-bottom:6px">Loading marine/tide chart…</div>
        <canvas id="tideChart" width="370" height="160"></canvas>
        <div id="marineDetails"></div>
      </div></section>
    </div>
    <div id="modalBg" class="modal-bg" style="display:none;"><div class="modal-popup" id="modalPopup"></div></div>
    <div class="credit">Powered by Xweather & Agora • 2025<br><span style="font-size:0.89em;opacity:0.8;">Proudly built for NZ</span></div>
  </div>
<script>
const currentUrl = "https://data.api.xweather.com/conditions/pws_paeroa?format=json&plimit=1&filter=1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windDir,periods.weather,periods.feelslikeC&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";
const forecastUrl = "https://developer.xweather.com/product/api/output?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJvcHRpb25zIjp7ImxvYyI6eyJ2YWx1ZSI6InB3c19wYWVyb2EiLCJhdXRvIjpmYWxzZX0sImZvcm1hdCI6Impzb24iLCJwYXJhbWV0ZXJzIjp7ImZpbHRlciI6ImRheW5pZ2h0IiwibGltaXQiOjcsImZpZWxkcyI6WyJwZXJpb2RzLmRhdGVUaW1lSVNPIiwibG9jIiwicGVyaW9kcy5wb3AiLCJwZXJpb2RzLnByZWNpcE1NIiwicGVyaW9kcy5taW5EZXdwb2ludEMiLCJwZXJpb2RzLndlYXRoZXIiXX19LCJlbmRwb2ludCI6ImZvcmVjYXN0cyIsImFjdGlvbiI6ImlkIiwiaWF0IjoxNzUzNTE2NTc3fQ.5mDAisIJqg46Pp3XVFxkW4nU-C0uJ8Km52tcqqRCJKk";
const marineUrl = "https://data.api.xweather.com/maritime/pws_coromandeltown1?filter=1hr&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq";
let chart = null;

function degToCardinal(deg) {
  const dirs = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
  return dirs[Math.round(((deg % 360) / 45)) % 8];
}
function getIconUrl(text) {
  text = (text || "").toLowerCase();
  if (text.includes('clear') || text.includes('sun')) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2600.png";
  if (text.includes('cloud')) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2601.png";
  if (text.includes('rain') || text.includes('shower')) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f327.png";
  if (text.includes('snow')) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2744.png";
  if (text.includes('thunder')) return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c8.png";
  return "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/26c5.png";
}

async function loadWeatherApp() {
  document.getElementById('loader').style.display = '';
  document.getElementById('mainContent').style.display = 'none';

  try {
    // --- Current
    const currentRes = await fetch(currentUrl);
    const currentJson = await currentRes.json();
    const curr = currentJson.response[0].periods[0];
    // --- Forecast
    const forecastRes = await fetch(forecastUrl);
    const forecastJson = await forecastRes.json();
    const fPeriods = forecastJson.response[0].periods;
    // --- Rain panel (just sum precip for last 7 days)
    let rain7 = 0, rainToday = 0;
    fPeriods.forEach((p,i)=>{ if(i<7) rain7 += p.precipMM||0; if(i===0) rainToday = p.precipMM||0; });

    renderCurrent(curr);
    renderForecasts(fPeriods);
    renderRainPanel(rainToday, rain7);

    // --- Marine/tides
    renderMarinePanel();

    document.getElementById('loader').style.display = 'none';
    document.getElementById('mainContent').style.display = '';
  } catch (e) {
    document.getElementById('loader').innerHTML = "Couldn’t load weather data. Try again soon.";
    console.error(e);
  }
}

function renderCurrent(curr) {
  let iconUrl = getIconUrl(curr.weather);
  let windStr = (curr.windSpeedKPH != null)
    ? `${curr.windSpeedKPH} km/h` + (curr.windDir ? " " + degToCardinal(curr.windDir) : "")
    : "—";
  let grid = [
    ["Humidity", (curr.humidity != null ? Math.round(curr.humidity) + "%" : "—")],
    ["Feels", (curr.feelslikeC != null ? curr.feelslikeC.toFixed(1) + "°C" : "—")],
    ["Dew Pt", (curr.dewpointC != null ? curr.dewpointC.toFixed(1) + "°C" : "—")],
    ["Wind", windStr],
    ["Wind Dir", (curr.windDir!=null ? degToCardinal(curr.windDir) : "—")],
    ["Observed", curr.dateTimeISO ? new Date(curr.dateTimeISO).toLocaleTimeString('en-NZ', {hour:'2-digit',minute:'2-digit'}) : "—"]
  ];
  let gridHtml = grid.map(([label, val]) =>
    `<div class="current-label">${label}:</div><div>${val}</div>`
  ).join("");
  document.getElementById('currentBlock').innerHTML = `
    <img class="current-icon" src="${iconUrl}" alt="icon"/>
    <div>
      <div class="current-temp">${curr.tempC != null ? curr.tempC.toFixed(1) + "°C" : "—"}</div>
      <div class="current-details">
        <div class="current-grid">${gridHtml}</div>
      </div>
    </div>
  `;
}

function formatDay(dateISO) {
  const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
  let d = new Date(dateISO);
  return days[d.getDay()] + " " + d.getDate();
}

function renderForecasts(periods) {
  const row = document.getElementById('forecastRow');
  row.innerHTML = '';
  periods.forEach((per, idx) => {
    const card = document.createElement('div');
    card.className = 'forecast-card';
    card.tabIndex = 0;
    card.setAttribute('aria-label', formatDay(per.dateTimeISO) + ' forecast');
    card.innerHTML = `
      <div class="forecast-day">${formatDay(per.dateTimeISO)}</div>
      <img class="forecast-icon" src="${getIconUrl(per.weather)}" alt="icon"/>
      <div class="forecast-summary">${per.weather}</div>
      <div class="forecast-temps">${(per.minDewpointC??'–')}&ndash;${(per.maxDewpointC??'–')}°C</div>
      <div class="forecast-rain">Rain: ${(per.precipMM??0).toFixed(1)} mm</div>
    `;
    card.onclick = () => showForecastDetails(per);
    row.appendChild(card);
  });
}

function showForecastDetails(per) {
  const modalBg = document.getElementById('modalBg');
  const popup = document.getElementById('modalPopup');
  popup.innerHTML = `
    <button class="modal-close-btn" onclick="closeModal()">&times;</button>
    <div class="modal-header">${formatDay(per.dateTimeISO)}</div>
    <div class="modal-details">
      <img class="forecast-icon" src="${getIconUrl(per.weather)}" alt="icon"/>
      <b>${per.weather}</b><br>
      Min/Max Dew Pt: ${(per.minDewpointC??'–')}&ndash;${(per.maxDewpointC??'–')}°C<br>
      Rain: ${(per.precipMM??0).toFixed(1)} mm<br>
      POP: ${(per.pop??'–')}%<br>
      <hr>
      <span style="font-size:1.04em;">(2-hour breakdown and AI advice coming soon...)</span>
    </div>
  `;
  modalBg.style.display = '';
  setTimeout(()=>popup.querySelector(".modal-close-btn").focus(), 200);
}
function closeModal() { document.getElementById('modalBg').style.display = 'none'; }
document.getElementById('modalBg').onclick = (e) => {
  if (e.target === document.getElementById('modalBg')) closeModal();
};

function renderRainPanel(today, rain7) {
  document.getElementById('rainPanel').innerHTML = `
    <span class="rain-label">Rainfall Totals</span><br>
    Today: <b>${today.toFixed(1)} mm</b><br>
    Last 7 days: <b>${rain7.toFixed(1)} mm</b>
    <br><span style="font-size:0.98em;opacity:0.66;">(from forecast totals)</span>
  `;
}

// ---- Marine panel & chart ----
async function renderMarinePanel() {
  try {
    const res = await fetch(marineUrl);
    const data = await res.json();
    if (!data.success || !data.response.length) {
      document.getElementById('marinePanel').innerHTML = "No marine/tide data found.";
      return;
    }
    const periods = data.response[0].periods;

    // Chart Data
    const labels = periods.map(p => (new Date(p.dateTimeISO)).toLocaleTimeString('en-NZ', {hour:'2-digit',minute:'2-digit'}));
    const tide = periods.map(p => p.tidesM ?? null);
    const wave = periods.map(p => p.significantWaveHeightM ?? null);
    const sst = periods.map(p => p.seaSurfaceTemperatureC ?? null);

    // Draw Chart.js
    if (window.chart) window.chart.destroy();
    window.chart = new Chart(document.getElementById('tideChart').getContext('2d'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: "Tide (m)", data: tide, borderColor: "#1874B0", backgroundColor: "#2196f326", fill: true, tension: 0.3, pointRadius: 2 },
          { label: "Wave Height (m)", data: wave, borderColor: "#41bc6b", backgroundColor: "#e4fae6", fill: false, tension: 0.3, pointRadius: 2 },
          { label: "Sea Temp (°C)", data: sst, borderColor: "#f69320", backgroundColor: "#ffe7c2", fill: false, tension: 0.2, yAxisID: 'y1', pointRadius: 2 }
        ]
      },
      options: {
        scales: {
          y: { beginAtZero: false, title: { display: true, text: 'Tide/Wave (m)' } },
          y1: { position: 'right', title: { display: true, text: 'Temp (°C)' }, grid: { drawOnChartArea: false } }
        },
        plugins: { legend: { position: 'top' }, tooltip: { enabled: true } },
        responsive: false,
        maintainAspectRatio: false
      }
    });

    // Marine Details Table
    let nextTide = tide.reduce((max, val, idx) => val > (tide[max] ?? -99) ? idx : max, 0);
    let marineHtml = `
      <div class="marine-headline">Marine/Tide Details</div>
      <div style="font-size:0.99em">
        Next high tide: <b>${labels[nextTide]}</b> at <b>${tide[nextTide].toFixed(2)}m</b><br>
        Current wave: <b>${wave[0] ? wave[0].toFixed(2) : '–'}m</b>,
        Sea temp: <b>${sst[0] ? sst[0].toFixed(1) : '–'}°C</b>
      </div>
      <div style="font-size:0.97em;opacity:.8;margin-top:7px">
        <b>Tip:</b> Check the tide chart above for best fishing and boating times!
      </div>
    `;
    document.getElementById('marineDetails').innerHTML = marineHtml;

  } catch (e) {
    document.getElementById('marinePanel').innerHTML = "Failed to load marine/tide data.";
    console.error(e);
  }
}

// Run on page load
window.onload = loadWeatherApp;
</script>
</body>
</html>