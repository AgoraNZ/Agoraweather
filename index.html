<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Agora Weather Widget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      background: #181e2a;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      box-sizing: border-box;
    }
    #main-container {
      width: 100vw;
      max-width: 600px;
      /* Removed min-width for responsiveness */
      /* Removed fixed height to allow content to expand */
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      background: #181e2a;
      box-shadow: 0 2px 24px #0008;
      border-radius: 18px;
      overflow: hidden;
    }
    #current-block {
      width: 100%;
      /* Removed min/max-width for responsiveness */
      background: #222c40;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      border-bottom: 2px solid #232f47;
      box-sizing: border-box;
      padding: 0 10px;
      cursor: pointer;
      position: relative;
    }
    .current-left {
      flex: 0 0 110px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px 0;
      gap: 6px;
    }
    .temp {
      font-size: 2.6rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 8px #222;
      margin: 0;
      line-height: 1.1;
    }
    .cur-icon {
      width: 56px;
      height: 56px;
      display: block;
      margin-bottom: 4px;
    }
    .current-right {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding-left: 10px;
      padding-top: 18px;
    }
    .weather-now {
      font-size: 1.14rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cur-details {
      font-size: 1rem;
      margin: 2px 0 6px 0;
      color: #e4e6f0;
      display: flex;
      flex-direction: row;
      gap: 16px;
    }
    .cur-detail-col {
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 90px;
      font-size: 1rem;
    }
    .ai-advice-box {
      background: #253e62;
      color: #ffd25a;
      border-radius: 7px;
      font-size: 1.05rem;
      margin: 8px 0 0 0;
      padding: 7px 14px;
      font-weight: 600;
      box-shadow: 0 1px 7px #0002;
      line-height: 1.25;
      letter-spacing: 0.01em;
      max-width: 97%;
      text-align: left;
      word-break: break-word;
      min-height: 25px;
      display: inline-block;
      white-space: normal;
    }
    #forecast-block {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      background: #181e2a;
      gap: 11px;
      padding: 11px 14px 10px 14px;
      /* Removed min-width and horizontal overflow for vertical layout */
      box-sizing: border-box;
    }
    .forecast-card {
      /* Removed flex shrink/grow and fixed widths for full-width card */
      width: 100%;
      background: #232f47;
      border-radius: 15px;
      padding: 13px 9px 10px 9px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      box-shadow: 0 1px 7px #0003;
      color: #fff;
      margin: 0;
      justify-content: flex-start;
      cursor: pointer;
      transition: box-shadow 0.13s;
      position: relative;
      overflow: hidden;
    }
    .forecast-card:hover {
      box-shadow: 0 8px 26px #0006;
      background: #27334f;
    }
    .forecast-card .day {
      font-weight: bold;
      font-size: 1.19rem;
      margin-bottom: 5px;
      color: #fff;
      letter-spacing: 0.01em;
      white-space: nowrap;
    }
    .forecast-card .icon {
      font-size: 2.2rem;
      margin-bottom: 5px;
      width: 44px;
      height: 44px;
      display: block;
      align-self: center;
    }
    .forecast-card .desc {
      font-size: 1.08rem;
      color: #c0d2ed;
      margin-bottom: 7px;
      min-height: 18px;
      line-height: 1.07;
      font-weight: 500;
      max-width: 92%;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }
    .forecast-card .lowhigh {
      font-size: 1.07rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 1px;
      margin-top: 0.08em;
      line-height: 1.19;
      display: block;
    }
    .forecast-card .wind,
    .forecast-card .precip {
      font-size: 0.96rem;
      color: #aad7ff;
      margin-bottom: 0.11em;
      font-weight: 400;
    }
    .forecast-card .precip { color: #85e7ff; }
    /* Removed .pasture since not used */
    .today-row {
      color: #ffedbc;
      text-align: left;
      margin-bottom: 5px;
      font-weight: 600;
    }
    #popup-bg {
      position: fixed;
      z-index: 99999;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(20, 30, 50, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #popup-content {
      background: #232f47;
      border-radius: 18px;
      padding: 26px 34px;
      color: #fff;
      font-size: 1.08rem;
      font-weight: 500;
      max-width: 480px;
      width: 96vw;
      box-shadow: 0 8px 30px #000c;
      line-height: 1.18;
      position: relative;
      text-align: center;
    }
    #popup-close {
      position: absolute;
      top: 5px;
      right: 14px;
      font-size: 2rem;
      color: #aad7ff;
      cursor: pointer;
      background: none;
      border: none;
    }
    #popup-title { font-size: 1.15em; font-weight: bold; margin-bottom: 6px; }
    #popup-summary, #popup-lowhigh, #popup-extra { margin-bottom: 5px; }
    #popup-ai { margin-top: 5px; font-size: 1.01rem; color: #fee680; }
    #popup-hist { margin-top: 7px; color: #aad7ff; font-size: 0.92rem; line-height: 1.08; }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="current-block" tabindex="0">
      <div class="current-left">
        <img id="cur-icon" class="cur-icon" src="" style="display:none;" alt="" />
        <div class="temp" id="temp">--°C</div>
      </div>
      <div class="current-right">
        <div class="weather-now" id="weather-text">Loading…</div>
        <div class="cur-details">
          <div class="cur-detail-col">
            <span id="row-feelslike">Feels like: --°C</span>
            <span id="row-humidity">Humidity: --%</span>
          </div>
          <div class="cur-detail-col">
            <span id="row-wind">Wind: -- km/h</span>
            <span id="row-gust">Gusts: -- km/h</span>
          </div>
        </div>
        <div class="today-row" id="today-row"></div>
        <div class="ai-advice-box" id="todays-advice">Loading today’s AI advice…</div>
      </div>
    </div>
    <div id="forecast-block"></div>
  </div>

  <div id="popup-bg">
    <div id="popup-content">
      <button id="popup-close" onclick="closePopup()">&times;</button>
      <div id="popup-title"></div>
      <div id="popup-summary"></div>
      <div id="popup-lowhigh"></div>
      <div id="popup-extra"></div>
      <div id="popup-ai"></div>
      <div id="popup-hist"></div>
    </div>
  </div>

  <script>
    // AI advice logic for NZ general audience (weather safety tips)
    const adviceWeather = [
      { cond: d => d.hail, msg: "⚠ Hail expected. Park your car in a garage or under cover if possible." },
      { cond: d => d.precip >= 20, msg: "Heavy rain expected. Avoid unnecessary travel and keep an umbrella handy." },
      { cond: d => d.precip >= 5, msg: "Showers likely – don't forget to carry a raincoat or umbrella." },
      { cond: d => d.gust >= 60, msg: "Strong winds forecast. Secure loose outdoor items and be cautious of falling branches." },
      { cond: d => d.temp >= 28, msg: "Very hot day. Stay hydrated and wear sunscreen if you're outdoors." },
      { cond: d => d.temp <= 0, msg: "Freezing temperatures expected. Beware of icy roads and dress warmly." },
      { cond: d => d.temp < 5, msg: "Very cold weather. Dress in warm layers if you go outside." },
      { cond: d => d.weather.toLowerCase().includes('thunder'), msg: "Thunderstorms possible. Stay indoors during the storm if you can." }
    ];
    const adviceSeasonal = [
      { cond: d => d.month === 12 || d.month === 1 || d.month === 2, msg: "Summer: UV levels are high. Wear a hat and sunscreen when outdoors." },
      { cond: d => d.month === 3 || d.month === 4 || d.month === 5, msg: "Autumn: Weather is cooling down. Keep a jacket handy for chilly evenings." },
      { cond: d => d.month === 6 || d.month === 7 || d.month === 8, msg: "Winter: Dress warmly and drive carefully on frosty mornings." },
      { cond: d => d.month === 9 || d.month === 10 || d.month === 11, msg: "Spring: Be prepared for changeable weather and sudden spring showers." }
    ];
    const adviceEveryday = [
      "Keep an umbrella or raincoat handy if rain is in the forecast.",
      "Check the day’s UV index if you plan to be outside for long.",
      "Dress in layers – New Zealand weather can change quickly.",
      "A quick morning weather check helps you plan your clothing and travel.",
      "Wear a hat and sunscreen on sunny days to protect from UV rays.",
      "Make sure your phone can receive emergency weather alerts.",
      "If driving in heavy rain, turn your headlights on and keep a safe distance.",
      "It’s wise to have a basic emergency kit at home for stormy weather.",
      "In strong winds, secure or bring inside loose outdoor items (e.g., outdoor furniture).",
      "During very cold nights, use extra blankets and check that your heating is working.",
      "On hot days, drink plenty of water even if you don’t feel thirsty.",
      "Check on elderly or vulnerable neighbors during extreme weather to ensure they’re safe."
    ];
    function agoraAiAdvice(opts) {
      const now = new Date(opts.dateISO || Date.now());
      const d = {
        temp: opts.temp,
        humidity: opts.humidity,
        precip: opts.precip,
        gust: opts.gust || 0,
        month: now.getMonth() + 1,
        weather: opts.weather ? opts.weather : "",
        hail: opts.hail || false
      };
      let advs = [];
      // Add weather-triggered advice
      for (let adv of adviceWeather) {
        if (adv.cond(d)) advs.push(adv.msg);
      }
      // Add seasonal advice for current month
      for (let adv of adviceSeasonal) {
        if (adv.cond(d)) advs.push(adv.msg);
      }
      // Always include one general tip (rotate daily)
      const hashDay = Math.abs(now.getDate() + (now.getMonth() + 1) * 37);
      const idx = hashDay % adviceEveryday.length;
      advs.push(adviceEveryday[idx]);
      // Remove duplicates and limit to 2 pieces
      advs = advs.filter((v, i, arr) => arr.indexOf(v) === i).slice(0, 2);
      return advs;
    }

    function iconUrl(icon) {
      return icon ? `https://cdn.aerisapi.com/wxblox/icons/${icon}` : '';
    }
    function dayOfWeek(dateISO) {
      return new Date(dateISO).toLocaleDateString('en-NZ', { weekday: 'short' });
    }
    function capitalize(txt) {
      return (txt || '').charAt(0).toUpperCase() + (txt || '').slice(1);
    }

    // --- Current conditions fetch ---
    fetch('https://data.api.xweather.com/conditions/:auto?format=json&plimit=1&filter=minutelyprecip,1min&fields=loc,periods.dateTimeISO,periods.tempC,periods.dewpointC,periods.humidity,periods.windSpeedKPH,periods.windDir,periods.weather,periods.feelslikeC&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No current conditions');
        const p = json.response[0].periods[0];
        const hailCurrent = ((p.weather || '')).toLowerCase().includes('hail');
        document.getElementById('temp').textContent = (typeof p.tempC === 'number') ? `${Math.round(p.tempC)}°C` : '--°C';
        const icon = p.icon || '';
        const icElem = document.getElementById('cur-icon');
        if (icon) {
          icElem.src = iconUrl(icon);
          icElem.style.display = '';
        } else {
          icElem.style.display = 'none';
        }
        document.getElementById('weather-text').textContent = capitalize(p.weather) || '--';
        document.getElementById('row-wind').textContent =
          (p.windSpeedKPH != null ? `Wind: ${p.windDir ? p.windDir + ' ' : ''}${Math.round(p.windSpeedKPH)} km/h` : 'Wind: -- km/h');
        document.getElementById('row-gust').textContent =
          (p.windGustKPH != null ? `Gusts: ${Math.round(p.windGustKPH)} km/h` : 'Gusts: -- km/h');
        document.getElementById('row-feelslike').textContent =
          (p.feelslikeC != null ? `Feels like: ${Math.round(p.feelslikeC)}°C` : 'Feels like: NA');
        document.getElementById('row-humidity').textContent =
          (p.humidity != null ? `Humidity: ${p.humidity}%` : 'Humidity: NA');
        // Fill today's forecast summary (High/Low and expected rain) if already loaded
        // (This will be set in the forecast fetch below as well)
        document.getElementById('todays-advice').textContent = agoraAiAdvice({
          temp: p.tempC,
          humidity: p.humidity,
          gust: p.windGustKPH,
          precip: p.precipMM,
          weather: p.weather,
          hail: hailCurrent,
          dateISO: p.dateTimeISO
        }).join(' ');
        // Show detailed current conditions in popup on click
        document.getElementById('current-block').onclick = () => openPopup({
          title: "Current Conditions",
          lowhigh: (function(){
            // Remove "Today:" label from summary for popup
            let t = document.getElementById('today-row').innerHTML;
            return t ? t.replace(/^<strong>Today:<\/strong>\s*/, '') : '';
          })(),
          extra:
            `${document.getElementById('row-wind').textContent}<br>` +
            `${document.getElementById('row-gust').textContent}`,
          ai: agoraAiAdvice({
            temp: p.tempC,
            humidity: p.humidity,
            gust: p.windGustKPH,
            precip: p.precipMM,
            weather: p.weather,
            hail: hailCurrent,
            dateISO: p.dateTimeISO
          }).join('<br>')
        });
      });

    // --- Forecast (7-day) fetch ---
    fetch('https://data.api.xweather.com/forecasts/:auto?format=json&plimit=8&fields=periods.timestamp,periods.dateTimeISO,periods.tempC,periods.weather,periods.icon,periods.maxTempC,periods.minTempC,periods.humidity,periods.precipMM,periods.windSpeedKPH,periods.windGustKPH,periods.dewpointC,periods.summary&client_id=U8feQfLlcEfcXDfsWZs4C&client_secret=HvIaM6HOkFmlJ8ywHPNSudj9txzpyuP7gJh2eDvq')
      .then(r => r.json())
      .then(json => {
        if (!json.success) throw new Error('No forecast');
        const fc = json.response[0].periods || [];
        // Fill today's forecast (index 0) into current block summary
        if (fc.length > 0) {
          const today = fc[0];
          document.getElementById('today-row').innerHTML =
            `<strong>Today:</strong> High ${today.maxTempC != null ? Math.round(today.maxTempC) + '°C' : '--°C'}, Low ${today.minTempC != null ? Math.round(today.minTempC) + '°C' : '--°C'}<br>` +
            `<strong>Expected rain:</strong> ${today.precipMM != null ? today.precipMM + ' mm' : '-- mm'}`;
        }
        // Render forecast cards for days 1–7 (tomorrow + next 6 days)
        const fcDom = document.getElementById('forecast-block');
        fcDom.innerHTML = "";
        for (let i = 1; i < fc.length && i <= 7; ++i) {
          const p = fc[i];
          const hail = ((p.weather || '') + ' ' + (p.summary || '')).toLowerCase().includes('hail');
          const advices = agoraAiAdvice({
            temp: p.tempC || p.maxTempC,
            humidity: p.humidity,
            gust: p.windGustKPH,
            precip: p.precipMM,
            weather: p.weather,
            hail: hail,
            dateISO: p.dateTimeISO
          });
          const adviceStr = advices.join('<br>');
          fcDom.innerHTML += `
            <div class="forecast-card" tabindex="0" onclick="openPopup({
                title: '${dayOfWeek(p.dateTimeISO)}',
                summary: '${capitalize(p.summary)}',
                lowhigh: 'High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C',
                extra: 'Wind: ${p.windDir ? p.windDir + &quot; &quot; : ""}${Math.round(p.windSpeedKPH || 0)} km/h<br>Gusts: ${Math.round(p.windGustKPH || 0)} km/h<br>Humidity: ${p.humidity != null ? p.humidity + "%" : &quot;NA&quot;}<br>Dew point: ${p.dewpointC != null ? Math.round(p.dewpointC) + '&deg;C' : &quot;NA&quot;}<br>Rain: ${p.precipMM != null ? p.precipMM + " mm" : &quot;0 mm&quot;}',
                ai: \`${adviceStr}\`
              })">
              <div class="day">${dayOfWeek(p.dateTimeISO)}</div>
              <img class="icon" src="${iconUrl(p.icon)}" alt="" width="44" height="44" />
              <div class="desc">${capitalize(p.weather || '')}</div>
              <div class="lowhigh">High: ${Math.round(p.maxTempC)}°C<br>Low: ${Math.round(p.minTempC)}°C</div>
              <div class="wind">Wind: ${p.windDir ? p.windDir + ' ' : ''}${Math.round(p.windSpeedKPH || 0)} km/h</div>
              <div class="precip">Rain: ${p.precipMM || 0} mm</div>
            </div>
          `;
        }
      });

    function openPopup(opts) {
      document.getElementById('popup-title').textContent = opts.title || "";
      document.getElementById('popup-summary').textContent = opts.summary || "";
      document.getElementById('popup-lowhigh').innerHTML = opts.lowhigh || "";
      document.getElementById('popup-extra').innerHTML = opts.extra || "";
      document.getElementById('popup-ai').innerHTML = opts.ai || "";
      document.getElementById('popup-hist').innerHTML = opts.hist || "";
      document.getElementById('popup-bg').style.display = 'flex';
    }
    function closePopup() {
      document.getElementById('popup-bg').style.display = 'none';
    }
    document.getElementById('popup-bg').onclick = (e) => {
      if (e.target === e.currentTarget) closePopup();
    };
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePopup();
    });
  </script>
</body>
</html>
