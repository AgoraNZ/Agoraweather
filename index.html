<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>AgoraWeather NZ – Powered by Open-Meteo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    html, body { background: #181e2a; color: #fff; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
    #main { max-width: 540px; margin: 0 auto; padding: 0 2px 32px 2px; }
    .card { background: #222c40; border-radius: 15px; padding: 13px 10px 17px 14px; margin: 15px 0 18px 0; box-shadow: 0 2px 12px #0007; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .temp { font-size: 2.6rem; font-weight: bold; letter-spacing: -0.03em; }
    .icon { width: 54px; height: 54px; }
    .location { font-size: 1.2rem; font-weight: 600; margin-bottom: 3px; letter-spacing: 0.01em; }
    .cond { font-size: 1.1rem; font-weight: 600; color: #ffe180; margin: 6px 0 1px 0;}
    .advice-list { margin-top: 9px; }
    .advice-tip { background: #253e62; color: #ffd25a; border-radius: 7px; font-size: 1.05rem; margin-bottom: 5px; padding: 7px 12px; font-weight: 500; box-shadow: 0 1px 8px #0002; line-height: 1.32; text-align: left;}
    .details-cols { display: flex; gap: 23px; margin: 9px 0 3px 0;}
    .details-col { display: flex; flex-direction: column; gap: 7px; font-size: 1.03rem; color: #c8daf7; }
    .details-label { color:#ffe180; font-weight:500; font-size:1.01em;}
    .metrics { font-size: 1.01rem; color: #a0bacd; margin: 2px 0 0 0; display: flex; flex-wrap: wrap; gap: 8px 14px; }
    .tab-row { display: flex; gap: 10px; margin: 6px 0 0 3px;}
    .tab { flex:1; background: #253e62; color: #ffe180; border-radius: 7px 7px 0 0; font-size: 1.07rem; padding: 7px 0; font-weight: 500; box-shadow: 0 1px 4px #0002; cursor:pointer; text-align:center;}
    .tab.active { background: #ffe180; color: #253e62; }
    #forecast, #rain-history {display:none;}
    #forecast.active, #rain-history.active {display:block;}
    #rainChart { width: 100%; min-height: 135px; max-width: 490px;}
    .rain-summary { font-size: 0.99rem; color: #ffe180; margin-top: 7px;}
    .forecast-title { font-size: 1.09rem; font-weight: 600; margin: 2px 0 6px 3px; color: #ffe180; }
    .hourly-row {display:flex;overflow-x:auto;gap:9px;margin-bottom:7px;}
    .hour-card {background:#232f47;border-radius:7px;padding:5px 7px;min-width:62px;text-align:center;font-size:0.98rem;}
    .hour-card .hicon{width:22px;height:22px;}
    .hour-card .htime{font-size:0.91em;}
    .hour-card .htemp{font-weight:600;}
    .forecast-card { background: #232f47; border-radius: 8px; padding: 8px 7px 9px 9px; display: flex; align-items: center; gap: 11px; font-size: 1rem; box-shadow: 0 1px 4px #0002; }
    .forecast-card .day { font-weight: 600; width: 47px; color: #fff; }
    .forecast-card .ficon { width: 33px; height: 33px; }
    .forecast-card .info { flex: 1 1 0; font-size: 0.99rem; color: #dde5f3; line-height: 1.22; }
    .info-bullet {font-size:0.94em;color:#ffe180;}
    @media (max-width:650px){
      #main {padding:0 1px;}
      .card {padding:10px 3px 13px 7px;}
      .forecast-card .day { width:34px;}
    }
  </style>
</head>
<body>
<div id="main">
  <div class="card" id="current">
    <div class="location" id="loc">Loading location…</div>
    <div class="row">
      <span class="temp" id="temp">--°C</span>
      <img id="icon" class="icon" src="" alt="" />
    </div>
    <div class="cond" id="condition">--</div>
    <div class="details-cols">
      <div class="details-col">
        <div><span class="details-label">Feels:</span> <span id="feels">--°C</span></div>
        <div><span class="details-label">Humidity:</span> <span id="hum">--%</span></div>
        <div><span class="details-label">Wind:</span> <span id="wind">--</span></div>
        <div><span class="details-label">Gusts:</span> <span id="gust">--</span></div>
      </div>
      <div class="details-col">
        <div><span class="details-label">Pressure:</span> <span id="pressure">--</span></div>
        <div><span class="details-label">Dew Pt:</span> <span id="dew">--°C</span></div>
        <div><span class="details-label">Visibility:</span> <span id="vis">--</span></div>
        <div><span class="details-label">Cloud:</span> <span id="cloud">--%</span></div>
        <div><span class="details-label">UV:</span> <span id="uv">--</span></div>
      </div>
    </div>
    <div class="metrics" id="sun"></div>
    <div class="advice-list" id="advice-list"></div>
  </div>

  <div class="tab-row">
    <div class="tab active" id="tab-forecast" onclick="showTab('forecast')">Forecast</div>
    <div class="tab" id="tab-rain" onclick="showTab('rain-history')">Rain History</div>
  </div>

  <div class="card" id="forecast" class="active">
    <div class="forecast-title">Hourly</div>
    <div class="hourly-row" id="hourly"></div>
    <div class="forecast-title">Next 7 Days</div>
    <div id="forecast-cards"></div>
  </div>
  <div class="card" id="rain-history">
    <div class="forecast-title">Rainfall History (mm)</div>
    <canvas id="rainChart"></canvas>
    <div class="rain-summary" id="rain-summary"></div>
    <div class="rain-summary" id="rain-extra"></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- ICONS: Open-Meteo maps to open-meteo.com/static/images/weather-icons ---
const weatherIcons = code => {
  const codes = {
    0:'clearsky_day.svg',1:'mainlyclear_day.svg',2:'partlycloudy_day.svg',3:'overcast.svg',45:'fog.svg',48:'depositing_rime_fog.svg',
    51:'drizzle.svg',53:'drizzle.svg',55:'drizzle.svg',56:'freezing_drizzle.svg',57:'freezing_drizzle.svg',
    61:'rain.svg',63:'rain.svg',65:'rain.svg',66:'freezing_rain.svg',67:'freezing_rain.svg',
    71:'snow.svg',73:'snow.svg',75:'snow.svg',77:'snow_grains.svg',
    80:'rainshowers_day.svg',81:'rainshowers_day.svg',82:'rainshowers_day.svg',
    85:'snowshowers_day.svg',86:'snowshowers_day.svg',
    95:'thunderstorm.svg',96:'thunderstorm_hail.svg',99:'thunderstorm_hail.svg'
  };
  return code in codes
    ? `https://open-meteo.com/images/weather-icons/${codes[code]}`
    : '';
};
const cap = s => (s||'').charAt(0).toUpperCase()+(s||'').slice(1);

function showTab(tab){
  document.getElementById('forecast').classList.remove('active');
  document.getElementById('rain-history').classList.remove('active');
  document.getElementById('tab-forecast').classList.remove('active');
  document.getElementById('tab-rain').classList.remove('active');
  document.getElementById(tab).classList.add('active');
  document.getElementById('tab-'+(tab=='forecast'?'forecast':'rain')).classList.add('active');
}

// ---- Smart NZ Advice ----
function aiAdvice(d) {
  let out = [];
  if(d.precip >= 30) out.push("⚠️ Torrential rain – check for flooding and avoid low-lying roads.");
  else if(d.precip >= 12) out.push("Heavy rain: take care if driving, and expect surface flooding.");
  if(d.gust >= 75) out.push("⚠️ Damaging wind gusts. Secure trampolines and outdoor furniture.");
  if(d.uv>=8) out.push("High UV – sunburn in 10 minutes. Slip, slop, slap and wrap.");
  if(d.temp >= 30) out.push("Extreme heat – keep hydrated and seek shade midday.");
  if(d.temp <= 0) out.push("Freezing temps – risk of black ice on roads. Allow extra travel time.");
  if(d.feelslike-d.temp>=3) out.push("Wind chill: Feels much colder than temp – dress for it.");
  if(Math.abs(d.pressChange)>=5) out.push("Barometer dropping fast – change in weather due.");
  if(d.vis<=1) out.push("Low visibility: drive with lights on & slow down.");
  if(/thunder/.test((d.weather||"").toLowerCase())) out.push("Thunderstorms likely – stay indoors if you hear thunder.");
  // Outdoor, fishing, sports etc
  if(d.precip < 1 && d.uv >= 6 && d.wind < 20) out.push("Great for sport, the beach, or picnics.");
  if(d.precip < 1 && d.wind < 10) out.push("Calm and clear – ideal for a spot of fishing.");
  if(d.gust>35 && d.gust<70) out.push("Windy: Good for sailing, kites, and wind sports – check conditions locally.");
  // Seasonal
  let m = d.month;
  if([12,1,2].includes(m)) out.push("Summer: UV and dehydration are main risks. Wear a hat and drink water.");
  if([6,7,8].includes(m)) out.push("Winter: Layer up, heating on, and be cautious of black ice.");
  if([9,10,11].includes(m)) out.push("Spring: Changeable weather – bring a jacket just in case.");
  if([3,4,5].includes(m)) out.push("Autumn: Crisp mornings and early sunsets – check outdoor lighting.");
  // Always a rotating NZ tip (rotated daily)
  const tips = [
    "NZ tip: Weather changes fast – check again before heading out.",
    "Winter: Defrost car windows with warm (not hot) water.",
    "Sunshine? Protect yourself – NZ sun burns fast.",
    "Heavy rain can trigger slips – watch for warning signs.",
    "Always check MetService for severe weather watches.",
    "Thunder = seek shelter, not just from rain but lightning.",
    "Gumboots are always in style when it pours!",
    "After storms, watch for fallen branches on rural roads.",
    "Keep spare batteries for torches in case of outages.",
    "Heatwave? Remember pets need shade and water too.",
    "Enjoy NZ's variable climate – be ready for four seasons in a day.",
    "Pack an extra layer if you're tramping or cycling.",
    "Check river crossings after heavy rain before driving through.",
    "Look for rainbows after passing showers – classic NZ view."
  ];
  const idx = (new Date()).getDate() % tips.length;
  out.push(tips[idx]);
  return [...new Set(out)].filter(Boolean).slice(0,3);
}

// ----------- GEO HELPERS (city name) -----------
async function reverseGeocode(lat,lon) {
  let city = "Your Area, NZ";
  try {
    let url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=en&count=1`;
    let j = await fetch(url).then(r=>r.json());
    if(j && j.results && j.results.length) {
      city = (j.results[0].name || "") + (j.results[0].admin1 ? ", " + j.results[0].admin1 : "");
    }
  } catch {}
  return city;
}

// --------- MAIN WEATHER LOGIC ----------
(async function(){
  // --- Location first (browser) ---
  let lat, lon;
  function useFallback() { lat = -37.7833; lon = 175.2833; loadAll(); }
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos => {
      lat = pos.coords.latitude; lon = pos.coords.longitude; loadAll();
    }, useFallback, {enableHighAccuracy:true, timeout:7000});
  } else useFallback();

  async function loadAll() {
    // 1. Get city name
    document.getElementById('loc').textContent = await reverseGeocode(lat,lon);

    // 2. Fetch all weather
    let url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,apparent_temperature,relative_humidity_2m,dew_point_2m,precipitation,cloudcover,pressure_msl,windspeed_10m,windgusts_10m,winddirection_10m,weathercode,uv_index,visibility&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,uv_index_max,weathercode,sunrise,sunset,windspeed_10m_max,windgusts_10m_max&timezone=auto`;
    let j = await fetch(url).then(r=>r.json());

    // 3. Current
    let c = j.current_weather, d = j.daily, h = j.hourly;
    let nowIdx = h.time.findIndex(t=>t.startsWith(c.time.substr(0,13)));
    let todayIdx = h.time.findIndex(t=>t.startsWith((new Date()).toISOString().substr(0,10)+'T12'));
    // Use today's date as anchor for AI, sun, etc
    let day = d ? 0 : null;

    // Main display
    document.getElementById('temp').textContent = Math.round(c.temperature)+'°C';
    document.getElementById('icon').src = weatherIcons(c.weathercode);
    document.getElementById('condition').textContent = cap(weatherDesc(c.weathercode));
    document.getElementById('feels').textContent = h.apparent_temperature[nowIdx]!=null?Math.round(h.apparent_temperature[nowIdx])+'°C':'--°C';
    document.getElementById('hum').textContent = h.relative_humidity_2m[nowIdx]!=null?Math.round(h.relative_humidity_2m[nowIdx])+'%':'--%';
    document.getElementById('wind').textContent = c.windspeed!=null?Math.round(c.windspeed)+' km/h':'--';
    document.getElementById('gust').textContent = h.windgusts_10m[nowIdx]!=null?Math.round(h.windgusts_10m[nowIdx])+' km/h':'--';
    document.getElementById('pressure').textContent = h.pressure_msl[nowIdx]!=null?Math.round(h.pressure_msl[nowIdx])+' hPa':'--';
    document.getElementById('dew').textContent = h.dew_point_2m[nowIdx]!=null?Math.round(h.dew_point_2m[nowIdx])+'°C':'--';
    document.getElementById('